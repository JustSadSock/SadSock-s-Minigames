<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SadSock’s playground</title>
  <!-- необязательно: пиксельный шрифт; оффлайн будет fallback -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Пастельная ретро-палитра (без неона) */
      --bg0:#fff6e5;     /* светлый фон вокруг автомата */
      --bg1:#ffd9a3;     /* яркий корпус */
      --bg2:#fff1cc;     /* светлый экран */
      --ink:#2d1600;     /* тёмный текст */
      --dim:#714f34;     /* приглушённый */
      --pastel-pink:#ff5f9c;
      --pastel-lav:#ff8cc6;
      --pastel-mint:#00d9b8;
      --pastel-blue:#46a0ff;
      --pastel-peach:#ffca3a;
      --accent:#ff595e;  /* коралл */
      --accent2:#00bbf9; /* ярко-голубой */
      --accent3:#ffca3a; /* тёплая подсветка */
      --bezel-hi:#fff2d4;
      --bezel:#ffe0b3;
      --bezel-lo:#ffce91;

      --tile-bg:#fff6d8;
      --tile-bg-dim:#d9c7a5;
      --tile-shadow:0 10px 22px rgba(0,0,0,.35);
      --tile-shadow-active:0 18px 36px rgba(0,0,0,.45);

      --scan:0.06;        /* сканлайны мягче */
      --crt-curve:24px;   /* скругление «стекла» */
      --tile:220px;       /* базовый размер иконок (CSS) — ещё крупнее */
      --px:1px;
      --gap: clamp(16px, 3.8vmin, 28px);
      --persp:1200px;     /* перспектива барабана */
      --radius:180px;     /* базовый радиус цилиндра */
      --dur:280ms;        /* длительность прокрутки быстрее */
      --ease:cubic-bezier(.2,.9,.1,1.15);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; color:var(--ink);
      background:
        radial-gradient(1600px 900px at 15% -10%, #fff1d6 0%, transparent 60%),
        radial-gradient(1400px 800px at 110% 10%, #ffe6f2 0%, transparent 60%),
        linear-gradient(#fff6e5,#ffe0f0 40%, #fff6e5 100%);
      font-family:'Press Start 2P', ui-monospace, Consolas, monospace;
      letter-spacing:.45px;
      overflow:hidden;
      touch-action:manipulation;
      -webkit-user-select:none;
      user-select:none;
    }

    /* мелкий пастельный «пиксельный» узор на фоне */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(var(--pastel-peach) 1px, transparent 1px) 0 0/6px 6px,
        radial-gradient(var(--pastel-pink) 1px, transparent 1px) 3px 3px/6px 6px;
      opacity:.25;
    }

    #bgCanvas{ position:fixed; inset:0; width:100%; height:100%; image-rendering:pixelated; z-index:0; }

    /* центрируем «кабинет», растягиваем почти на весь экран */
    .cabinet{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:min(2.5vw,18px);
      z-index:1;
    }

    /* внешний корпус — тоньше, чтобы экран был больше */
    .shell{
      width:min(1760px, 98vw);
      height:min(980px, 98svh);
      display:flex; flex-direction:column; align-items:center;
      border-radius:26px;
      background: linear-gradient(180deg, var(--bg1), #ffc777 55%, #ffb347);
      box-shadow:
        0 20px 46px rgba(0,0,0,.22),
        inset 0 0 0 2px #ffd59e,
        inset 0 0 0 8px #ffbd69,
        inset 0 0 120px rgba(255,205,110,.55);
      padding:12px;   /* было 26px -> экран вырос */
    }

    /* внутренний обод (bezel) — пастельные отблески */
    .bezel{
      width:100%; flex:1;
      border-radius:22px;
      background:
        linear-gradient(180deg, var(--bezel-hi), var(--bezel)),
        radial-gradient(150% 120% at 50% -20%, rgba(255,255,255,.25), transparent 55%),
        radial-gradient(140% 140% at 50% 120%, rgba(255,175,110,.35), transparent 50%);
      box-shadow:
        inset 0 0 0 2px #ffd59e,
        inset 0 0 0 8px #ffbd69,
        inset 0 6px 8px rgba(255,255,255,.65),
        inset 0 -6px 8px rgba(0,0,0,.25),
        inset 0 32px 120px rgba(255,200,110,.55),
        inset 0 -26px 70px rgba(255,180,80,.6),
        inset 0 0 120px rgba(255,227,198,.37); /* мягкий тёплый подсвет */
      padding:10px;  /* было 22px -> ещё больше экран */
      display:grid; place-items:center;
    }

    /* «дисплей» с внутренним светом и верхним бликом */
    .screen{
      position:relative;
      width:100%; height:100%;
      border-radius:var(--crt-curve);
      background:radial-gradient(120% 140% at 50% -20%, #3b2a12 0%, #1c1711 60%, #14110e 100%);
      box-shadow:
        0 20px 60px rgba(0,0,0,.45),
        inset 0 10px 22px rgba(255,220,160,.14),
        inset 0 -8px 18px rgba(0,0,0,.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .screen::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(to bottom, rgba(255,255,255,.06), transparent 22%);
      mix-blend-mode:overlay;
    }

    .topbar{ 
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:4px 12px;
      background:linear-gradient(180deg,#ffe9b6,#ffd6a6);
    }
    .topbar .title{ flex:1; text-align:center; font-size:12px; }
    .topright{ display:flex; align-items:center; gap:8px; }
    .avatar{ border:none; background:transparent; padding:0; cursor:pointer; border-radius:50%; overflow:hidden; width:48px; height:48px; }
    .avatar canvas{ width:48px; height:48px; image-rendering:pixelated; display:block; }
    .avatar{ position:relative; transition:transform .2s ease, filter .2s ease; }
    .avatar::after{
      content:""; position:absolute; inset:-2px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.8), transparent 60%);
      mix-blend-mode:overlay; opacity:0; transition:opacity .3s ease;
    }
    .avatar:hover{ transform:scale(1.06); filter:brightness(1.1); }
    .avatar:hover::after{ opacity:.9; }
    .avatar:active{ transform:scale(.94); }
    #nickDisplay{ font-size:10px; }
    #settingsBtn{ width:32px; height:32px; }
    #settingsBtn canvas{ width:32px; height:32px; }

    /* барабан со значками — цилиндр с маской и бликами */
    .reel{
      flex:1;
      position:relative;
      overflow:hidden;
      padding:calc(var(--gap) + 6px);
      perspective:var(--persp);
      perspective-origin:50% 50%;
      transform-style:preserve-3d;
      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, rgba(0,0,0,.85) 10%, rgba(0,0,0,1) 90%, transparent 100%);
              mask-image:linear-gradient(to bottom, transparent 0%, rgba(0,0,0,.85) 10%, rgba(0,0,0,1) 90%, transparent 100%);
    }
    .reel::before,
    .reel::after{
      content:""; position:absolute; top:0; bottom:0; width:40px; pointer-events:none;
      background:radial-gradient(closest-side, rgba(255,255,255,.15), transparent);
    }
    .reel::before{ left:0; }
    .reel::after{ right:0; }

    .pbtn{
      font-size:12px; letter-spacing:1px; color:var(--ink);
      padding:12px 26px; cursor:pointer; user-select:none;
      border:4px solid var(--ink); border-radius:10px;
      background:linear-gradient(180deg,#ffe2f0,#ffd0e0);
      box-shadow:0 4px 0 var(--ink), inset 0 2px 0 rgba(255,255,255,.6), inset 0 -3px 0 rgba(0,0,0,.25);
      position:relative;
      transition:transform .1s steps(2), filter .2s ease;
    }
    .pbtn::before{
      content:""; position:absolute; inset:0; border-radius:6px;
      background:linear-gradient(180deg,rgba(255,255,255,.65),rgba(255,255,255,0));
      pointer-events:none;
    }
    .pbtn:hover{ filter:brightness(1.1); }
    .pbtn:active{ transform:translateY(4px); box-shadow:0 0 0 var(--ink), inset 0 1px 0 rgba(0,0,0,.35); }

    .menu{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:var(--bg2);
      border:4px solid var(--ink);
      border-radius:8px; padding:20px; font-size:12px;
      display:none; z-index:10; width:320px; max-width:95vw;
    }
    .menu.show{ display:block; }
    .menu .row{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .menu .row.ar{ display:grid; grid-template-columns:80px 24px 1fr 24px; align-items:center; }
    .menu .value{ text-align:center; }
    .menu .row.wide input[type=range]{ flex:1; }
    .menu .swatch{ width:20px; height:20px; border:2px solid var(--ink); border-radius:4px; }
    .menu .arrow{ width:24px; height:24px; border:2px solid var(--ink); background:var(--bg1); cursor:pointer; font-size:12px; line-height:18px; }

    /* CRT-слои */
    .scanlines, .vignette, .glass, .phosphor{
      pointer-events:none; position:absolute; inset:0; border-radius:var(--crt-curve);
    }
    .scanlines{
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,var(--scan)) 0px,
        rgba(0,0,0,var(--scan)) 2px,
        transparent 3px,
        transparent 4px
      );
      mix-blend-mode:multiply;
      animation:scanMove 6s linear infinite;
    }
    @media (max-width:560px){
      .scanlines{
        opacity:.25;
        background-image:repeating-linear-gradient(to bottom, rgba(255,255,255,.10), rgba(255,255,255,.10) 1px, transparent 1px, transparent 3px);
        mix-blend-mode:overlay;
      }
    }
    .vignette{
      background: radial-gradient(120% 100% at 50% 50%, transparent 62%, rgba(0,0,0,.55) 100%);
    }
    .glass{
      background:
        linear-gradient(110deg, rgba(255,255,255,.055) 0 22%, transparent 22% 80%, rgba(255,255,255,.03) 80% 100%),
        radial-gradient(120% 140% at 0% 0%, rgba(255,209,220,.06), transparent 45%),
        radial-gradient(120% 140% at 100% 0%, rgba(205,230,255,.05), transparent 40%);
      filter: blur(.3px); overflow:hidden; position:relative;
    }
    .glass::after{
      content:""; position:absolute; top:0; left:-60%; width:50%; height:100%;
      background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,0));
      transform:skewX(-20deg); animation:glare 8s linear infinite;
    }
    .phosphor{
      background:
        radial-gradient(100% 72% at 50% 44%, rgba(255,236,198,.045), transparent 52%),
        radial-gradient(80% 60% at 50% 48%, rgba(201,244,228,.035), transparent 55%);
      mix-blend-mode:screen;
    }
    .static{
      background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFklEQVQI12P4//8/Az7w+PHjY2BgAACh1A9TJS3BMgAAAABJRU5ErkJggg==');
      image-rendering:pixelated;
      opacity:.08;
      mix-blend-mode:overlay;
      animation:staticShift .2s steps(2) infinite;
      pointer-events:none;
    }

    @keyframes scanMove{ from{background-position:0 0;} to{background-position:0 4px;} }
    @keyframes tileFlash{ 0%{opacity:1;} 100%{opacity:0;} }
    @keyframes staticShift{ from{background-position:0 0;} to{background-position:4px 4px;} }
    .tile.flash::after{ opacity:.8; animation:tileFlash .3s steps(1) forwards; }

    /* плитки-значки (пастельные рамки и мягкие тени) */
    .tile{
      --size: clamp(80px, 12vmin, var(--tile));
      --slotY:0px;      /* вертикальная позиция барабана */
      --slotX:0px;      /* горизонтальная позиция */
      --slotZ:0px;      /* глубина для объёма */
      --slotRot:0rad;   /* угол поворота по дуге */
      --slotScale:1;    /* масштаб при удалении */
      --slotBright:1;   /* яркость для эффекта глубины */
      --slotBlur:0px;   /* размытие для уходящих */
      width: var(--size);
      height: var(--size);
      border-radius:18px;
      background: var(--tile-bg);
      border:2px solid #ffbd69;
      box-shadow:
        inset 0 0 0 2px #ffe0b3,
        var(--tile-shadow),
        0 4px 0 #c99742,
        0 8px 0 #a87332; /* дополнительный объём */
      display:grid; place-items:center;
      cursor:pointer; outline:none;
      position:absolute; top:50%; left:50%;
      transform:translate(calc(-50% + var(--slotX)), calc(-50% + var(--slotY))) translateZ(var(--slotZ)) rotateX(var(--slotRot)) scale(var(--slotScale));
      transform-style:preserve-3d;
      filter:blur(var(--slotBlur)) brightness(var(--slotBright));
      will-change:transform,opacity,filter;
      transition:transform var(--dur) var(--ease), filter .22s linear, opacity .22s linear;
    }
    .tile::before{
      content:""; position:absolute; inset:0; border-radius:inherit;
      box-shadow: inset 0 6px 0 rgba(255,255,255,.55), inset 0 -6px 0 rgba(0,0,0,.3);
      pointer-events:none;
    }
    .tile::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background:linear-gradient(135deg, rgba(255,255,255,.75) 0%, rgba(255,255,255,0) 60%);
      mix-blend-mode:overlay; opacity:0; transition:opacity .2s ease;
    }
    .tile:hover::after{ opacity:.55; }
    .tile:active{ transform:translate(calc(-50% + var(--slotX)), calc(-50% + var(--slotY) + 1px)) scale(calc(var(--slotScale)*.996)); }
    .tile[data-active="1"]{
      box-shadow:
        inset 0 0 0 2px #ffbd69,
        var(--tile-shadow-active),
        0 0 0 3px rgba(255,154,0,.42),
        0 0 28px rgba(255,200,90,.38);
      border-color:#ffae55;
    }
    .tile[data-active="0"]{
      background:var(--tile-bg-dim);
      filter:blur(.5px) brightness(.9) contrast(.95);
    }
    .tile canvas{
      width: calc(var(--size));
      height: calc(var(--size));
      image-rendering: pixelated;
      background:#ffe9b6;
      border-radius:12px;
      border:2px solid #ffbd69;
      box-shadow: inset 0 0 0 2px #ffd59e, 0 0 0 1px rgba(0,0,0,.12);
    }

    .tile .label{
      position:absolute; left:10px; right:10px; bottom:8px;
      height:28px; display:flex; align-items:center; justify-content:center;
      font-weight:600; font-size:14px; letter-spacing:.2px;
      color:#3b2a12;
      background:rgba(255,255,255,.72);
      backdrop-filter:blur(2px);
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      pointer-events:none;
    }

    .indicator{
      position:absolute; right:10px; top:50%; translate:0 -50%;
      display:grid; gap:6px; pointer-events:none;
    }
    .indicator i{
      width:6px; height:6px; border-radius:50%;
      background:#494949; box-shadow:0 0 8px rgba(0,0,0,.5) inset; opacity:.5;
    }
    .indicator i.active{
      background:#ffb74d; opacity:1; box-shadow:0 0 6px #ffb74d; animation:ledBreathe 1.8s ease-in-out infinite;
    }
    @keyframes ledBreathe{0%,100%{box-shadow:0 0 6px #ffb74d;}50%{box-shadow:0 0 12px #ffb74d;}}

    /* адаптивные отступы для барабана */
    @media (max-width: 560px){
      :root{ --gap:18px; }
      .shell{ padding:10px; }
      .bezel{ padding:8px; }
      .reel{ padding:18px; }
      .tile{ border-radius:14px; }
    }

    @media (max-height:480px){
      .reel{ padding:12px; }
    }

    /* небольшие pixel-анимации */
    @keyframes tileBounce{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(-2px); }
    }
    /* анимации при наведении отключены, чтобы не мешать барабану */
    @keyframes focusPulse{0%,100%{filter:brightness(1);}50%{filter:brightness(1.2);}}
    .tile[data-active="1"]{ animation:focusPulse .8s steps(2) infinite; }
    @keyframes glare{ from{left:-60%;} to{left:120%;} }
    @keyframes screenGlow{0%,100%{opacity:.85;}50%{opacity:.65;}}

    .game-overlay{
      position:absolute;
      inset:0;
      background:#000;
      display:none;
      z-index:10;
      transform-origin:0 0;
      transition:transform var(--dur) var(--ease);
    }
    .game-overlay iframe{
      width:100%; height:100%; border:0;
    }
    .game-overlay .close{
      position:absolute;
      top:10px;
      right:10px;
    }

    @media (prefers-reduced-motion: reduce){
      :root{ --dur:0ms; }
      .tile{ transition:none !important; filter:brightness(1); }
    }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="cabinet" role="application" aria-label="Ретро-аркадный автомат (пастель)">
    <div class="shell">
      <div class="bezel">
        <div class="screen">
      <header class="topbar">
            <button class="avatar" id="avatarBtn" aria-label="Профиль">
              <canvas id="avatarCanvas" width="48" height="48"></canvas>
            </button>
            <h2 class="title">SadSock’s playground</h2>
            <div class="topright">
              <span id="nickDisplay">Player</span>
              <button class="avatar" id="settingsBtn" aria-label="Настройки">
                <canvas id="settingsCanvas" width="32" height="32"></canvas>
              </button>
            </div>
          </header>
          <div class="reel" role="listbox" aria-label="Меню">
            <button class="tile" role="option" data-idx="0" data-color="#ff9eb8" data-game="music-box.html" aria-label="Music Box">
              <canvas width="120" height="120"></canvas>
              <span class="label">Music Box</span>
            </button>
            <button class="tile" role="option" data-idx="1" data-color="#00d9b8" data-game="pixel-snake.html" aria-label="Pixel Snake">
              <canvas width="120" height="120"></canvas>
              <span class="label">Pixel Snake</span>
            </button>
            <button class="tile" role="option" data-idx="2" data-color="#46a0ff" data-game="memory-flip.html" aria-label="Memory Flip">
              <canvas width="120" height="120"></canvas>
              <span class="label">Memory Flip</span>
            </button>
            <button class="tile" role="option" data-idx="3" data-color="#ffca3a" data-game="dodge-rain.html" aria-label="Dodge Rain">
              <canvas width="120" height="120"></canvas>
              <span class="label">Dodge Rain</span>
            </button>
            <button class="tile" role="option" data-idx="4" data-color="#ff5f9c" data-game="retro-breakout.html" aria-label="Retro Breakout">
              <canvas width="120" height="120"></canvas>
              <span class="label">Retro Breakout</span>
            </button>
            <button class="tile" role="option" data-idx="5" data-color="#ffca3a" data-game="pixel-animator.html" aria-label="Pixel Animator">
              <canvas width="120" height="120"></canvas>
              <span class="label">Pixel Animator</span>
            </button>
            <div class="indicator" aria-hidden="true"></div>
          </div>
          <div id="avatarMenu" class="menu">
            <div class="row"><span>Ник:</span><input id="nick" type="text" value="Player"></div>
            <div class="row ar">
              <span>Кожа:</span>
              <button class="arrow" data-part="skin" data-dir="-1">◀</button>
              <div id="skinSwatch" class="swatch value"></div>
              <button class="arrow" data-part="skin" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Волосы:</span>
              <button class="arrow" data-part="hair" data-dir="-1">◀</button>
              <div id="hairSwatch" class="swatch value"></div>
              <button class="arrow" data-part="hair" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Стиль:</span>
              <button class="arrow" data-part="style" data-dir="-1">◀</button>
              <span id="styleName" class="value">Короткая</span>
              <button class="arrow" data-part="style" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Глаза:</span>
              <button class="arrow" data-part="eyes" data-dir="-1">◀</button>
              <div id="eyeSwatch" class="swatch value"></div>
              <button class="arrow" data-part="eyes" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Рубашка:</span>
              <button class="arrow" data-part="shirt" data-dir="-1">◀</button>
              <div id="shirtSwatch" class="swatch value"></div>
              <button class="arrow" data-part="shirt" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Головной убор:</span>
              <button class="arrow" data-part="hat" data-dir="-1">◀</button>
              <span id="hatName" class="value">Нет</span>
              <button class="arrow" data-part="hat" data-dir="1">▶</button>
            </div>
            <div class="row ar">
              <span>Цвет убора:</span>
              <button class="arrow" data-part="hatColor" data-dir="-1">◀</button>
              <div id="hatSwatch" class="swatch value"></div>
              <button class="arrow" data-part="hatColor" data-dir="1">▶</button>
            </div>
            <div style="text-align:center"><button id="avatarOk" class="pbtn">OK</button></div>
          </div>
          <div id="settingsMenu" class="menu">
            <div class="row wide">
              <span>Громкость:</span>
              <input id="volume" type="range" min="0" max="1" step="0.05" value="0.3" />
            </div>
            <div class="row wide">
              <span>Экран:</span>
              <button id="fullscreenBtn" class="pbtn">Полноэкранно</button>
            </div>
          <div style="text-align:center"><button id="settingsOk" class="pbtn">OK</button></div>
          </div>
          <div id="gameOverlay" class="game-overlay"></div>
          <div class="scanlines" aria-hidden="true"></div>
          <div class="static" aria-hidden="true"></div>
          <div class="vignette" aria-hidden="true"></div>
          <div class="glass" aria-hidden="true"></div>
          <div class="phosphor" aria-hidden="true"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="audio.js"></script>
  <script src="icons.js"></script>
  <script>
    (function(){
      'use strict';
      const $ = (s,p=document)=>p.querySelector(s);
      const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
      const nickDisplay = $('#nickDisplay');
      const avatarCanvas = $('#avatarCanvas');
      const avatarBtn = $('#avatarBtn');
      const avatarMenu = $('#avatarMenu');
      const settingsBtn = $('#settingsBtn');
      const settingsMenu = $('#settingsMenu');
      const volumeSlider = $('#volume');
      const fullscreenBtn = $('#fullscreenBtn');
      const settingsOk = $('#settingsOk');
      const nickInput = $('#nick');
      const skinSwatch = $('#skinSwatch');
      const hairSwatch = $('#hairSwatch');
      const eyeSwatch = $('#eyeSwatch');
      const shirtSwatch = $('#shirtSwatch');
      const hatSwatch = $('#hatSwatch');
      const styleName = $('#styleName');
      const hatName = $('#hatName');
      const arrows = $$('.arrow');
      const avatarOk = $('#avatarOk');
      const reel = $('.reel');
      const tiles = $$('.reel .tile');
      const indicator = $('.indicator');
      const gameOverlay = $('#gameOverlay');
      const screenEl = $('.screen');
      const DUR = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dur'));

      // блокируем двойные касания и прокрутку страницы
      addEventListener('dblclick', e=> e.preventDefault(), {passive:false});
      let lastTouch=0;
      addEventListener('touchend', e=>{
        const now=Date.now();
        if(now-lastTouch<400){ e.preventDefault(); }
        lastTouch=now;
      }, {passive:false});
      addEventListener('touchmove', e=> e.preventDefault(), {passive:false});
      addEventListener('scroll', ()=> window.scrollTo(0,0));

      /* ---------- Пиксель-рисовалки (пастель) ---------- */
      function px(ctx,x,y,s=2,c='#fff'){ ctx.fillStyle=c; ctx.fillRect(x*s,y*s,s,s); }
      function clear(ctx){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); }
      const gearCtx = $('#settingsCanvas').getContext('2d',{alpha:false});
      gearCtx.imageSmoothingEnabled=false;
      (function drawGear(){
        const S=2; clear(gearCtx); gearCtx.fillStyle='#2d1600';
        const g=[[3,0],[4,0],[5,0],[6,0],[7,1],[8,2],[9,3],[9,4],[9,5],[8,6],[7,7],[6,8],[5,8],[4,9],[3,9],[2,8],[1,7],[0,6],[0,5],[0,4],[0,3],[1,2],[2,1]];
        g.forEach(([x,y])=>px(gearCtx,x,y,S,'#2d1600'));
        ['#ffca3a'].forEach(c=>{
          px(gearCtx,4,4,S,c); px(gearCtx,5,4,S,c); px(gearCtx,4,5,S,c); px(gearCtx,5,5,S,c);
        });
      })();

      // Значки отрисовываются из набора кадров в icons.js
      const drawers=['music','snake','cards','rain','breakout','anim'];

      /* ---------- Аватар ---------- */
      const avatar={ nick:'Player', hair:'#7b3f00', skin:'#ffcf9c', style:'short', eyes:'#000', shirt:'#ff9eb8', hat:'none', hatColor:'#ff595e'};
      const skinColors=['#ffcf9c','#f1c27d','#e0ac69','#c68642'];
      const hairColors=['#7b3f00','#ff595e','#2e2e2e','#ffa726','#c0c0c0'];
      const hairStyles=['short','mohawk','long'];
      const hairNames={short:'Короткая',mohawk:'Ирокез',long:'Длинная'};
      const eyeColors=['#000','#1a1a1a','#004bff','#00d9b8','#ff595e'];
      const shirtColors=['#ff9eb8','#ffca3a','#46a0ff','#00d9b8','#ffffff','#ffd6a6'];
      const hatStyles=['none','cap','crown','bandana'];
      const hatNames={none:'Нет',cap:'Кепка',crown:'Корона',bandana:'Бандана'};
      const hatColors=['#ff595e','#ffca3a','#46a0ff','#00d9b8','#714f34','#ffffff'];
      let skinIdx=0, hairIdx=0, styleIdx=0, eyeIdx=0, shirtIdx=0, hatIdx=0, hatColorIdx=0;
      const savedAvatar = JSON.parse(localStorage.getItem('avatar')||'null');
      if(savedAvatar){
        Object.assign(avatar, savedAvatar);
        skinIdx = Math.max(0, skinColors.indexOf(avatar.skin));
        hairIdx = Math.max(0, hairColors.indexOf(avatar.hair));
        styleIdx = Math.max(0, hairStyles.indexOf(avatar.style));
        eyeIdx = Math.max(0, eyeColors.indexOf(avatar.eyes));
        shirtIdx = Math.max(0, shirtColors.indexOf(avatar.shirt));
        hatIdx = Math.max(0, hatStyles.indexOf(avatar.hat));
        hatColorIdx = Math.max(0, hatColors.indexOf(avatar.hatColor));
      }
      const avCtx = avatarCanvas.getContext('2d',{alpha:false});
      avCtx.imageSmoothingEnabled=false;
      function drawAvatar(){
        clear(avCtx);
        const S=2;
        for(let y=7;y<23;y++){
          for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.skin);
        }
        for(let y=23;y<31;y++){
          for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.shirt);
        }
        if(avatar.style==='short'){
          for(let y=5;y<11;y++){
            for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.hair);
          }
        } else if(avatar.style==='mohawk'){
          for(let y=3;y<15;y++){
            for(let x=15;x<17;x++) px(avCtx,x,y,S,avatar.hair);
          }
        } else if(avatar.style==='long'){
          for(let y=3;y<17;y++){
            for(let x=6;x<26;x++) px(avCtx,x,y,S,avatar.hair);
          }
        }
        px(avCtx,12,15,S,avatar.eyes);
        px(avCtx,20,15,S,avatar.eyes);
        for(let x=12;x<=20;x++) px(avCtx,x,21,S,'#000');
        if(avatar.hat==='cap'){
          for(let y=1;y<5;y++){
            for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.hatColor);
          }
          for(let x=8;x<24;x++) px(avCtx,x,5,S,avatar.hatColor);
        }else if(avatar.hat==='crown'){
          for(let x=10;x<22;x++) px(avCtx,x,1,S,'#ffd700');
          for(let i=0;i<3;i++){
            px(avCtx,11+i*4,0,S,'#ffd700');
            px(avCtx,12+i*4,-1,S,'#ffd700');
            px(avCtx,13+i*4,0,S,'#ffd700');
          }
        }else if(avatar.hat==='bandana'){
          for(let y=3;y<7;y++){
            for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.hatColor);
          }
          for(let x=20;x<26;x++) px(avCtx,x,5,S,avatar.hatColor);
        }
      }
      function updateAvatarControls(){
        skinSwatch.style.background = avatar.skin;
        hairSwatch.style.background = avatar.hair;
        eyeSwatch.style.background = avatar.eyes;
        shirtSwatch.style.background = avatar.shirt;
        hatSwatch.style.background = avatar.hatColor;
        styleName.textContent = hairNames[avatar.style];
        hatName.textContent = hatNames[avatar.hat];
      }
      function saveAvatar(){
        localStorage.setItem('avatar', JSON.stringify(avatar));
      }
      drawAvatar();
      updateAvatarControls();
      nickInput.value = avatar.nick;
      nickDisplay.textContent = avatar.nick;
      avatarBtn.addEventListener('click',()=>{
        const show = avatarMenu.classList.toggle('show');
        Sound.fx(show?'open':'close');
      });
      settingsBtn.addEventListener('click',()=>{
        const show = settingsMenu.classList.toggle('show');
        if(show){ volumeSlider.value = Sound.getVolume(); }
        Sound.fx(show?'open':'close');
      });
      settingsOk.addEventListener('click',()=>{
        settingsMenu.classList.remove('show');
        Sound.fx('select');
      });
      const savedVolume = localStorage.getItem('volume');
      if(savedVolume!==null){ Sound.setVolume(parseFloat(savedVolume)); }
      volumeSlider.value = Sound.getVolume();
      volumeSlider.addEventListener('input',e=>{
        Sound.setVolume(parseFloat(e.target.value));
        localStorage.setItem('volume', e.target.value);
      });
      fullscreenBtn.addEventListener('click',()=>{
        if(!document.fullscreenElement){
          document.documentElement.requestFullscreen();
        }else{
          document.exitFullscreen();
        }
        Sound.fx('option');
      });
      arrows.forEach(btn=>{
        btn.addEventListener('click',()=>{
          const part=btn.dataset.part;
          const dir=parseInt(btn.dataset.dir,10);
          if(part==='skin'){
            skinIdx=(skinIdx+dir+skinColors.length)%skinColors.length;
            avatar.skin=skinColors[skinIdx];
          }else if(part==='hair'){
            hairIdx=(hairIdx+dir+hairColors.length)%hairColors.length;
            avatar.hair=hairColors[hairIdx];
          }else if(part==='style'){
            styleIdx=(styleIdx+dir+hairStyles.length)%hairStyles.length;
            avatar.style=hairStyles[styleIdx];
          }else if(part==='eyes'){
            eyeIdx=(eyeIdx+dir+eyeColors.length)%eyeColors.length;
            avatar.eyes=eyeColors[eyeIdx];
          }else if(part==='shirt'){
            shirtIdx=(shirtIdx+dir+shirtColors.length)%shirtColors.length;
            avatar.shirt=shirtColors[shirtIdx];
          }else if(part==='hat'){
            hatIdx=(hatIdx+dir+hatStyles.length)%hatStyles.length;
            avatar.hat=hatStyles[hatIdx];
          }else if(part==='hatColor'){
            hatColorIdx=(hatColorIdx+dir+hatColors.length)%hatColors.length;
            avatar.hatColor=hatColors[hatColorIdx];
          }
          updateAvatarControls();
          drawAvatar();
          saveAvatar();
        });
      });
      avatarOk.addEventListener('click',e=>{
        e.preventDefault();
        avatar.nick = nickInput.value||'Player';
        nickDisplay.textContent = avatar.nick;
        drawAvatar();
        avatarMenu.classList.remove('show');
        saveAvatar();
        Sound.fx('select');
      });

      // инициализация 4 значков
      const items=[];
      tiles.forEach((tile, i)=>{
        const cv = tile.querySelector('canvas');
        const ctx = cv.getContext('2d',{alpha:false});
        ctx.imageSmoothingEnabled = false;
        items.push({ctx, name: drawers[i%drawers.length]});
      });
      let frame=0;
      function animateIcons(){
        frame++;
        items.forEach(it=> Icons.draw(it.ctx, it.name, frame));
        requestAnimationFrame(animateIcons);
      }
      animateIcons();

      /* ---------- Барабан и навигация ---------- */
      const total = tiles.length;
      const cols = 2;
      const rows = Math.ceil(total/cols);
      indicator.innerHTML = '<i></i>'.repeat(rows);
      const dots = [...indicator.children];
      let colIdx = 0;
      let index = 0; // верхний видимый ряд
      let frac = 0;  // прогресс анимации
      let stepX, STEP, R, isSmall;

      function recalcSteps(){
        const r = reel.getBoundingClientRect();
        const gap = 14;
        const size = Math.min((r.width - gap*(cols+1))/cols, (r.height - gap*3)/2);
        isSmall = window.innerWidth <= 600;
        const overlap = size * (isSmall ? 0.05 : 0.2); // ещё меньше перекрытие на телефонах
        stepX = size + gap;
        STEP = size - overlap;                    // шаг меньше размера => перекрытие
        R = STEP * (isSmall ? 1.3 : 1.4);         // чуть глубже, но легче
        for(let i=0;i<tiles.length;i++){
          tiles[i].style.setProperty('--size', size + 'px');
        }
        render();
      }

      function render(){
        const center = index + frac;
        for(let i=0;i<tiles.length;i++){
          const t = tiles[i];
          const col = i % cols;
          const row = Math.floor(i/cols);
          let delta = row - center;
          delta = ((delta % rows) + rows) % rows;
          if(delta > rows/2) delta -= rows;
          const theta = delta * (STEP / R);
          const y = R * Math.sin(theta);
          const z = R * (1 - Math.cos(theta));
          const x = (col - (cols-1)/2) * stepX;
          const scale = 1 - Math.min(Math.abs(delta)*0.06, 0.18);
          const blur = Math.min(
            Math.abs(delta) * (isSmall ? 0.5 : 0.8),
            isSmall ? 0.8 : 1.2
          );
          const bright = 1 - Math.min(Math.abs(delta)*0.25, .35);
          t.style.setProperty('--slotX', x+'px');
          t.style.setProperty('--slotY', y+'px');
          t.style.setProperty('--slotZ', (-z)+'px');
          t.style.setProperty('--slotScale', scale);
          t.style.setProperty('--slotBright', bright);
          t.style.setProperty('--slotBlur', blur+'px');
          t.style.setProperty('--slotRot', theta+'rad');
          t.style.zIndex = (1000 - z) | 0;         // корректный порядок перекрытия
          t.dataset.active = (Math.abs(delta)<0.51 && col===colIdx)?'1':'0';
        }
        const active = Math.round((center % rows + rows) % rows);
        for(let i=0;i<dots.length;i++){
          dots[i].classList.toggle('active', i===active);
        }
      }

      let snapping = false;
      function snap(dist){
        if(snapping) return;
        snapping = true;
        const start = frac;
        const end = start + dist;
        const t0 = performance.now();
        const dur = DUR * Math.max(1, Math.abs(dist));
        function step(t){
          const p = Math.min(1,(t - t0)/dur);
          const e = (p<1) ? (1.15*p - 0.15*Math.sin(Math.PI*p)) : 1;
          frac = start + (end-start)*e;
          render();
          if(p<1) requestAnimationFrame(step); else{
            index = (Math.round(index + dist) % rows + rows) % rows;
            frac = 0;
            snapping = false;
            render();
          }
        }
        requestAnimationFrame(step);
        Sound.fx('move');
        if(navigator.vibrate) navigator.vibrate(10);
      }

      function moveH(dir){
        colIdx = dir === 'right' ? (colIdx + 1) % cols : (colIdx - 1 + cols) % cols;
        render();
        Sound.fx('move');
      }

      addEventListener('keydown', e=>{
        if(e.key === 'ArrowUp'){ e.preventDefault(); snap(-1); }
        else if(e.key === 'ArrowDown'){ e.preventDefault(); snap(1); }
        else if(e.key === 'ArrowLeft'){ e.preventDefault(); moveH('left'); }
        else if(e.key === 'ArrowRight'){ e.preventDefault(); moveH('right'); }
        else if(e.key === 'Enter'){ selectCurrent(); }
      });

      reel.addEventListener('wheel', e=>{
        e.preventDefault();
        snap(e.deltaY>0?-1:1);
      }, {passive:false});

      let touchStartX=0, touchStartY=0, touchStartT=0;
      reel.addEventListener('touchstart',e=>{
        const t=e.touches[0];
        touchStartX=t.clientX; touchStartY=t.clientY; touchStartT=performance.now();
      },{passive:true});
      reel.addEventListener('touchmove',e=>{
        const t=e.touches[0];
        const dx=t.clientX-touchStartX;
        const dy=t.clientY-touchStartY;
        const dt=performance.now()-touchStartT;
        if(Math.abs(dy)>Math.abs(dx) && Math.abs(dy)>20){
          let steps=Math.round(Math.abs(dy)/STEP + Math.abs(dy)/dt*0.3);
          steps=Math.max(1,Math.min(steps,5));
          snap(dy<0?steps:-steps);
          touchStartY=t.clientY; touchStartT=performance.now();
        }else if(Math.abs(dx)>20){
          moveH(dx>0?'right':'left');
          touchStartX=t.clientX; touchStartT=performance.now();
        }
        e.preventDefault();
      },{passive:false});

      tiles.forEach((t,i)=>{
        t.addEventListener('click',()=>{
          const row = Math.floor(i/cols);
          colIdx = i % cols;
          let diff = row - index;
          diff = ((diff % rows) + rows) % rows;
          if(diff > rows/2) diff -= rows;
          if(diff) snap(diff);
          selectCurrent();
          if(t.dataset.game){ openGame(t); }
        });
      });

      recalcSteps();
      addEventListener('resize', ()=> requestAnimationFrame(recalcSteps));

      function selectCurrent(){
        const idx = (Math.round(index)%rows)*cols + colIdx;
        const tile = tiles[idx];
        const rect = tile.getBoundingClientRect();
        const color = tile.dataset.color || '#ffca3a';
        for(let i=0;i<8;i++){
          RetroFX.spawn(
            rect.left + rect.width/2 + (Math.random()*40-20),
            rect.top + rect.height/2 + (Math.random()*40-20),
            color
          );
        }
        tile.classList.add('flash');
        setTimeout(()=>tile.classList.remove('flash'),300);
        Sound.fx("select");
      }

      function openGame(tile){
        const gameSrc = tile.dataset.game;
        const rect = tile.getBoundingClientRect();
        const srect = screenEl.getBoundingClientRect();
        const canvas = tile.querySelector('canvas');
        const clone = canvas.cloneNode(true);
        clone.getContext('2d').drawImage(canvas,0,0);
        gameOverlay.innerHTML='';
        gameOverlay.appendChild(clone);
        gameOverlay.style.display='block';
        const scaleX = rect.width/srect.width;
        const scaleY = rect.height/srect.height;
        const offsetX = rect.left - srect.left;
        const offsetY = rect.top - srect.top;
        gameOverlay.style.transform = `translate(${offsetX}px,${offsetY}px) scale(${scaleX},${scaleY})`;
        requestAnimationFrame(()=>{ gameOverlay.style.transform='translate(0px,0px) scale(1)'; });
        gameOverlay.addEventListener('transitionend', function handler(){
          gameOverlay.removeEventListener('transitionend', handler);
          gameOverlay.innerHTML=`<iframe src="${gameSrc}"></iframe><button class="pbtn close" id="gameClose">×</button>`;
          $('#gameClose').addEventListener('click', closeGame);
        }, {once:true});
      }

      function closeGame(){
        gameOverlay.style.display='none';
        gameOverlay.innerHTML='';
        gameOverlay.style.transform='';
      }

      // стартовая подсказка

      // DPI-фикс для чёткого пикселя
      function fixDPR(){
        const dpr = Math.max(1, window.devicePixelRatio||1);
        const cvs = [...tiles.map(t=>t.querySelector('canvas')), avatarCanvas];
        cvs.forEach(cv=>{
          const cssW = Math.max(1, parseInt(getComputedStyle(cv).width,10));
          const cssH = Math.max(1, parseInt(getComputedStyle(cv).height,10));
          if(cv.width !== cssW*dpr || cv.height !== cssH*dpr){
            cv.width = cssW*dpr; cv.height = cssH*dpr;
            const ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=false; ctx.setTransform(dpr,0,0,dpr,0,0);
          }
        });
        // перерисовать
          items.forEach(it=> Icons.draw(it.ctx, it.name, frame));
          drawAvatar();
          recalcSteps();
          render();
      }
      addEventListener('resize', fixDPR, {passive:true});
      // чуть позже, чтобы успели примениться CSS-размеры
      requestAnimationFrame(fixDPR);
      setTimeout(fixDPR, 60);
    })();
  </script>
  <script src="retrofx.js"></script>
</body>
</html>
