<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Arcade — Pastel Pixel</title>
  <!-- необязательно: пиксельный шрифт; оффлайн будет fallback -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Пастельная ретро-палитра (без неона) */
      --bg0:#fff6e5;     /* светлый фон вокруг автомата */
      --bg1:#ffd9a3;     /* яркий корпус */
      --bg2:#fff1cc;     /* светлый экран */
      --ink:#2d1600;     /* тёмный текст */
      --dim:#714f34;     /* приглушённый */
      --pastel-pink:#ff5f9c;
      --pastel-lav:#ff8cc6;
      --pastel-mint:#00d9b8;
      --pastel-blue:#46a0ff;
      --pastel-peach:#ffca3a;
      --accent:#ff595e;  /* коралл */
      --accent2:#00bbf9; /* ярко-голубой */
      --accent3:#ffca3a; /* тёплая подсветка */
      --bezel-hi:#fff2d4;
      --bezel:#ffe0b3;
      --bezel-lo:#ffce91;

      --scan:0.06;        /* сканлайны мягче */
      --crt-curve:24px;   /* скругление «стекла» */
      --tile:220px;       /* базовый размер иконок (CSS) — ещё крупнее */
      --px:1px;
      --gap: clamp(16px, 3.8vmin, 28px);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; color:var(--ink);
      background:
        radial-gradient(1600px 900px at 15% -10%, #fff1d6 0%, transparent 60%),
        radial-gradient(1400px 800px at 110% 10%, #ffe6f2 0%, transparent 60%),
        linear-gradient(#fff6e5,#ffe0f0 40%, #fff6e5 100%);
      font-family:'Press Start 2P', ui-monospace, Consolas, monospace;
      letter-spacing:.45px;
      overflow:hidden;
    }

    /* мелкий пастельный «пиксельный» узор на фоне */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(var(--pastel-peach) 1px, transparent 1px) 0 0/6px 6px,
        radial-gradient(var(--pastel-pink) 1px, transparent 1px) 3px 3px/6px 6px;
      opacity:.25;
    }

    #bgCanvas{ position:fixed; inset:0; width:100%; height:100%; image-rendering:pixelated; z-index:0; }

    /* центрируем «кабинет», растягиваем почти на весь экран */
    .cabinet{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:min(2.5vw,18px);
      z-index:1;
    }

    /* внешний корпус — тоньше, чтобы экран был больше */
    .shell{
      width:min(1760px, 98vw);
      height:min(980px, 98svh);
      display:flex; flex-direction:column; align-items:center;
      border-radius:26px;
      background: linear-gradient(180deg, var(--bg1), #ffc777 55%, #ffb347);
      box-shadow:
        0 20px 46px rgba(0,0,0,.22),
        inset 0 0 0 2px #ffd59e,
        inset 0 0 0 8px #ffbd69,
        inset 0 0 120px rgba(255,205,110,.55);
      padding:12px;   /* было 26px -> экран вырос */
    }

    /* внутренний обод (bezel) — пастельные отблески */
    .bezel{
      width:100%; flex:1;
      border-radius:22px;
      background:
        linear-gradient(180deg, var(--bezel-hi), var(--bezel)),
        radial-gradient(150% 120% at 50% -20%, rgba(255,255,255,.25), transparent 55%),
        radial-gradient(140% 140% at 50% 120%, rgba(255,175,110,.35), transparent 50%);
      box-shadow:
        inset 0 0 0 2px #ffd59e,
        inset 0 0 0 8px #ffbd69,
        inset 0 6px 8px rgba(255,255,255,.65),
        inset 0 -6px 8px rgba(0,0,0,.25),
        inset 0 32px 120px rgba(255,200,110,.55),
        inset 0 -26px 70px rgba(255,180,80,.6),
        inset 0 0 120px rgba(255,227,198,.37); /* мягкий тёплый подсвет */
      padding:10px;  /* было 22px -> ещё больше экран */
      display:grid; place-items:center;
    }

    /* сам «экран» — максимально крупный, пастельные блики */
    .screen{
      position:relative;
      width:100%; height:100%;
      border-radius:var(--crt-curve);
      background:
        radial-gradient(160% 130% at 50% 18%, rgba(255,255,255,.15), transparent 55%),
        radial-gradient(120% 120% at 50% 118%, rgba(255,220,170,.38), transparent 50%),
        linear-gradient(180deg, #ffe9b6, var(--bg2));
      box-shadow:
        inset 0 0 0 2px #ffbf69,
        inset 0 0 0 6px #ffb347,
        inset 0 6px 12px rgba(255,255,255,.35),
        inset 0 -6px 12px rgba(0,0,0,.35),
        inset 0 0 80px rgba(255,195,100,.58),
        inset 0 0 320px rgba(255,180,80,.28);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      animation:crtFlicker 2.5s steps(2) infinite;
    }

    .screen::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.08), transparent 70%);
      mix-blend-mode:overlay; opacity:.85;
      animation:screenGlow 6s ease-in-out infinite;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:4px 12px;
      background:linear-gradient(180deg,#ffe9b6,#ffd6a6);
    }
    .topbar .title{ flex:1; text-align:center; font-size:12px; }
    .avatar{ border:none; background:transparent; padding:0; cursor:pointer; border-radius:50%; overflow:hidden; width:48px; height:48px; }
    .avatar canvas{ width:48px; height:48px; image-rendering:pixelated; display:block; }
    .avatar{ position:relative; transition:transform .2s ease, filter .2s ease; }
    .avatar::after{
      content:""; position:absolute; inset:-2px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.8), transparent 60%);
      mix-blend-mode:overlay; opacity:0; transition:opacity .3s ease;
    }
    .avatar:hover{ transform:scale(1.06); filter:brightness(1.1); }
    .avatar:hover::after{ opacity:.9; }
    .avatar:active{ transform:scale(.94); }
    #nickDisplay{ font-size:10px; }

    /* барабан со значками — один в ряд */
    .reel{
      flex:1;
      position:relative;
      overflow:hidden;
      perspective:800px;
      padding:calc(var(--gap) + 6px);
    }

    .panel{
      width:100%;
      height:130px;
      margin-top:12px;
      background:linear-gradient(180deg,#ffd6a6,#ffb347 70%,#e3952f);
      border-radius:0 0 18px 18px;
      box-shadow:inset 0 4px 0 #ffce91, inset 0 -6px 12px rgba(0,0,0,.35), 0 -2px 8px rgba(0,0,0,.15);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:40px;
      position:relative;
    }
    .slot{
      width:90px; height:26px;
      border-radius:14px/8px;
      background:#2d1600;
      box-shadow:inset 0 3px 4px rgba(255,255,255,.4), inset 0 -4px 6px rgba(0,0,0,.6);
      position:relative; overflow:hidden;
    }
    .coin{
      position:absolute; top:-70px; left:50%; transform:translateX(-50%);
      width:36px; height:36px; border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff2a8, #ffca3a 70%, #e3a400 100%);
      box-shadow:0 2px 0 #b8860b;
    }
    .coin.drop{ animation:coinDrop .8s ease-in forwards; }
    @keyframes coinDrop{
      0%{ transform:translate(-50%,-80px) rotate(0deg); }
      70%{ transform:translate(-50%,0) rotate(360deg); }
      100%{ transform:translate(-50%,4px) rotate(540deg); }
    }
    .pbtn{
      font-size:12px; letter-spacing:1px; color:var(--ink);
      padding:12px 26px; cursor:pointer; user-select:none;
      border:4px solid var(--ink); border-radius:10px;
      background:linear-gradient(180deg,#ffe2f0,#ffd0e0);
      box-shadow:0 4px 0 var(--ink);
      transition:transform .1s steps(2), filter .2s ease;
    }
    .pbtn:hover{ filter:brightness(1.1); }
    .pbtn:active{ transform:translateY(4px); box-shadow:0 0 0 var(--ink); }

    .menu{
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:var(--bg2);
      border:4px solid var(--ink);
      border-radius:8px; padding:16px; font-size:12px;
      display:none; z-index:10; width:260px; max-width:90vw;
    }
    .menu.show{ display:block; }
    .menu .row{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .menu .swatch{ width:20px; height:20px; border:2px solid var(--ink); border-radius:4px; }
    .menu .arrow{ width:24px; height:24px; border:2px solid var(--ink); background:var(--bg1); cursor:pointer; font-size:12px; line-height:18px; }

    /* CRT-слои */
    .scanlines, .vignette, .glass, .phosphor{
      pointer-events:none; position:absolute; inset:0; border-radius:var(--crt-curve);
    }
    .scanlines{
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,var(--scan)) 0px,
        rgba(0,0,0,var(--scan)) 2px,
        transparent 3px,
        transparent 4px
      );
      mix-blend-mode:multiply;
      animation:scanMove 6s linear infinite;
    }
    .vignette{
      background: radial-gradient(120% 100% at 50% 50%, transparent 62%, rgba(0,0,0,.55) 100%);
    }
    .glass{
      background:
        linear-gradient(110deg, rgba(255,255,255,.055) 0 22%, transparent 22% 80%, rgba(255,255,255,.03) 80% 100%),
        radial-gradient(120% 140% at 0% 0%, rgba(255,209,220,.06), transparent 45%),
        radial-gradient(120% 140% at 100% 0%, rgba(205,230,255,.05), transparent 40%);
      filter: blur(.3px); overflow:hidden; position:relative;
    }
    .glass::after{
      content:""; position:absolute; top:0; left:-60%; width:50%; height:100%;
      background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,0));
      transform:skewX(-20deg); animation:glare 8s linear infinite;
    }
    .phosphor{
      background:
        radial-gradient(100% 72% at 50% 44%, rgba(255,236,198,.045), transparent 52%),
        radial-gradient(80% 60% at 50% 48%, rgba(201,244,228,.035), transparent 55%);
      mix-blend-mode:screen;
    }

    @keyframes scanMove{ from{background-position:0 0;} to{background-position:0 4px;} }
    @keyframes tileFlash{ 0%{opacity:1;} 100%{opacity:0;} }
    .tile.flash::after{ opacity:.8; animation:tileFlash .3s steps(1) forwards; }

    /* плитки-значки (пастельные рамки и мягкие тени) */
    .tile{
      --size: clamp(160px, 22vmin, var(--tile)); /* ещё больше, чтобы заполнить экран */
      --slotY:0px;
      --slotScale:1;
      width: calc(var(--size) * 1.6);
      height: calc(var(--size) * 1.6);
      border-radius:18px;
      background: linear-gradient(180deg,#fff0d1,#ffd6a6);
      border:2px solid #ffbd69;
      box-shadow:
        inset 0 0 0 2px #ffe0b3,
        0 12px 26px rgba(0,0,0,.22);
      display:grid; grid-template-rows: 1fr auto; place-items:center;
      gap:12px;
      cursor:pointer; outline:none;
      position:absolute; top:50%; left:50%;
      transform:translate(-50%, var(--slotY)) scale(var(--slotScale));
      transition:transform .35s cubic-bezier(.33,.66,.66,1), filter .08s ease, box-shadow .08s ease, opacity .35s;
    }
    .tile::after{
      content:""; position:absolute; inset:0; border-radius:inherit;
      background:linear-gradient(135deg, rgba(255,255,255,.75) 0%, rgba(255,255,255,0) 60%);
      mix-blend-mode:overlay; opacity:0; transition:opacity .2s ease;
    }
    .tile:hover{ filter:brightness(1.07); }
    .tile:hover::after{ opacity:.55; }
    .tile:active{ transform:translate(-50%, calc(var(--slotY) + 1px)) scale(calc(var(--slotScale)*.996)); }
    .tile[data-focus="true"]{
      box-shadow:
        inset 0 0 0 2px #ffbd69,
        0 0 0 3px rgba(255,154,0,.42),
        0 18px 34px rgba(0,0,0,.35),
        0 0 28px rgba(255,200,90,.38); /* мягкое тёплое свечение */
      border-color:#ffae55;
    }
    .tile canvas{
      width: calc(var(--size));
      height: calc(var(--size));
      image-rendering: pixelated;
      background:#ffe9b6;
      border-radius:12px;
      border:2px solid #ffbd69;
      box-shadow: inset 0 0 0 2px #ffd59e, 0 0 0 1px rgba(0,0,0,.12);
    }
    .tile span{
      font-size:11px; color:var(--ink);
      text-shadow:0 1px 0 rgba(255,255,255,.6);
      letter-spacing:.8px; user-select:none; margin-bottom:6px;
    }
    .label-pink { color: var(--pastel-pink); }
    .label-mint { color: var(--pastel-mint); }
    .label-peach{ color: var(--pastel-peach); }
    .label-blue{ color: var(--pastel-blue); }

    /* HUD-подсказка */
    .hud{
      position:absolute; left:0; right:0; top:10px;
      display:grid; place-items:center; pointer-events:none;
      font-size:11px; color:var(--accent);
      text-shadow:0 1px 0 rgba(255,255,255,.7), 0 0 10px rgba(255,200,90,.42);
      opacity:0; transform: translateY(-6px);
      transition:opacity .18s ease, transform .18s ease;
    }
    .hud.show{ opacity:1; transform: translateY(0); }

    /* подсказка снизу */
    .hint{
      position:absolute; bottom:12px; left:0; right:0;
      text-align:center; font-size:10px; color:#7a5030;
      opacity:.85; text-shadow:0 1px 0 rgba(255,255,255,.7);
      pointer-events:none; animation:hintPulse 4s ease-in-out infinite;
    }

    /* адаптивные отступы для барабана */
    @media (max-width: 560px){
      :root{ --gap:18px; }
      .shell{ padding:10px; }
      .bezel{ padding:8px; }
      .reel{ padding:18px; }
      .tile{ border-radius:14px; }
      .pbtn{ width:80%; margin:0 auto; }
      .panel{ height:110px; gap:24px; }
    }

    @media (max-height:480px){
      .reel{ padding:12px; }
    }

    /* небольшие pixel-анимации */
    @keyframes tileBounce{
      0%,100%{ transform:translateY(0); }
      50%{ transform:translateY(-2px); }
    }
    /* анимации при наведении отключены, чтобы не мешать барабану */
    @keyframes focusPulse{0%,100%{filter:brightness(1);}50%{filter:brightness(1.2);}}
    .tile[data-focus="true"]{ animation:focusPulse .8s steps(2) infinite; }
    @keyframes glare{ from{left:-60%;} to{left:120%;} }
    @keyframes hintPulse{0%,100%{opacity:.85;}50%{opacity:.4;}}
    @keyframes crtFlicker{0%,100%{filter:brightness(1);}50%{filter:brightness(1.06);}}
    @keyframes screenGlow{0%,100%{opacity:.85;}50%{opacity:.65;}}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="cabinet" role="application" aria-label="Ретро-аркадный автомат (пастель)">
    <div class="shell">
      <div class="bezel">
        <div class="screen">
          <header class="topbar">
            <button class="avatar" id="avatarBtn" aria-label="Профиль">
              <canvas id="avatarCanvas" width="48" height="48"></canvas>
            </button>
            <h2 class="title">Pastel Pixel Arcade</h2>
            <span id="nickDisplay">Player</span>
          </header>
          <div class="reel" role="listbox" aria-label="Меню">
              <button class="tile" role="option" data-idx="0" aria-label="Космос">
                <canvas width="120" height="120"></canvas>
                <span class="label-blue">SPACE</span>
              </button>
            <button class="tile" role="option" data-idx="1" aria-label="Сердце">
              <canvas width="120" height="120"></canvas>
              <span class="label-pink">HEART</span>
            </button>
            <button class="tile" role="option" data-idx="2" aria-label="Ключ">
              <canvas width="120" height="120"></canvas>
              <span class="label-peach">KEY</span>
            </button>
            <button class="tile" role="option" data-idx="3" aria-label="Бомба">
              <canvas width="120" height="120"></canvas>
              <span class="label-mint">BOMB</span>
            </button>
          </div>
          <div id="avatarMenu" class="menu">
            <div class="row"><span>Ник:</span><input id="nick" type="text" value="Player"></div>
            <div class="row">
              <span>Кожа:</span>
              <button class="arrow" data-part="skin" data-dir="-1">◀</button>
              <div id="skinSwatch" class="swatch"></div>
              <button class="arrow" data-part="skin" data-dir="1">▶</button>
            </div>
            <div class="row">
              <span>Волосы:</span>
              <button class="arrow" data-part="hair" data-dir="-1">◀</button>
              <div id="hairSwatch" class="swatch"></div>
              <button class="arrow" data-part="hair" data-dir="1">▶</button>
            </div>
            <div class="row">
              <span>Стиль:</span>
              <button class="arrow" data-part="style" data-dir="-1">◀</button>
              <span id="styleName">Короткая</span>
              <button class="arrow" data-part="style" data-dir="1">▶</button>
            </div>
            <div style="text-align:center"><button id="avatarOk" class="pbtn">OK</button></div>
          </div>
          <div class="scanlines" aria-hidden="true"></div>
          <div class="vignette" aria-hidden="true"></div>
          <div class="glass" aria-hidden="true"></div>
          <div class="phosphor" aria-hidden="true"></div>
          <div class="hud" id="hud">СТРЕЛКИ • ENTER • МЫШЬ</div>
        </div>
      </div>
      <div class="panel">
        <button class="pbtn" data-action="start">START</button>
        <div class="slot"><div id="coin" class="coin"></div></div>
        <button class="pbtn" data-action="options">OPTIONS</button>
      </div>
      <div class="hint">↑↓←→ — перемещение • Enter — выбрать • Esc — снять выделение</div>
    </div>
  </div>

  <script src="audio.js"></script>
  <script>
    (function(){
      'use strict';
      const $ = (s,p=document)=>p.querySelector(s);
      const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
      const hud = $('#hud');
      const nickDisplay = $('#nickDisplay');
      const avatarCanvas = $('#avatarCanvas');
      const avatarBtn = $('#avatarBtn');
      const avatarMenu = $('#avatarMenu');
      const nickInput = $('#nick');
      const skinSwatch = $('#skinSwatch');
      const hairSwatch = $('#hairSwatch');
      const styleName = $('#styleName');
      const arrows = $$('.arrow');
      const avatarOk = $('#avatarOk');
      const reel = $('.reel');
      const tiles = $$('.reel .tile');
      const coin = $('#coin');


      /* ---------- Пиксель-рисовалки (пастель) ---------- */
      function px(ctx,x,y,s=2,c='#fff'){ ctx.fillStyle=c; ctx.fillRect(x*s,y*s,s,s); }
      function clear(ctx){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); }

      const C = {
        star:'#ffffff',
        star2:'#ffa700',
        ship:'#00d9b8',  // mint
        spark:'#ffbd69', // honey
        heart:'#ff9eb8', // pink
        heartHi:'#ffe4ef',
        ring:'#ffbd69',  // peach-gold
        stem:'#ffcf86',
        bomb:'#353535',
        fuse:'#ff5f9c',
        flame1:'#ff595e',
        flame2:'#ffca3a',
        sky:'#46a0ff'
      };

      function drawSpace(ctx,f=0){
        clear(ctx);
        const S=2, W=ctx.canvas.width/S, H=ctx.canvas.height/S;
        // постоянные звёзды
        if(!drawSpace.stars){
          drawSpace.stars = Array.from({length:84},()=>[(Math.random()*W)|0,(Math.random()*H)|0]);
        }
        drawSpace.stars.forEach((s,i)=>{
          const tw = (f+i)%40<2; px(ctx,s[0],s[1],S, tw?C.star2:C.star);
        });
        for(let x=0;x<W;x+=2){ px(ctx,x,H-2,S,C.sky); }
        const cx=(W/2)|0, cy=((H/2)|0) + ((f%20)<10?0:1);
        const ship=[
          "0010000",
          "0111000",
          "1111100",
          "1111110",
          "0111111",
          "0111111",
          "1111111",
          "0100010",
          "0011100"
        ];
        for(let y=0;y<ship.length;y++){
          for(let x=0;x<ship[0].length;x++){
            if(ship[y][x]==='1') px(ctx, cx-3+x, cy-5+y, S, C.ship);
          }
        }
        if(f%6<3){ px(ctx,cx-1,cy+5,S,C.spark); px(ctx,cx,cy+6,S,C.flame2); }
        else { px(ctx,cx-1,cy+5,S,C.flame2); }
      }

      function drawHeart(ctx,f=0){
        clear(ctx);
        const S=2, cx=24, cy=26;
        const beat = (f%30<15)?0:1;
        const base=[
          "00110110",
          "01111111",
          "11111111",
          "11111111",
          "11111111",
          "01111111",
          "00111111",
          "00011111",
          "00001111",
          "00000111"
        ];
        for(let y=0;y<base.length;y++){
          for(let x=0;x<base[0].length;x++){
            if(base[y][x]==='1') px(ctx, cx-4+x, cy-7+y - beat, S, C.heart);
          }
        }
        if(beat){
          px(ctx,cx-5,cy-4,S,C.heart);
          px(ctx,cx+4,cy-4,S,C.heart);
        }
        const shine = (f%60<30)?C.heartHi:C.star2;
        px(ctx,cx-1,cy-4,S,shine); px(ctx,cx,cy-5,S,shine);
      }

      function drawKey(ctx,f=0){
        clear(ctx);
        const S=2, cx=24, cy=26;
        for(let y=-8;y<=8;y++){
          for(let x=-8;x<=8;x++){
            const d=x*x + y*y; if(d<=64 && d>=36) px(ctx,cx+x,cy+y,S,C.ring);
          }
        }
        for(let y=-1;y<=1;y++){
          for(let x=0;x<12;x++) px(ctx,cx+8+x,cy+y,S,C.stem);
        }
        for(let y=0;y<2;y++){
          for(let x=0;x<3;x++) px(ctx,cx+16+x,cy+1+y,S,C.stem);
        }
        for(let y=0;y<2;y++){
          for(let x=0;x<2;x++) px(ctx,cx+20+x,cy+3+y,S,C.stem);
        }
        const sparkle = (f%64)|0;
        if(sparkle<16){ px(ctx,cx+8+sparkle%8,cy-8+Math.floor(sparkle/8),S,C.star2); }
      }

      function drawBomb(ctx,f=0){
        clear(ctx);
        const S=2, cx=24, cy=26;
        for(let y=-6;y<=6;y++){
          for(let x=-6;x<=6;x++){
            if(x*x + y*y <= 36) px(ctx,cx+x,cy+y,S,C.bomb);
          }
        }
        for(let i=0;i<6;i++) px(ctx,cx+5+i,cy-10+i,S,C.fuse);
        const flame = (f%10<5)?C.flame1:C.flame2;
        px(ctx,cx+12,cy-4,S,flame);
        px(ctx,cx+13,cy-3,S,flame);
        px(ctx,cx+12,cy-2,S,flame);
      }

      const drawers=[drawSpace, drawHeart, drawKey, drawBomb];

      /* ---------- Аватар ---------- */
      const avatar={ nick:'Player', hair:'#7b3f00', skin:'#ffcf9c', style:'short'};
      const skinColors=['#ffcf9c','#f1c27d','#e0ac69','#c68642'];
      const hairColors=['#7b3f00','#ff595e','#2e2e2e','#ffa726','#c0c0c0'];
      const hairStyles=['short','mohawk','long'];
      const hairNames={short:'Короткая',mohawk:'Ирокез',long:'Длинная'};
      let skinIdx=0, hairIdx=0, styleIdx=0;
      const avCtx = avatarCanvas.getContext('2d',{alpha:false});
      avCtx.imageSmoothingEnabled=false;
      function drawAvatar(){
        clear(avCtx);
        const S=2;
        for(let y=8;y<24;y++){
          for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.skin);
        }
        if(avatar.style==='short'){
          for(let y=6;y<12;y++){
            for(let x=8;x<24;x++) px(avCtx,x,y,S,avatar.hair);
          }
        } else if(avatar.style==='mohawk'){
          for(let y=4;y<16;y++){
            for(let x=15;x<17;x++) px(avCtx,x,y,S,avatar.hair);
          }
        } else if(avatar.style==='long'){
          for(let y=4;y<18;y++){
            for(let x=6;x<26;x++) px(avCtx,x,y,S,avatar.hair);
          }
        }
        px(avCtx,12,16,S,'#000');
        px(avCtx,20,16,S,'#000');
        for(let x=12;x<=20;x++) px(avCtx,x,22,S,'#000');
      }
      function updateAvatarControls(){
        skinSwatch.style.background = avatar.skin;
        hairSwatch.style.background = avatar.hair;
        styleName.textContent = hairNames[avatar.style];
      }
      drawAvatar();
      updateAvatarControls();
      avatarBtn.addEventListener('click',()=>{
        const show = avatarMenu.classList.toggle('show');
        Sound.fx(show?'open':'close');
      });
      arrows.forEach(btn=>{
        btn.addEventListener('click',()=>{
          const part=btn.dataset.part;
          const dir=parseInt(btn.dataset.dir,10);
          if(part==='skin'){
            skinIdx=(skinIdx+dir+skinColors.length)%skinColors.length;
            avatar.skin=skinColors[skinIdx];
          }else if(part==='hair'){
            hairIdx=(hairIdx+dir+hairColors.length)%hairColors.length;
            avatar.hair=hairColors[hairIdx];
          }else if(part==='style'){
            styleIdx=(styleIdx+dir+hairStyles.length)%hairStyles.length;
            avatar.style=hairStyles[styleIdx];
          }
          updateAvatarControls();
          drawAvatar();
        });
      });
      avatarOk.addEventListener('click',e=>{
        e.preventDefault();
        avatar.nick = nickInput.value||'Player';
        nickDisplay.textContent = avatar.nick;
        drawAvatar();
        avatarMenu.classList.remove('show');
        Sound.fx('select');
      });

      // инициализация 4 значков
      const items=[];
      tiles.forEach((tile, i)=>{
        const cv = tile.querySelector('canvas');
        const ctx = cv.getContext('2d',{alpha:false});
        ctx.imageSmoothingEnabled = false;
        items.push({ctx, draw: drawers[i%drawers.length]});
      });
      let frame=0;
      function animateIcons(){
        frame++;
        items.forEach(it=> it.draw(it.ctx, frame));
        requestAnimationFrame(animateIcons);
      }
      animateIcons();

      /* ---------- Барабан и навигация ---------- */
      let idx = 0;
      const total = tiles.length;
      function updateReel(){
        const step = tiles[0].offsetHeight * 1.1;
        tiles.forEach((t, i)=>{
          let diff = (i - idx + total) % total;
          if(diff > total/2) diff -= total;
          const y = diff * step;
          const scale = 1 - Math.abs(diff)*0.25;
          t.style.setProperty('--slotY', y + 'px');
          t.style.setProperty('--slotScale', scale.toFixed(2));
          t.style.opacity = Math.abs(diff) > 2 ? 0 : 1;
          t.style.zIndex = 100 - Math.abs(diff);
          t.dataset.focus = diff === 0;
        });
      }
      updateReel();

      function move(dir){
        idx = (dir === 'down') ? (idx + 1) % total : (idx - 1 + total) % total;
        updateReel();
        Sound.fx("move");
      }

      addEventListener('keydown', e=>{
        if(e.key === 'ArrowUp'){ e.preventDefault(); move('up'); }
        else if(e.key === 'ArrowDown'){ e.preventDefault(); move('down'); }
        else if(e.key === 'Enter'){ selectCurrent(); }
        else if(e.key === 'Escape'){ tiles.forEach(t=> t.dataset.focus='false'); hudOff(); }
      });

      reel.addEventListener('wheel', e=>{
        e.preventDefault();
        move(e.deltaY > 0 ? 'down' : 'up');
      }, {passive:false});

      tiles.forEach((t, i)=>{
        t.addEventListener('click', ()=>{
          idx = i;
          updateReel();
          selectCurrent();
        });
      });
      const navBtns = $$('.panel .pbtn');
      navBtns.forEach(btn=>{
        btn.addEventListener('click',()=>{
          const action = btn.dataset.action;
          hudOn(action.toUpperCase());
          if(action === 'start'){
            dropCoin();
            Sound.fx('start');
          }else if(action === 'options'){
            Sound.fx('option');
          }else{
            Sound.fx('click');
          }
          setTimeout(hudOff,700);
        });
      });

      function dropCoin(){
        coin.classList.remove('drop');
        void coin.offsetWidth;
        coin.classList.add('drop');
        Sound.fx('coin');
      }

      function hudOn(text){ hud.textContent=text; hud.classList.add('show'); }
      function hudOff(){ hud.classList.remove('show'); }
      function selectCurrent(){
        const tile = tiles[idx];
        const label = tile?.querySelector('span')?.textContent || 'ITEM';
        hudOn('SELECT: '+label);
        const rect = tile.getBoundingClientRect();
        const color = getComputedStyle(tile.querySelector('span')).color;
        for(let i=0;i<8;i++){
          RetroFX.spawn(
            rect.left + rect.width/2 + (Math.random()*40-20),
            rect.top + rect.height/2 + (Math.random()*40-20),
            color
          );
        }
        tile.classList.add('flash');
        setTimeout(()=>tile.classList.remove('flash'),300);
        Sound.fx("select");
        setTimeout(hudOff, 800);
      }

      // стартовая подсказка
      setTimeout(()=>hud.classList.add('show'), 220);
      setTimeout(hudOff, 1900);

      // DPI-фикс для чёткого пикселя
      function fixDPR(){
        const dpr = Math.max(1, window.devicePixelRatio||1);
        const cvs = [...tiles.map(t=>t.querySelector('canvas')), avatarCanvas];
        cvs.forEach(cv=>{
          const cssW = Math.max(1, parseInt(getComputedStyle(cv).width,10));
          const cssH = Math.max(1, parseInt(getComputedStyle(cv).height,10));
          if(cv.width !== cssW*dpr || cv.height !== cssH*dpr){
            cv.width = cssW*dpr; cv.height = cssH*dpr;
            const ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=false; ctx.setTransform(dpr,0,0,dpr,0,0);
          }
        });
        // перерисовать
        items.forEach(it=> it.draw(it.ctx, frame));
        drawAvatar();
      }
      addEventListener('resize', fixDPR, {passive:true});
      // чуть позже, чтобы успели примениться CSS-размеры
      requestAnimationFrame(fixDPR);
      setTimeout(fixDPR, 60);
    })();
  </script>
  <script src="retrofx.js"></script>
</body>
</html>
