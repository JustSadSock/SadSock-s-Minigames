<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#14110e">
  <title data-i18n="arena"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <link rel="stylesheet" href="styles/game.css">
  <style>
    :root{
      --playerA-color:var(--pastel-blue);
      --playerB-color:var(--pastel-pink);
      --attack-color:var(--accent);
      --shield-color:var(--accent2);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100svh;gap:8px;color:var(--ink);}
    .screen{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;height:100%;}
    .screen .btn{min-width:160px;}
    #gameArea{position:relative;width:100%;max-width:300px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:8px;}
    #scoreboard{display:flex;align-items:center;gap:6px;}
    #board{display:grid;grid-template-columns:repeat(5,16px);grid-template-rows:repeat(5,16px);gap:2px;background:var(--panel);padding:4px;border:2px solid var(--bezel);}
    .cell{width:16px;height:16px;background:var(--tile-bg);border:1px solid var(--bezel);position:relative;}
    .cell.preview-move{outline:1px dashed var(--ink);}
    .cell.preview-attack{outline:1px dashed var(--attack-color);}
    .cell.preview-shield{outline:1px dashed var(--shield-color);}
    .cell.collapsed{background:var(--accent);opacity:.5;}
    .token{width:12px;height:12px;border:1px solid var(--bezel);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);image-rendering:pixelated;}
    .token.A{background:var(--playerA-color);}
    .token.B{background:var(--playerB-color);}
    .action-icon,.preview-icon{font-size:12px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
    #ui{position:absolute;left:0;right:0;bottom:0;display:flex;flex-direction:column;gap:6px;padding:8px;background:var(--panel);border-top:2px solid var(--bezel);transform:translateY(100%);transition:transform .2s;}
    #ui.show{transform:translateY(0);}
    #phase{text-align:center;font-size:12px;}
    #planCells{display:flex;justify-content:space-between;}
    .planCell{width:16px;height:16px;border:1px solid var(--bezel);background:var(--tile-bg);display:flex;align-items:center;justify-content:center;font-size:12px;}
    #pad .k[data-act="attack"]{color:var(--attack-color);}
    #pad .k[data-act="shield"]{color:var(--shield-color);}
    #navButtons{display:flex;gap:8px;}
    #navButtons .btn{flex:1;}
    #atkOverlay,#replayOverlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:50;}
    #atkOverlay.show,#replayOverlay.show{display:flex;}
    #atkOverlay .atkBox{background:var(--panel);border:2px solid var(--bezel);padding:8px;display:grid;grid-template-areas:" . up . " " left center right" " . down . " " ok ok ok " " cancel cancel cancel";gap:4px;}
    #atkOverlay button{font-size:16px;}
    #replayControls{background:var(--panel);border:2px solid var(--bezel);padding:8px;display:flex;flex-direction:column;gap:4px;}
    .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border:2px solid var(--bezel);padding:8px;display:none;z-index:60;}
    .modal.show{display:block;}
  </style>
</head>
<body>
  <canvas class="icon" data-icon="arena" aria-hidden="true"></canvas>
  <div id="modeSelect" class="screen">
    <button class="btn" id="btn1p" data-i18n="singlePlayer">1P</button>
    <button class="btn" id="btn2p" data-i18n="twoPlayers">2P</button>
    <button class="btn" id="rulesBtnInitial" data-i18n="rules">Rules</button>
  </div>
  <div id="difficultySelect" class="screen" style="display:none;">
    <button class="btn" data-level="easy" data-i18n="easy">Easy</button>
    <button class="btn" data-level="medium" data-i18n="medium">Medium</button>
    <button class="btn" data-level="hard" data-i18n="hard">Hard</button>
    <button class="btn" data-level="expert" data-i18n="expert">Expert</button>
    <button class="btn" data-level="insane" data-i18n="insane">Insane</button>
  </div>
  <div id="gameArea" style="display:none;">
    <div id="scoreboard">
      <span id="scoreA" class="counter">0</span>
      <span>:</span>
      <span id="scoreB" class="counter">0</span>
      <button id="scoreReset" class="btn" data-i18n="resetScore">Reset</button>
      <button id="menuBtn" class="btn" data-i18n="toMenu">Menu</button>
      <button id="btnReplay" class="btn" data-i18n="replay">Replay</button>
    </div>
    <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öô</button>
    <div id="board"></div>
    <div id="ui" class="panel">
      <div id="phase"></div>
      <div id="planCells">
        <div id="pc0" class="planCell"></div>
        <div id="pc1" class="planCell"></div>
        <div id="pc2" class="planCell"></div>
        <div id="pc3" class="planCell"></div>
        <div id="pc4" class="planCell"></div>
      </div>
      <div id="pad" class="pad pad-inline">
        <div class="dpad" aria-hidden="true">
          <div class="k" data-act="up" data-dir="up" style="grid-area:up">‚ñ≤</div>
          <div class="k" data-act="left" data-dir="left" style="grid-area:left">‚óÄ</div>
          <div class="k" style="grid-area:mid;opacity:.35"></div>
          <div class="k" data-act="right" data-dir="right" style="grid-area:right">‚ñ∂</div>
          <div class="k" data-act="down" data-dir="down" style="grid-area:down">‚ñº</div>
        </div>
        <div class="ab">
          <div class="k" data-act="attack">‚öî</div>
          <div class="k" data-act="shield">üõ°</div>
        </div>
      </div>
      <div id="navButtons">
        <button id="btn-del" class="btn" data-i18n="deleteBtn">Delete</button>
        <button id="btn-next" class="btn" data-i18n="nextBtn">Next</button>
      </div>
    </div>
  </div>
  <div id="atkOverlay"><div class="atkBox"></div></div>
  <div id="rulesOverlay" class="modal">
    <h2 data-i18n="rulesHeader"></h2>
    <h3 data-i18n="rulesGeneral"></h3>
    <p data-i18n="rulesIntro"></p>
    <ul style="margin-left:15px;">
      <li data-i18n="rule1"></li>
      <li data-i18n="rule2"></li>
      <li data-i18n="rule3"></li>
      <li data-i18n="rule4"></li>
      <li data-i18n="rule5"></li>
      <li data-i18n="rule6"></li>
      <li data-i18n="rule7"></li>
      <li data-i18n="rule8"></li>
    </ul>
    <button id="rulesClose" data-i18n="close">Close</button>
    <button id="rulesTutorial" data-i18n="tutorial">Tutorial</button>
  </div>
  <div id="settingsModal" class="modal">
    <h2>‚öô</h2>
    <label data-i18n="volume">Volume:</label>
    <pixel-range><input type="range" id="volumeRange" min="0" max="1" step="0.1"></pixel-range>
    <label data-i18n="language">Language:</label>
    <pixel-select><select id="langSelect">
      <option value="en" data-i18n="selectEnglish">English</option>
      <option value="ru" data-i18n="selectRussian">–†—É—Å—Å–∫–∏–π</option>
      <option value="uk" data-i18n="selectUkrainian">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
    </select></pixel-select>
    <button id="settingsClose" data-i18n="close">Close</button>
  </div>
  <div id="tutorialOverlay" class="modal">
    <h2 data-i18n="tutorial"></h2>
    <p id="tutorialContent"></p>
    <button id="tutorialNext" data-i18n="nextBtn">Next</button>
    <button id="tutorialClose" data-i18n="close">Close</button>
  </div>
  <div id="replayOverlay">
    <div id="replayControls">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <button id="replayClose" data-i18n="close">Close</button>
        <button id="replayPlay">‚ñ∂</button>
        <button id="replayPause" style="display:none;">‚ùö‚ùö</button>
      </div>
      <pixel-range><input type="range" id="replaySlider" min="0" max="0" value="0"></pixel-range>
      <div id="speedButtons">
        <button data-speed="1">1x</button>
        <button data-speed="2">2x</button>
        <button data-speed="3">3x</button>
        <button data-speed="4">4x</button>
        <button data-speed="5">5x</button>
      </div>
    </div>
  </div>
  <div id="msgOverlay" class="modal">
    <h2 id="msgTitle"></h2>
    <p id="msgContent"></p>
    <button id="msgClose" data-i18n="close">Close</button>
  </div>
  <script type="module">
  import './src/ui.js';
  import './src/icons.js';
  import('./src/pixel-widgets.js');
  (async()=>{
    try{
      await import('./src/i18n.js');
    }catch(e){
      console.warn('i18n load failed',e);
      window.i18n={t:s=>s,setLang:()=>{},applyTranslations:()=>{},get lang(){return 'en';}};
    }
  // Main game logic
    const STEPS=5;
    const DXY={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]};
    let single=false; let aiLevel='medium'; let round=1; let phase='planA';
    let plans={A:[],B:[]};
    let usedMove={A:new Set(),B:new Set()};
    let usedAtkDirs={A:new Set(),B:new Set()};
    let usedAtk={A:0,B:0};
    let usedShield={A:0,B:0};
    let units={A:{x:0,y:2,alive:true},B:{x:4,y:2,alive:true}};
    let fullReset=false;
    let previewPositions={A:{x:units.A.x,y:units.A.y},B:{x:units.B.x,y:units.B.y}};
    let previewIcons=[];
    let previewHighlightCells=[];
    let score={A:0,B:0};
    let edgesCollapsed=false;
    let replayFrames=[]; let replayIndex=0; let replayTimer=null; let replaySpeed=1; let savedReplayFrames=[]; let isReplaying=false; let actionIcons=[];
    const modeSel=document.getElementById('modeSelect');
    const diffSel=document.getElementById('difficultySelect');
    const gameArea=document.getElementById('gameArea');
    const boardEl=document.getElementById('board');
    const ui=document.getElementById('ui');
    const phaseEl=document.getElementById('phase');
    const planCells=[0,1,2,3,4].map(i=>document.getElementById('pc'+i));
    const pad=document.getElementById('pad');
    const actions=Array.from(pad.querySelectorAll('[data-act]'));
    const btnDel=document.getElementById('btn-del');
    const btnNext=document.getElementById('btn-next');
    const scoreA=document.getElementById('scoreA');
    const scoreB=document.getElementById('scoreB');
    const scoreReset=document.getElementById('scoreReset');
    const menuBtn=document.getElementById('menuBtn');
    const btnReplay=document.getElementById('btnReplay');
    const atkOverlay=document.getElementById('atkOverlay');
    const atkBox=atkOverlay.querySelector('.atkBox');
    const rulesBtnInitial=document.getElementById('rulesBtnInitial');
    const rulesOv=document.getElementById('rulesOverlay');
    const msgOverlay=document.getElementById('msgOverlay');
    const msgTitle=document.getElementById('msgTitle');
    const msgContent=document.getElementById('msgContent');
    const msgClose=document.getElementById('msgClose');
    const rulesClose=document.getElementById('rulesClose');
    const rulesTutorial=document.getElementById('rulesTutorial');
    const settingsBtn=document.getElementById('settingsBtn');
    const settingsModal=document.getElementById('settingsModal');
    const settingsClose=document.getElementById('settingsClose');
    const volumeRange=document.getElementById('volumeRange');
    const langSelect=document.getElementById('langSelect');
    const tutorialOv=document.getElementById('tutorialOverlay');
    const tutorialContent=document.getElementById('tutorialContent');
    const tutorialNext=document.getElementById('tutorialNext');
    const tutorialClose=document.getElementById('tutorialClose');
    const replayOverlay=document.getElementById('replayOverlay');
    const replayClose=document.getElementById('replayClose');
    const replayPlay=document.getElementById('replayPlay');
    const replayPause=document.getElementById('replayPause');
    const replaySlider=document.getElementById('replaySlider');
    const speedButtons=document.querySelectorAll('#speedButtons button');
    function drawBoard(){boardEl.innerHTML=''; for(let y=0;y<5;y++){for(let x=0;x<5;x++){const cell=document.createElement('div'); cell.className='cell'; cell.id=`c${x}${y}`; if(edgesCollapsed&&(x===0||x===4||y===0||y===4)) cell.classList.add('collapsed'); boardEl.appendChild(cell);}} updateUnitsOnBoard();}
    function updateUnitsOnBoard(){document.querySelectorAll('.token').forEach(tok=>tok.remove()); ['A','B'].forEach(p=>{const u=units[p]; if(!u.alive) return; const cell=document.getElementById('c'+u.x+u.y); if(cell){const tok=document.createElement('div'); tok.className='token '+p; cell.appendChild(tok);}});}
    function resetRound(){plans={A:[],B:[]}; usedMove={A:new Set(),B:new Set()}; usedAtkDirs={A:new Set(),B:new Set()}; usedAtk={A:0,B:0}; usedShield={A:0,B:0}; if(fullReset){units={A:{x:0,y:2,alive:true},B:{x:4,y:2,alive:true}}; edgesCollapsed=false; fullReset=false;} replayFrames=[]; replayIndex=0; clearActionIcons(); clearPreviewIcons(); drawBoard(); phase='planA'; updateUI(); initPreviewPositions();}
    function startGame(){modeSel.style.display='none'; diffSel.style.display='none'; gameArea.style.display='block'; round=1; score={A:0,B:0}; updateScore(); fullReset=true; resetRound(); initPreviewPositions();}
    function updateScore(){scoreA.textContent=score.A; scoreB.textContent=score.B;}
    function recordAction(player,action){const plan=plans[player]; if(plan.length>=STEPS) return; if(typeof action==='string'){if(action==='shield'){if(usedShield[player]>=1) return; usedShield[player]++; plan.push(action); drawPlan(player); updateUI(); updatePreviewIcons(player); return;} if(DXY[action]){if(usedAtkDirs[player].has(action)) return; usedMove[player].add(action); plan.push(action); drawPlan(player); updateUI(); updatePreviewIcons(player); return;}} else if(typeof action==='object'){if(usedAtk[player]>=1) return; for(const d of action.dirs){if(usedMove[player].has(d)||usedAtkDirs[player].has(d)) return;} usedAtk[player]++; action.dirs.forEach(d=>usedAtkDirs[player].add(d)); plan.push(action); drawPlan(player); updateUI(); updatePreviewIcons(player); return;}}
    function deleteLast(){const player=(phase==='planA')?'A':'B'; const plan=plans[player]; if(!plan.length) return; const a=plan.pop(); if(typeof a==='string'){if(a==='shield') usedShield[player]--; if(DXY[a]){const hasOther=plan.some(item=>item===a); if(!hasOther) usedMove[player].delete(a);}} else {usedAtk[player]--; a.dirs.forEach(d=>usedAtkDirs[player].delete(d));} drawPlan(player); updateUI(); updatePreviewIcons(player);}
    function drawPlan(player){const plan=plans[player]; for(let i=0;i<STEPS;i++){const cell=planCells[i]; const act=plan[i]; if(!cell) continue; if(!act){cell.textContent=''; continue;} if(typeof act==='string'){cell.textContent={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂',shield:'üõ°'}[act]||'';} else {cell.textContent='‚öî';}}}
    function hidePlanCells(){planCells.forEach(cell=>{cell.textContent='';});}
    function clearActionIcons(){actionIcons.forEach(el=>el.remove()); actionIcons=[];}
    function initPreviewPositions(){previewPositions.A={x:units.A.x,y:units.A.y}; previewPositions.B={x:units.B.x,y:units.B.y};}
    function clearPreviewIcons(){previewIcons.forEach(el=>el.remove()); previewIcons=[]; previewHighlightCells.forEach(cell=>{cell.classList.remove('preview-move','preview-attack','preview-shield');}); previewHighlightCells=[];}
    function addPreviewIcon(x,y,char,color){const cell=document.getElementById('c'+x+y); if(!cell) return; const span=document.createElement('span'); span.className='preview-icon'; span.textContent=char; if(color) span.style.color=color; cell.appendChild(span); previewIcons.push(span);}
    function addPreviewHighlight(x,y,type){const cell=document.getElementById('c'+x+y); if(!cell) return; const cls=type==='move'?'preview-move':type==='attack'?'preview-attack':'preview-shield'; if(!cell.classList.contains(cls)){cell.classList.add(cls); previewHighlightCells.push(cell);}}
    function updatePreviewIcons(player){clearPreviewIcons(); let px=units[player].x; let py=units[player].y; const plan=plans[player]; plan.forEach(act=>{if(typeof act==='string'&&DXY[act]){const dx=DXY[act][0],dy=DXY[act][1]; px=Math.max(0,Math.min(4,px+dx)); py=Math.max(0,Math.min(4,py+dy)); const char={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[act]||''; addPreviewHighlight(px,py,'move'); addPreviewIcon(px,py,char);} else if(typeof act==='object'){act.dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const tx=px+dx,ty=py+dy; if(tx>=0&&tx<=4&&ty>=0&&ty<=4){const char={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[d]||''; addPreviewHighlight(tx,ty,'attack'); addPreviewIcon(tx,ty,char,varToRGB('--attack-color'));}}); addPreviewHighlight(px,py,'attack'); addPreviewIcon(px,py,'‚öî',varToRGB('--attack-color'));} else if(typeof act==='string'&&act==='shield'){addPreviewHighlight(px,py,'shield'); addPreviewIcon(px,py,'üõ°',varToRGB('--shield-color'));}}); previewPositions[player]={x:px,y:py};}
    function showMessage(text){msgTitle.textContent=i18n.t('internalMsg'); msgContent.textContent=text; msgOverlay.classList.add('show');}
    if(msgClose){msgClose.onclick=()=>{msgOverlay.classList.remove('show');};}
    function addActionIcon(x,y,char,color){const cell=document.getElementById('c'+x+y); if(!cell) return; const span=document.createElement('span'); span.className='action-icon'; span.textContent=char; if(color) span.style.color=color; cell.appendChild(span); actionIcons.push(span);}
    function updateUI(){if(!phaseEl) return; if(phase==='execute'){ui.classList.remove('show');} else {ui.classList.add('show');} if(phase==='planA'){phaseEl.textContent=i18n.t('round')+' '+round+': '+i18n.t('plan')+' '+(i18n.t('playerA')||'A');} else if(phase==='planB'){phaseEl.textContent=i18n.t('round')+' '+round+': '+i18n.t('plan')+' '+(i18n.t('playerB')||'B');} else if(phase==='execute'){phaseEl.textContent=i18n.t('round')+' '+round+': '+i18n.t('executeBtn');} if(phase==='planA'){btnNext.textContent=i18n.t('nextBtn');} else if(phase==='planB'){btnNext.textContent=i18n.t('executeBtn');} else {btnNext.textContent=i18n.t('nextBtn');} const currentPlan=(phase==='planA')?plans.A:plans.B; if(phase==='planA'&&single){btnNext.disabled=currentPlan.length<STEPS;} else if(phase==='planB'){btnNext.disabled=currentPlan.length<STEPS;} else if(phase==='planA'){btnNext.disabled=currentPlan.length<STEPS;} else {btnNext.disabled=false;} btnDel.disabled=!currentPlan.length;}
    function executePlans(){let step=0; function stepExec(){if(step>=STEPS){endRound(); return;} const actA=plans.A[step]||null; const actB=plans.B[step]||null; const shieldA=(actA==='shield'); const shieldB=(actB==='shield'); applyMove(units.A,actA); applyMove(units.B,actB); if(actA&&typeof actA==='object'&&units.A.alive){applyAttack(units.A,actA.dirs,units.B,shieldB);} if(actB&&typeof actB==='object'&&units.B.alive){applyAttack(units.B,actB.dirs,units.A,shieldA);} if(round>=4&&step===1&&!edgesCollapsed){collapseEdges();} recordFrame(actA,actB); updateUnitsOnBoard(); clearActionIcons(); if(actA){if(typeof actA==='string'){if(actA==='shield'){addActionIcon(units.A.x,units.A.y,'üõ°',varToRGB('--shield-color'));} else if(DXY[actA]){const icon={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[actA]; addActionIcon(units.A.x,units.A.y,icon);}} else {addActionIcon(units.A.x,units.A.y,'‚öî',varToRGB('--attack-color')); actA.dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const tx=units.A.x+dx,ty=units.A.y+dy; if(tx>=0&&tx<=4&&ty>=0&&ty<=4){const ar={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[d]; addActionIcon(tx,ty,ar,varToRGB('--attack-color'));}});}} if(actB){if(typeof actB==='string'){if(actB==='shield'){addActionIcon(units.B.x,units.B.y,'üõ°',varToRGB('--shield-color'));} else if(DXY[actB]){const iconB={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[actB]; addActionIcon(units.B.x,units.B.y,iconB);}} else {addActionIcon(units.B.x,units.B.y,'‚öî',varToRGB('--attack-color')); actB.dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const tx=units.B.x+dx,ty=units.B.y+dy; if(tx>=0&&tx<=4&&ty>=0&&ty<=4){const ar={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[d]; addActionIcon(tx,ty,ar,varToRGB('--attack-color'));}});}} const outcome=getOutcome(); step++; if(outcome){endRound(outcome); return;} setTimeout(stepExec,500);} stepExec();}
    function applyMove(unit,action){if(!unit.alive) return; if(typeof action==='string'&&DXY[action]){const dx=DXY[action][0],dy=DXY[action][1]; unit.x=Math.max(0,Math.min(4,unit.x+dx)); unit.y=Math.max(0,Math.min(4,unit.y+dy)); if(edgesCollapsed&&(unit.x===0||unit.x===4||unit.y===0||unit.y===4)) unit.alive=false;}}
    function applyAttack(attacker,dirs,opponent,opponentShield){const ax=attacker.x,ay=attacker.y; if(!opponentShield&&opponent.alive&&opponent.x===ax&&opponent.y===ay) opponent.alive=false; dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const nx=ax+dx,ny=ay+dy; if(nx<0||nx>4||ny<0||ny>4) return; if(!opponentShield&&opponent.alive&&opponent.x===nx&&opponent.y===ny) opponent.alive=false;});}
    function collapseEdges(){edgesCollapsed=true; for(let y=0;y<5;y++){for(let x=0;x<5;x++){if(x===0||x===4||y===0||y===4){const cell=document.getElementById('c'+x+y); if(cell) cell.classList.add('collapsed');}}}}
    function getOutcome(){if(!units.A.alive&&!units.B.alive) return 'draw'; if(!units.A.alive) return 'B'; if(!units.B.alive) return 'A'; return null;}
    function endRound(outcome){if(outcome==='A') score.A++; if(outcome==='B') score.B++; updateScore(); let message; if(outcome==='draw') message=i18n.t('bothDieDraw'); else if(!outcome) message=i18n.t('exhaustedDraw'); else message=(outcome==='A')?i18n.t('playerA_wins'):i18n.t('playerB_wins'); let showMsg=false; if(outcome==='A'||outcome==='B'||outcome==='draw') showMsg=true; else if(round===4) showMsg=true; if(showMsg){showMessage(message);} savedReplayFrames=replayFrames.slice(); round++; if(round>4){round=1; fullReset=true;} resetRound();}
    function recordFrame(actA=null,actB=null){const frame={A:{x:units.A.x,y:units.A.y,alive:units.A.alive},B:{x:units.B.x,y:units.B.y,alive:units.B.alive},edges:edgesCollapsed,actions:{A:actA? (typeof actA==='object'?{dirs:actA.dirs.slice()}:actA):null,B:actB? (typeof actB==='object'?{dirs:actB.dirs.slice()}:actB):null}}; replayFrames.push(frame); replaySlider.max=replayFrames.length-1;}
    function openAttack(player){atkBox.innerHTML=''; let tmp=[]; const center=document.createElement('div'); center.className='center'; center.textContent='‚öî'; atkBox.appendChild(center); ['up','left','right','down'].forEach(dir=>{if(usedMove[player].has(dir)||usedAtkDirs[player].has(dir)) return; const btn=document.createElement('button'); btn.textContent={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[dir]; btn.classList.add(dir); btn.onclick=()=>{if(tmp.includes(dir)){tmp=tmp.filter(d=>d!==dir); btn.classList.remove('sel');} else {tmp.push(dir); btn.classList.add('sel');}}; atkBox.appendChild(btn);}); const okBtn=document.createElement('button'); okBtn.textContent=i18n.t('ok'); okBtn.className='ok'; okBtn.onclick=()=>{recordAction(player,{dirs:tmp.slice()}); atkOverlay.classList.remove('show');}; atkBox.appendChild(okBtn); const cancelBtn=document.createElement('button'); cancelBtn.textContent=i18n.t('cancel'); cancelBtn.className='cancel'; cancelBtn.onclick=()=>{atkOverlay.classList.remove('show');}; atkBox.appendChild(cancelBtn); atkOverlay.classList.add('show');}
    function aiPlan(){const plan=[]; let shieldUsed=false; let attackUsed=false; const usedMoveAI=new Set(); const usedAtkDirAI=new Set(); let px=units.B.x; let py=units.B.y; for(let i=0;i<STEPS;i++){const dx=units.A.x-px; const dy=units.A.y-py; let desiredAttack=null; let desiredMove=null; if(!attackUsed && Math.abs(dx)+Math.abs(dy)<=2){const dirs=[]; if(dy<0) dirs.push('up'); if(dy>0) dirs.push('down'); if(dx<0) dirs.push('left'); if(dx>0) dirs.push('right'); if(dirs.length===0) dirs.push('up'); desiredAttack={dirs:dirs};} if(Math.abs(dx)+Math.abs(dy)>0){ if(Math.abs(dx)>Math.abs(dy)) desiredMove=(dx>0?'right':'left'); else desiredMove=(dy>0?'down':'up'); } let chosen=null; if(desiredAttack&&!attackUsed){let valid=true; for(const d of desiredAttack.dirs){if(usedMoveAI.has(d)||usedAtkDirAI.has(d)) {valid=false; break;}} if(valid){chosen=desiredAttack;}} if(!chosen && desiredMove){ if(usedAtkDirAI.has(desiredMove)){const allDirs=['up','down','left','right']; const available=allDirs.filter(d=>!usedAtkDirAI.has(d)); if(available.length>0) desiredMove=available[Math.floor(Math.random()*available.length)]; } chosen=desiredMove;} if(!chosen){ if(!shieldUsed){chosen='shield'; shieldUsed=true;} else {const allDirs=['up','down','left','right']; const available=allDirs.filter(d=>!usedAtkDirAI.has(d)); chosen=available[Math.floor(Math.random()*available.length)];}} plan.push(chosen); if(typeof chosen==='string'){ if(DXY[chosen]){usedMoveAI.add(chosen); px=Math.max(0,Math.min(4,px+DXY[chosen][0])); py=Math.max(0,Math.min(4,py+DXY[chosen][1]));}} else if(typeof chosen==='object'){attackUsed=true; for(const d of chosen.dirs) usedAtkDirAI.add(d);} } plans.B=plan;}
    function bindUI(){
      const setBtn=UI.attachDPad(pad,dir=>{ if(phase!=='planA'&&phase!=='planB') return; const player=(phase==='planA')?'A':'B'; recordAction(player,dir); });
      actions.forEach(btn=>{btn.onclick=()=>{if(btn.dataset.dir) return; if(phase!=='planA'&&phase!=='planB') return; const player=(phase==='planA')?'A':'B'; const act=btn.dataset.act; if(act==='attack') openAttack(player); else recordAction(player,act);};});
      btnDel.onclick=deleteLast;
      btnNext.onclick=()=>{if(phase==='planA'){if(plans.A.length<STEPS) return; if(single){clearPreviewIcons(); aiPlan(); phase='execute'; updateUI(); executePlans();} else {clearPreviewIcons(); hidePlanCells(); phase='planB'; updateUI(); initPreviewPositions();}} else if(phase==='planB'){if(plans.B.length<STEPS) return; clearPreviewIcons(); phase='execute'; updateUI(); executePlans();}};
      document.getElementById('btn1p').onclick=()=>{single=true; modeSel.style.display='none'; diffSel.style.display='flex';};
      document.getElementById('btn2p').onclick=()=>{single=false; startGame();};
      Array.from(diffSel.querySelectorAll('.btn')).forEach(btn=>{btn.onclick=()=>{aiLevel=btn.dataset.level; startGame();};});
      rulesBtnInitial.onclick=()=>{rulesOv.classList.add('show');};
      rulesClose.onclick=()=>{rulesOv.classList.remove('show');};
      let tutorialIndex=0; const tutorialScript=['tutorial1','tutorial2','tutorial3'];
      function showTutorial(){tutorialContent.textContent=i18n.t(tutorialScript[tutorialIndex]); tutorialOv.classList.add('show');}
      rulesTutorial.onclick=()=>{rulesOv.classList.remove('show'); tutorialIndex=0; showTutorial();};
      tutorialNext.onclick=()=>{tutorialIndex++; if(tutorialIndex<tutorialScript.length){showTutorial();} else {tutorialOv.classList.remove('show'); single=true; startGame();}};
      tutorialClose.onclick=()=>{tutorialOv.classList.remove('show');};
      settingsBtn.onclick=()=>{settingsModal.classList.add('show'); volumeRange.value=localStorage.getItem('volume')||1; langSelect.value=i18n.lang;};
      settingsClose.onclick=()=>{settingsModal.classList.remove('show');};
      menuBtn.onclick=()=>{location.reload();};
      scoreReset.onclick=()=>{score={A:0,B:0}; updateScore();};
      volumeRange.oninput=()=>{localStorage.setItem('volume',volumeRange.value);};
      langSelect.onchange=()=>{i18n.setLang(langSelect.value);};
      btnReplay.onclick=()=>{const frames=(savedReplayFrames&&savedReplayFrames.length)?savedReplayFrames:replayFrames; if(!frames||!frames.length) return; replayFrames=frames.slice(); isReplaying=true; replayOverlay.classList.add('show'); replayIndex=0; replaySlider.value=0; replaySlider.max=replayFrames.length-1; replayPlay.style.display='inline-block'; replayPause.style.display='none'; renderReplayFrame(0);};
      replayClose.onclick=()=>{stopReplay();};
      replayPlay.onclick=()=>{startReplay();};
      replayPause.onclick=()=>{pauseReplay();};
      replaySlider.oninput=e=>{pauseReplay(); renderReplayFrame(parseInt(e.target.value));};
      speedButtons.forEach(btn=>{btn.onclick=()=>{speedButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); replaySpeed=parseInt(btn.dataset.speed); if(isReplaying){startReplay();}};});
    }
    function renderReplayFrame(index){if(index<0||index>=replayFrames.length) return; replayIndex=index; replaySlider.value=index; const frame=replayFrames[index]; edgesCollapsed=frame.edges; drawBoard(); units.A.x=frame.A.x; units.A.y=frame.A.y; units.A.alive=frame.A.alive; units.B.x=frame.B.x; units.B.y=frame.B.y; units.B.alive=frame.B.alive; updateUnitsOnBoard(); clearActionIcons(); if(frame.actions){const actA=frame.actions.A; const actB=frame.actions.B; if(actA){if(typeof actA==='string'){if(actA==='shield') addActionIcon(frame.A.x,frame.A.y,'üõ°',varToRGB('--shield-color')); else if(DXY[actA]){const iconA={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[actA]; addActionIcon(frame.A.x,frame.A.y,iconA);}} else {addActionIcon(frame.A.x,frame.A.y,'‚öî',varToRGB('--attack-color')); actA.dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const tx=frame.A.x+dx,ty=frame.A.y+dy; if(tx>=0&&tx<=4&&ty>=0&&ty<=4){const ar={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[d]; addActionIcon(tx,ty,ar,varToRGB('--attack-color'));}});} } if(actB){if(typeof actB==='string'){if(actB==='shield') addActionIcon(frame.B.x,frame.B.y,'üõ°',varToRGB('--shield-color')); else if(DXY[actB]){const iconB={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[actB]; addActionIcon(frame.B.x,frame.B.y,iconB);}} else {addActionIcon(frame.B.x,frame.B.y,'‚öî',varToRGB('--attack-color')); actB.dirs.forEach(d=>{const dx=DXY[d][0],dy=DXY[d][1]; const tx=frame.B.x+dx,ty=frame.B.y+dy; if(tx>=0&&tx<=4&&ty>=0&&ty<=4){const ar={up:'‚ñ≤',down:'‚ñº',left:'‚óÄ',right:'‚ñ∂'}[d]; addActionIcon(tx,ty,ar,varToRGB('--attack-color'));}});} }} }
    function startReplay(){pauseReplay(); replayPlay.style.display='none'; replayPause.style.display='inline-block'; replayTimer=setInterval(()=>{if(replayIndex>=replayFrames.length-1){pauseReplay(); return;} replayIndex++; renderReplayFrame(replayIndex);},600/replaySpeed);}
    function pauseReplay(){if(replayTimer) clearInterval(replayTimer); replayTimer=null; replayPlay.style.display='inline-block'; replayPause.style.display='none';}
    function stopReplay(){pauseReplay(); replayOverlay.classList.remove('show'); isReplaying=false; drawBoard(); updateUnitsOnBoard();}
    i18n.applyTranslations();
    bindUI();
    langSelect.value=i18n.lang;
  })();
  </script>
</body>
</html>
