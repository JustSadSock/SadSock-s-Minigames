<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#14110e">
  <title data-i18n="retroBreakout"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <link rel="stylesheet" href="styles/game.css">
  <style>
  h1{color:var(--accent);}
    #gameCanvas{
      background:var(--bg2);
      border:4px solid var(--accent);
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
      image-rendering:pixelated;
      width:min(70svh,96vw);
      height:auto;
      aspect-ratio:3/4;
    }
    #score{margin:0;font-size:14px;}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }

  </style>
</head>
  <body class="theme-blue">
  <canvas class="icon" data-icon="breakout" aria-hidden="true"></canvas>
  <h1 data-i18n="retroBreakout"></h1>
  <div class="play">
    <div class="hud">
      <div id="score" class="counter"></div>
      <button id="scoresBtn" class="pill" data-i18n-aria-label="records">üèÜ</button>
      <div id="lives" class="counter"></div>
    </div>
    <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öôÔ∏è</button>
    <canvas id="gameCanvas" tabindex="0" data-i18n-aria-label="gameField"></canvas>
    <div id="toast" class="toast" aria-live="polite"></div>
    <div id="pad" class="pad pad-center">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-dir="up" style="grid-area:up"><canvas data-icon="arrow-up"></canvas></div>
        <div class="k" data-dir="left" style="grid-area:left"><canvas data-icon="arrow-left"></canvas></div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right"><canvas data-icon="arrow-right"></canvas></div>
        <div class="k" data-dir="down" style="grid-area:down"><canvas data-icon="arrow-down"></canvas></div>
      </div>
      <button class="btn" id="startBtn" data-i18n="start" data-i18n-aria-label="start"></button>
    </div>
  </div>
  <script type="module">
    import './src/audio.js';
    import './src/ui.js';
    import './src/scores.js';
    import './src/icons.js';
    import './src/i18n.js';
    import { initSettings } from './src/settings.js';
    import { createGameLoop } from './src/game-loop.js';
    initSettings();

    const canvas = document.getElementById('gameCanvas');
    const startBtn = document.getElementById('startBtn');
    const pad = document.getElementById('pad');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const scoresBtn = document.getElementById('scoresBtn');
    const toastEl = document.getElementById('toast');
    const scores = Scores('breakout');
    scoresBtn.onclick = scores.show;
    let best = Number(localStorage.getItem('breakoutBest') || 0);
    const scoreBoard = UI.score(scoreEl, globalThis.i18n?.t('score') || 'Score', globalThis.i18n?.t('best') || 'best');
    const livesLabel = globalThis.i18n?.t('lives') || 'Lives';
    scoreBoard.set(0, best);
    livesEl.textContent = livesLabel + ': 3';

    const styles = getComputedStyle(document.documentElement);
    const bgColor = styles.getPropertyValue('--bg2');
    const paddleColor = styles.getPropertyValue('--pastel-blue');
    const ballColor = styles.getPropertyValue('--pastel-pink');
    const brickPalette = ['--pastel-peach', '--pastel-mint', '--pastel-blue', '--pastel-pink'].map(v => styles.getPropertyValue(v));
    const paddleWidth = 30;

    let gameRunning = false;
    let ball, paddle, bricks, brickRows = 4, brickCols = 8;
    let score = 0, lives = 3;
    const showToast = UI.makeToast(toastEl);

    function resetGame() {
      gameRunning = false;
      score = 0; lives = 3;
      updateScore();
      setBall();
      paddle = { x: (120 - paddleWidth) / 2, y: 160 - 10, w: paddleWidth, h: 4 };
      bricks = [];
      const bw = 120 / brickCols;
      const bh = 10;
      for (let r = 0; r < brickRows; r++) {
        for (let c = 0; c < brickCols; c++) {
          bricks.push({ x: c * bw, y: 20 + r * (bh + 2), w: bw - 2, h: bh, alive: true, color: brickPalette[r % brickPalette.length], hit: 0 });
        }
      }
    }

    function setBall() {
      ball = { x: 60, y: 140, vx: 120, vy: -120, r: 2 };
    }

    function updateScore() {
      scoreBoard.set(score, best);
      livesEl.textContent = livesLabel + ': ' + lives;
    }

    function update({ dt, keys }) {
      if (!gameRunning) return;
      if (keys.left) setPaddle(paddle.x - 200 * dt);
      if (keys.right) setPaddle(paddle.x + 200 * dt);
      ball.x += ball.vx * dt;
      ball.y += ball.vy * dt;
      if (ball.x < ball.r || ball.x > 120 - ball.r) ball.vx *= -1;
      if (ball.y < ball.r) ball.vy *= -1;
      if (ball.y > 160 - ball.r) {
        lives--; updateScore();
        if (lives > 0) { setBall(); }
        else {
          Sound.fx('error');
          gameRunning = false;
          if (score > best) { best = score; localStorage.setItem('breakoutBest', best); showToast((globalThis.i18n?.t('best') || 'Best') + ': ' + score); } else { showToast((globalThis.i18n?.t('score') || 'Score') + ': ' + score); }
          scores.add(score);
          return;
        }
      }
      if (ball.y + ball.r >= paddle.y && ball.x >= paddle.x && ball.x <= paddle.x + paddle.w) {
        ball.vy = -Math.abs(ball.vy);
        const offset = (ball.x - (paddle.x + paddle.w / 2)) / (paddle.w / 2);
        ball.vx = 200 * offset;
      }
      for (const b of bricks) {
        if (b.alive && ball.x >= b.x && ball.x <= b.x + b.w && ball.y >= b.y && ball.y <= b.y + b.h) {
          b.alive = false; b.hit = 6;
          ball.vy *= -1;
          ball.vx *= 1.02; ball.vy *= 1.02;
          score++;
          Sound.fx('coin');
          updateScore();
          break;
        }
      }
    }

    function draw(ctx) {
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, 120, 160);
      for (const b of bricks) {
        if (b.alive || b.hit) {
          if (b.hit) {
            ctx.fillStyle = b.hit % 2 ? '#fff' : b.color;
            b.hit--;
          } else {
            ctx.fillStyle = b.color;
          }
          ctx.fillRect(b.x, b.y, b.w, b.h);
        }
      }
      ctx.fillStyle = paddleColor;
      ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
      ctx.fillStyle = ballColor;
      ctx.fillRect(ball.x - ball.r, ball.y - ball.r, ball.r * 2, ball.r * 2);
    }

    function setPaddle(left) {
      paddle.x = Math.min(Math.max(left, 0), 120 - paddle.w);
    }

    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      setPaddle(e.clientX - rect.left - paddle.w / 2);
    });
    canvas.addEventListener('touchmove', e => {
      const rect = canvas.getBoundingClientRect();
      const t = e.touches[0];
      setPaddle(t.clientX - rect.left - paddle.w / 2);
      e.preventDefault();
    }, { passive: false });

    function startGame() {
      Sound.fx('start');
      resetGame();
      gameRunning = true;
      startBtn.textContent = globalThis.i18n?.t('restart') || 'Restart';
    }

    const { ctx, keys, attachPad } = createGameLoop(canvas, { width: 120, height: 160, update, draw });
    attachPad(pad, (dir, val) => { if (!gameRunning && val) startGame(); });
    document.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      if (!gameRunning && (k === 'arrowleft' || k === 'a' || k === 'arrowright' || k === 'd' || k === ' ')) startGame();
    });
    startBtn.addEventListener('click', startGame);

    resetGame();
  </script>
</body>
</html>

