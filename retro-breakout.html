<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title data-i18n="retroBreakout"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      gap:12px;
      color:var(--ink);
    }
    h1{margin:0;font-size:18px;font-family:'Press Start 2P',ui-monospace,monospace;color:var(--accent);}
    .play{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #gameCanvas{
      background:var(--bg2);
      border:4px solid var(--accent);
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
      image-rendering:pixelated;
      width:min(70svh,96vw);
      height:auto;
      aspect-ratio:3/4;
    }
    #score{margin:0;font-size:14px;}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }

  </style>
</head>
<body class="theme-blue">
  <h1 data-i18n="retroBreakout"></h1>
  <div class="hud hud-inline">
    <div id="score" class="counter"></div>
    <div id="lives" class="counter"></div>
    <button id="scoresBtn" class="pill" data-i18n-aria-label="records">üèÜ</button>
  </div>
  <div class="play">
    <canvas id="gameCanvas" tabindex="0" data-i18n-aria-label="gameField"></canvas>
    <div id="toast" class="toast" aria-live="polite"></div>
    <div id="pad" class="pad pad-center">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-dir="up" style="grid-area:up">‚ñ≤</div>
        <div class="k" data-dir="left" style="grid-area:left">‚óÑ</div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right">‚ñ∫</div>
        <div class="k" data-dir="down" style="grid-area:down">‚ñº</div>
      </div>
      <button class="btn" id="startBtn" data-i18n="start" data-i18n-aria-label="start">START</button>
    </div>
  </div>
  <script src="src/audio.js"></script>
  <script src="src/ui.js"></script>
  <script src="src/scores.js"></script>
  <script>
  (function(){
    'use strict';
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled=false;
    canvas.width=120; canvas.height=160;
    let gameRunning=false;
    let ball, paddle, bricks, brickRows=4, brickCols=8;
    let score=0, lives=3;
    const scoreEl=document.getElementById('score');
    const livesEl=document.getElementById('lives');
    const startBtn=document.getElementById('startBtn');
    const paddleWidth=30;
    const toastEl=document.getElementById('toast');
    const pad=document.getElementById('pad');
    const showToast=UI.makeToast(toastEl);
    const scoreBoard=UI.score(scoreEl,globalThis.i18n?.t('score')||'Score',globalThis.i18n?.t('best')||'best');
    const livesLabel=globalThis.i18n?.t('lives')||'Lives';
    const scores=Scores('breakout');
    document.getElementById('scoresBtn').onclick=scores.show;
    let left=false,right=false;
    let best=Number(localStorage.getItem('breakoutBest')||0);
    const styles=getComputedStyle(document.documentElement);
    const bgColor=styles.getPropertyValue('--bg2');
    const paddleColor=styles.getPropertyValue('--pastel-blue');
    const ballColor=styles.getPropertyValue('--pastel-pink');
    const brickPalette=['--pastel-peach','--pastel-mint','--pastel-blue','--pastel-pink'].map(v=>styles.getPropertyValue(v));
    let lastTime=0;
    const paddleSpeed=200;

    function resetGame(){
      gameRunning=false;
      score=0; lives=3;
      updateScore();
      setBall();
      paddle={x:(canvas.width-paddleWidth)/2,y:canvas.height-10,w:paddleWidth,h:4};
      bricks=[];
      const bw=canvas.width/brickCols;
      const bh=10;
      for(let r=0;r<brickRows;r++){
        for(let c=0;c<brickCols;c++){
          bricks.push({x:c*bw,y:20+r*(bh+2),w:bw-2,h:bh,alive:true,color:brickPalette[r%brickPalette.length],hit:0});
        }
      }
      draw();
    }
    function setBall(){
      ball={x:canvas.width/2,y:canvas.height-20,vx:120,vy:-120,r:2};
    }
    function updateScore(){scoreBoard.set(score,best); livesEl.textContent=livesLabel+': '+lives;}
    function draw(){
      ctx.fillStyle=bgColor;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      for(const b of bricks){
        if(b.alive||b.hit){
          if(b.hit){
            ctx.fillStyle=b.hit%2?'#fff':b.color;
            b.hit--;
          }else{
            ctx.fillStyle=b.color;
          }
          ctx.fillRect(b.x,b.y,b.w,b.h);
        }
      }
      ctx.fillStyle=paddleColor;
      ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);
      ctx.fillStyle=ballColor;
      ctx.fillRect(ball.x-ball.r,ball.y-ball.r,ball.r*2,ball.r*2);
    }
    function loop(t){
      if(!gameRunning) return;
      if(!lastTime) lastTime=t;
      const dt=(t-lastTime)/1000; lastTime=t;
      if(left) setPaddle(paddle.x-paddleSpeed*dt);
      if(right) setPaddle(paddle.x+paddleSpeed*dt);
      ball.x+=ball.vx*dt;
      ball.y+=ball.vy*dt;
      if(ball.x<ball.r || ball.x>canvas.width-ball.r) ball.vx*=-1;
      if(ball.y<ball.r) ball.vy*=-1;
      if(ball.y>canvas.height-ball.r){
        lives--; updateScore();
        if(lives>0){ setBall(); }
        else {
          Sound.fx('error');
          gameRunning=false;
          if(score>best){best=score; localStorage.setItem('breakoutBest',best); showToast((globalThis.i18n?.t('best')||'Best')+': '+score);}else{showToast((globalThis.i18n?.t('score')||'Score')+': '+score);}
          scores.add(score);
          return;
        }
      }
      if(ball.y+ball.r>=paddle.y && ball.x>=paddle.x && ball.x<=paddle.x+paddle.w){
        ball.vy=-Math.abs(ball.vy);
        const offset=(ball.x-(paddle.x+paddle.w/2))/(paddle.w/2);
        ball.vx=200*offset;
      }
      for(const b of bricks){
        if(b.alive && ball.x>=b.x && ball.x<=b.x+b.w && ball.y>=b.y && ball.y<=b.y+b.h){
          b.alive=false; b.hit=6;
          ball.vy*=-1;
          ball.vx*=1.02; ball.vy*=1.02;
          score++;
          Sound.fx('coin');
          updateScore();
          break;
        }
      }
      draw();
      requestAnimationFrame(loop);
    }
    function setPaddle(left){
      paddle.x=Math.min(Math.max(left,0),canvas.width-paddle.w);
    }
    canvas.addEventListener('mousemove',e=>{
      const rect=canvas.getBoundingClientRect();
      setPaddle(e.clientX-rect.left - paddle.w/2);
    });
    canvas.addEventListener('touchmove',e=>{
      const rect=canvas.getBoundingClientRect();
      const t=e.touches[0];
      setPaddle(t.clientX-rect.left - paddle.w/2);
      e.preventDefault();
    },{passive:false});
    function startGame(){
      Sound.fx('start');
      resetGame();
      gameRunning=true;
      startBtn.textContent=globalThis.i18n?.t('restart')||'RESTART';
      requestAnimationFrame(loop);
    }
    const setBtn=UI.attachDPad(pad,dir=>{
      if(!gameRunning) startGame();
      if(dir==='left'){ left=true; right=false; }
      else if(dir==='right'){ right=true; left=false; }
    });
    pad.querySelectorAll('[data-dir]').forEach(btn=>{
      const dir=btn.dataset.dir;
      const off=e=>{e.preventDefault(); setBtn(dir,false); if(dir==='left') left=false; else right=false;};
      btn.addEventListener('touchend',off,{passive:false});
      btn.addEventListener('touchcancel',off,{passive:false});
      btn.addEventListener('mouseup',off);
      btn.addEventListener('mouseleave',off);
    });
    document.addEventListener('keydown',e=>{
      const k=e.key.toLowerCase();
      if(k==='arrowleft' || k==='a'){ left=true; setBtn('left',true); }
      else if(k==='arrowright' || k==='d'){ right=true; setBtn('right',true); }
      if(!gameRunning && (k==='arrowleft' || k==='a' || k==='arrowright' || k==='d' || k===' ')) startGame();
    });
    document.addEventListener('keyup',e=>{
      const k=e.key.toLowerCase();
      if(k==='arrowleft' || k==='a'){ left=false; setBtn('left',false); }
      else if(k==='arrowright' || k==='d'){ right=false; setBtn('right',false); }
    });
    startBtn.addEventListener('click',startGame);
    resetGame();
  })();
  </script>
<script type="module" src="src/serve-warning.js"></script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>

