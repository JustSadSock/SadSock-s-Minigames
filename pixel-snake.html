<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title data-i18n="pixelSnake"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      gap:12px;
      color:var(--ink);
    }
    h1{margin:0;font-size:18px;}
    .play{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #gameCanvas{
      image-rendering:pixelated;
      background:var(--bg2);
      border:4px solid var(--pastel-peach);
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
      width:clamp(60vw,75svh,96vw);
      height:auto;
      aspect-ratio:3/4;
    }
    #score{margin:0;font-size:14px;font-weight:bold;text-shadow:0 1px 0 var(--bg0);}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }


    .color-pick{display:flex;gap:4px;}
    .color-pick button{width:36px;height:36px;border:2px solid var(--bezel);border-radius:8px;box-shadow:inset 0 0 0 2px var(--bezel-hi);cursor:pointer;}
    .color-pick button.sel{outline:2px solid var(--accent);}

  </style>
</head>
<body class="theme-blue">
  <h1>Pixel¬†Snake</h1>
  <div class="hud hud-inline">
    <div id="score" class="counter">–°—á—ë—Ç:¬†0</div>
    <button id="scoresBtn" class="pill" aria-label="–†–µ–∫–æ—Ä–¥—ã">üèÜ</button>
  </div>
  <div id="colorPick" class="color-pick" title="–¶–≤–µ—Ç –∑–º–µ–π–∫–∏">
    <button data-col="--pastel-mint" style="background:var(--pastel-mint)" aria-label="–ó–µ–ª—ë–Ω—ã–π"></button>
    <button data-col="--pastel-blue" style="background:var(--pastel-blue)" aria-label="–°–∏–Ω–∏–π"></button>
    <button data-col="--pastel-pink" style="background:var(--pastel-pink)" aria-label="–†–æ–∑–æ–≤—ã–π"></button>
    <button data-col="--pastel-peach" style="background:var(--pastel-peach)" aria-label="–ü–µ—Ä—Å–∏–∫–æ–≤—ã–π"></button>
  </div>
  <div class="play">
    <canvas id="gameCanvas" tabindex="0" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></canvas>
    <div id="toast" class="toast"></div>
    <div id="pad" class="pad pad-inline">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-dir="up" style="grid-area:up">‚ñ≤</div>
        <div class="k" data-dir="left" style="grid-area:left">‚óÑ</div>
        <div class="k" style="grid-area:mid; opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right">‚ñ∫</div>
        <div class="k" data-dir="down" style="grid-area:down">‚ñº</div>
      </div>
      <div class="ab">
        <button class="btn" id="startBtn" aria-label="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É">START</button>
      </div>
    </div>
  </div>
  <script src="src/ui.js"></script>
  <script src="src/audio.js"></script>
  <script src="src/scores.js"></script>
  <script>
  (function(){
    'use strict';
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled=false;
    canvas.width=120; canvas.height=160;
    let running=false;
    let lastTime=0, acc=0;
    const baseInterval=150;
    const cellSize=5;
    const cols=Math.floor(canvas.width / cellSize);
    const rows=Math.floor(canvas.height / cellSize);
    let snake, dir, nextDir, apple, score, best;
    const scoreEl=document.getElementById('score');
    const startBtn=document.getElementById('startBtn');
    const header=document.querySelector('h1');
    const toastEl=document.getElementById('toast');
    const pad=document.getElementById('pad');
    const colorPick=document.getElementById('colorPick');
    const scoreBoard=UI.score(scoreEl,'–°—á—ë—Ç');
    const scores=Scores('snake');
    document.getElementById('scoresBtn').onclick=scores.show;
    const toast=UI.makeToast(toastEl);
    const styles=getComputedStyle(document.documentElement);
    const bgColor=styles.getPropertyValue('--bg2');
    const appleColor=styles.getPropertyValue('--pastel-peach');
    let snakeColor=localStorage.getItem('snakeColor')||styles.getPropertyValue('--pastel-mint');
    const bgCanvas=document.createElement('canvas');
    bgCanvas.width=canvas.width;
    bgCanvas.height=canvas.height;
    const bgCtx=bgCanvas.getContext('2d');
    function drawBG(){
      bgCtx.fillStyle=bgColor;
      bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
      bgCtx.fillStyle='rgba(0,0,0,0.05)';
      for(let x=0;x<=bgCanvas.width;x+=cellSize) bgCtx.fillRect(x,0,1,bgCanvas.height);
      for(let y=0;y<=bgCanvas.height;y+=cellSize) bgCtx.fillRect(0,y,bgCanvas.width,1);
    }
    drawBG();

    function toHex(col){
      if(col.startsWith('#')) return col.trim();
      const m=col.match(/(\d+),\s*(\d+),\s*(\d+)/);
      return m? '#' + [1,2,3].map(i=>('0'+parseInt(m[i]).toString(16)).slice(-2)).join('') : '#3fbf75';
    }
    const colorBtns=colorPick.querySelectorAll('button');
    colorBtns.forEach(btn=>{
      const getCol=()=>getComputedStyle(document.documentElement).getPropertyValue(btn.dataset.col);
      if(toHex(getCol())===toHex(snakeColor)) btn.classList.add('sel');
      btn.addEventListener('click',()=>{
        snakeColor=getCol().trim();
        localStorage.setItem('snakeColor',snakeColor);
        colorBtns.forEach(b=>b.classList.remove('sel'));
        btn.classList.add('sel');
        draw();
      });
    });


    function resetGame(){
      snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
      dir={x:1,y:0};
      nextDir={x:1,y:0};
      apple=spawnApple();
      score=0;
      best=parseInt(localStorage.getItem('snakeBest')||'0',10);
      scoreBoard.set(score,best);
      running=false;
      startBtn.textContent='START';
    }
    function spawnApple(){
      let pos;
      do{
        pos={x:Math.floor(Math.random()*cols),y:Math.floor(Math.random()*rows)};
      }while(snake.some(s=>s.x===pos.x && s.y===pos.y));
      return pos;
    }
    function update(){
      dir=nextDir;
      const head={x:(snake[0].x+dir.x+cols)%cols, y:(snake[0].y+dir.y+rows)%rows};
      if(snake.some(s=>s.x===head.x && s.y===head.y)){
        running=false;
        Sound.fx('error');
        if(score>best){
          best=score;
          localStorage.setItem('snakeBest',best);
          toast('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥: '+score);
        }else{
          toast('–°—á—ë—Ç: '+score);
        }
        scores.add(score);
        resetGame();
        draw();
        return;
      }
      snake.unshift(head);
      if(head.x===apple.x && head.y===apple.y){
        score++;
        Sound.fx('coin');
        scoreBoard.set(score,best);
        apple=spawnApple();
      }else{
        snake.pop();
      }
    }
    function draw(){
      ctx.drawImage(bgCanvas,0,0);
      ctx.fillStyle=appleColor;
      ctx.fillRect(apple.x*cellSize, apple.y*cellSize, cellSize, cellSize);
      ctx.fillStyle=snakeColor;
      for(const s of snake){
        ctx.fillRect(s.x*cellSize, s.y*cellSize, cellSize, cellSize);
      }
    }
    function loop(t){
      if(!running) return;
      if(!lastTime) lastTime=t;
      acc+=t-lastTime;
      lastTime=t;
      const interval=Math.max(60,baseInterval-score*5);
      while(acc>=interval){
        acc-=interval;
        update();
      }
      draw();
      requestAnimationFrame(loop);
    }
    function startGame(){
      if(running){
        running=false;
        startBtn.textContent='START';
        return;
      }
      running=true;
      lastTime=0; acc=0;
      startBtn.textContent='PAUSE';
      Sound.fx('start');
      requestAnimationFrame(loop);
    }
    const setBtn=UI.attachDPad(pad,d=>{
      if(d==='up' && dir.y===0) nextDir={x:0,y:-1};
      else if(d==='down' && dir.y===0) nextDir={x:0,y:1};
      else if(d==='left' && dir.x===0) nextDir={x:-1,y:0};
      else if(d==='right' && dir.x===0) nextDir={x:1,y:0};
    });
    document.addEventListener('keydown',e=>{
      const key=e.key.toLowerCase(); let d=null;
      if((key==='arrowup' || key==='w') && dir.y===0){ nextDir={x:0,y:-1}; d='up'; }
      else if((key==='arrowdown' || key==='s') && dir.y===0){ nextDir={x:0,y:1}; d='down'; }
      else if((key==='arrowleft' || key==='a') && dir.x===0){ nextDir={x:-1,y:0}; d='left'; }
      else if((key==='arrowright' || key==='d') && dir.x===0){ nextDir={x:1,y:0}; d='right'; }
      if(d){ e.preventDefault(); setBtn(d,true); if(!running) startGame(); }
    });
    document.addEventListener('keyup',e=>{
      const key=e.key.toLowerCase(); let d=null;
      if(key==='arrowup' || key==='w') d='up';
      else if(key==='arrowdown' || key==='s') d='down';
      else if(key==='arrowleft' || key==='a') d='left';
      else if(key==='arrowright' || key==='d') d='right';
      if(d) setBtn(d,false);
    });
    let touchStartX=0, touchStartY=0;
    canvas.addEventListener('touchstart',e=>{
      const t=e.touches[0];
      touchStartX=t.clientX; touchStartY=t.clientY;
    },{passive:true});
    canvas.addEventListener('touchend',e=>{
      const t=e.changedTouches[0];
      const dx=t.clientX-touchStartX;
      const dy=t.clientY-touchStartY;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>20 && dir.x===0) nextDir={x:1,y:0};
        else if(dx<-20 && dir.x===0) nextDir={x:-1,y:0};
      }else{
        if(dy>20 && dir.y===0) nextDir={x:0,y:1};
        else if(dy<-20 && dir.y===0) nextDir={x:0,y:-1};
      }
    },{passive:true});
    startBtn.addEventListener('click',startGame);
    resetGame();
    draw();
  })();
  </script>
<script type="module" src="src/serve-warning.js"></script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>
