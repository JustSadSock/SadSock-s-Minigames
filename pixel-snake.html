<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Pixel Snake</title>
  <link rel="stylesheet" href="shell.css">
  <style>
    :root{
      --bg0:var(--bg);
      --bg1:var(--bg2);
      --bg2:var(--panel);
      --ink:var(--ink);
      --pastel-pink:var(--accent);
      --pastel-blue:var(--accent2);
      --pastel-mint:var(--hi);
      --pastel-peach:var(--panel);
      --accent:var(--accent2);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      gap:12px;
      color:var(--ink);
    }
    h1{margin:0;font-size:18px;}
    .play{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #gameCanvas{
      image-rendering:pixelated;
      background:var(--bg2);
      border:4px solid var(--pastel-peach);
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
    }
    #score{margin:0;font-size:14px;font-weight:bold;text-shadow:0 1px 0 var(--bg0);}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      display:none;
      color:var(--ink);
    }

    .pad{position:static;margin-top:8px;}

  </style>
</head>
<body>
  <h1>Pixel Snake</h1>
  <div id="score">Счёт: 0</div>
  <input id="colorPick" type="color" title="Цвет змейки" style="width:36px;height:36px;border:none;background:none;padding:0">
  <div class="play">
    <canvas id="gameCanvas" width="120" height="160"></canvas>
    <div id="toast" class="toast"></div>
    <div id="pad" class="pad">
      <div class="dpad">
        <div class="k" data-dir="up" style="grid-area:up">▲</div>
        <div class="k" data-dir="left" style="grid-area:left">◄</div>
        <div class="k" style="grid-area:mid; opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right">►</div>
        <div class="k" data-dir="down" style="grid-area:down">▼</div>
      </div>
      <div class="ab">
        <div class="k" id="startBtn">START</div>
      </div>
    </div>
  </div>
  <script src="ui.js"></script>
  <script src="audio.js"></script>
  <script>
  (function(){
    'use strict';
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled=false;
    let running=false;
    let lastTime=0, acc=0;
    const baseInterval=150;
    const cellSize=5;
    const cols=Math.floor(canvas.width / cellSize);
    const rows=Math.floor(canvas.height / cellSize);
    let snake, dir, nextDir, apple, score, best;
    const scoreEl=document.getElementById('score');
    const startBtn=document.getElementById('startBtn');
    const header=document.querySelector('h1');
    const toastEl=document.getElementById('toast');
    const pad=document.getElementById('pad');
    const colorPick=document.getElementById('colorPick');
    const scoreBoard=UI.score(scoreEl,'Счёт');
    const toast=UI.makeToast(toastEl);
    const styles=getComputedStyle(document.documentElement);
    const bgColor=styles.getPropertyValue('--bg2');
    const appleColor=styles.getPropertyValue('--pastel-peach');
    let snakeColor=localStorage.getItem('snakeColor')||styles.getPropertyValue('--pastel-mint');

    function toHex(col){
      if(col.startsWith('#')) return col.trim();
      const m=col.match(/(\d+),\s*(\d+),\s*(\d+)/);
      return m? '#' + [1,2,3].map(i=>('0'+parseInt(m[i]).toString(16)).slice(-2)).join('') : '#3fbf75';
    }
    colorPick.value=toHex(snakeColor);
    colorPick.addEventListener('input',e=>{
      snakeColor=e.target.value;
      localStorage.setItem('snakeColor',snakeColor);
      draw();
    });

    function resize(){
      const padH=pad.offsetHeight?pad.offsetHeight+16:0;
      const colorH=colorPick.offsetHeight?colorPick.offsetHeight+8:0;
      const availableHeight=window.innerHeight - header.offsetHeight - scoreEl.offsetHeight - colorH - padH - 24;
      const availableWidth=window.innerWidth;
      const ratio=canvas.width/canvas.height;
      let w=availableWidth;
      let h=w/ratio;
      if(h>availableHeight){h=availableHeight; w=h*ratio;}
      canvas.style.width=w+'px';
      canvas.style.height=h+'px';
    }
    window.addEventListener('resize',resize);

    function resetGame(){
      snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
      dir={x:1,y:0};
      nextDir={x:1,y:0};
      apple=spawnApple();
      score=0;
      best=parseInt(localStorage.getItem('snakeBest')||'0',10);
      scoreBoard.set(score,best);
      running=false;
      startBtn.textContent='START';
    }
    function spawnApple(){
      let pos;
      do{
        pos={x:Math.floor(Math.random()*cols),y:Math.floor(Math.random()*rows)};
      }while(snake.some(s=>s.x===pos.x && s.y===pos.y));
      return pos;
    }
    function update(){
      dir=nextDir;
      const head={x:(snake[0].x+dir.x+cols)%cols, y:(snake[0].y+dir.y+rows)%rows};
      if(snake.some(s=>s.x===head.x && s.y===head.y)){
        running=false;
        Sound.fx('error');
        if(score>best){
          best=score;
          localStorage.setItem('snakeBest',best);
          toast('Новый рекорд: '+score);
        }else{
          toast('Счёт: '+score);
        }
        resetGame();
        draw();
        return;
      }
      snake.unshift(head);
      if(head.x===apple.x && head.y===apple.y){
        score++;
        Sound.fx('coin');
        scoreBoard.set(score,best);
        apple=spawnApple();
      }else{
        snake.pop();
      }
    }
    function draw(){
      ctx.fillStyle=bgColor;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=appleColor;
      ctx.fillRect(apple.x*cellSize, apple.y*cellSize, cellSize, cellSize);
      ctx.fillStyle=snakeColor;
      for(const s of snake){
        ctx.fillRect(s.x*cellSize, s.y*cellSize, cellSize, cellSize);
      }
    }
    function loop(t){
      if(!running) return;
      if(!lastTime) lastTime=t;
      acc+=t-lastTime;
      lastTime=t;
      const interval=Math.max(60,baseInterval-score*5);
      while(acc>=interval){
        acc-=interval;
        update();
      }
      draw();
      requestAnimationFrame(loop);
    }
    function startGame(){
      if(running){
        running=false;
        startBtn.textContent='START';
        return;
      }
      running=true;
      lastTime=0; acc=0;
      startBtn.textContent='PAUSE';
      Sound.fx('start');
      requestAnimationFrame(loop);
    }
    const setBtn=UI.attachDPad(pad,d=>{
      if(d==='up' && dir.y===0) nextDir={x:0,y:-1};
      else if(d==='down' && dir.y===0) nextDir={x:0,y:1};
      else if(d==='left' && dir.x===0) nextDir={x:-1,y:0};
      else if(d==='right' && dir.x===0) nextDir={x:1,y:0};
    });
    document.addEventListener('keydown',e=>{
      const key=e.key.toLowerCase(); let d=null;
      if((key==='arrowup' || key==='w') && dir.y===0){ nextDir={x:0,y:-1}; d='up'; }
      else if((key==='arrowdown' || key==='s') && dir.y===0){ nextDir={x:0,y:1}; d='down'; }
      else if((key==='arrowleft' || key==='a') && dir.x===0){ nextDir={x:-1,y:0}; d='left'; }
      else if((key==='arrowright' || key==='d') && dir.x===0){ nextDir={x:1,y:0}; d='right'; }
      if(d) setBtn(d,true);
    });
    document.addEventListener('keyup',e=>{
      const key=e.key.toLowerCase(); let d=null;
      if(key==='arrowup' || key==='w') d='up';
      else if(key==='arrowdown' || key==='s') d='down';
      else if(key==='arrowleft' || key==='a') d='left';
      else if(key==='arrowright' || key==='d') d='right';
      if(d) setBtn(d,false);
    });
    let touchStartX=0, touchStartY=0;
    canvas.addEventListener('touchstart',e=>{
      const t=e.touches[0];
      touchStartX=t.clientX; touchStartY=t.clientY;
    },{passive:true});
    canvas.addEventListener('touchend',e=>{
      const t=e.changedTouches[0];
      const dx=t.clientX-touchStartX;
      const dy=t.clientY-touchStartY;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>20 && dir.x===0) nextDir={x:1,y:0};
        else if(dx<-20 && dir.x===0) nextDir={x:-1,y:0};
      }else{
        if(dy>20 && dir.y===0) nextDir={x:0,y:1};
        else if(dy<-20 && dir.y===0) nextDir={x:0,y:-1};
      }
    },{passive:true});
    startBtn.addEventListener('click',startGame);
    resize();
    resetGame();
    draw();
  })();
  </script>
</body>
</html>
