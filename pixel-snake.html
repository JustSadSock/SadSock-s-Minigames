<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Pixel Snake</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      /* палитра как у music box */
      --bg0:#fff4cf;
      --bg1:#f6e7c0;
      --bg2:#f2dba9;
      --ink:#3a2c1b;
      --pastel-pink:#e6a84a;
      --pastel-blue:#d79031;
      --pastel-mint:#e7c888;
      --pastel-peach:#ffe6a6;
      --accent:#d79031;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      background:var(--bg0);
      gap:12px;
      font-family:'Press Start 2P',ui-monospace,monospace;
      color:var(--ink);
    }
    h1{margin:0;font-size:18px;}
    .play{
      flex:1;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #gameCanvas{
      image-rendering:pixelated;
      background:var(--bg2);
      border:4px solid var(--pastel-peach);
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
    }
    #score{margin:0;font-size:14px;}
    #controls{display:flex;gap:12px;}
    button{
      padding:8px 12px;
      font-size:14px;
      background:var(--pastel-peach);
      border:1px solid var(--accent);
      border-radius:8px;
      color:var(--ink);
      cursor:pointer;
      box-shadow:0 2px 0 rgba(255,255,255,0.6) inset;
    }
    button:active{transform:translateY(1px);}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      display:none;
      color:var(--ink);
    }
    .pad{
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
      display:grid; grid-template-columns:repeat(3,40px); grid-template-rows:repeat(3,40px); gap:6px;
    }
    .pad button{width:40px;height:40px;padding:0;}
    .pad button[data-dir="up"]{grid-column:2;}
    .pad button[data-dir="left"]{grid-row:2;grid-column:1;}
    .pad button[data-dir="down"]{grid-row:3;grid-column:2;}
    .pad button[data-dir="right"]{grid-row:2;grid-column:3;}
    @media (min-width:600px){.pad{display:none;}}
  </style>
</head>
<body>
  <h1>Pixel Snake</h1>
  <div id="score">Счёт: 0</div>
  <div id="controls">
    <button id="startBtn">Старт</button>
    <button id="resetBtn">Сброс</button>
    <button id="exitBtn">Выход</button>
  </div>
  <div class="play">
    <canvas id="gameCanvas" width="120" height="160"></canvas>
    <div id="toast" class="toast"></div>
    <div id="pad" class="pad">
      <button data-dir="up">▲</button>
      <button data-dir="left">◄</button>
      <button data-dir="down">▼</button>
      <button data-dir="right">►</button>
    </div>
  </div>
  <script>
  (function(){
    'use strict';
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled=false;
    let gameInterval=null;
    const cellSize=5;
    const cols=Math.floor(canvas.width / cellSize);
    const rows=Math.floor(canvas.height / cellSize);
    let snake, dir, nextDir, apple, score;
    const scoreEl=document.getElementById('score');
    const startBtn=document.getElementById('startBtn');
    const resetBtn=document.getElementById('resetBtn');
    const header=document.querySelector('h1');
    const controls=document.getElementById('controls');
    const toastEl=document.getElementById('toast');
    const exitBtn=document.getElementById('exitBtn');
    const pad=document.getElementById('pad');

    function toast(text){
      toastEl.textContent=text;
      toastEl.style.display='block';
      setTimeout(()=> toastEl.style.display='none',2000);
    }
    exitBtn.onclick=()=>{window.top.location.href='index.html';};

    function resize(){
      const availableHeight=window.innerHeight - header.offsetHeight - scoreEl.offsetHeight - controls.offsetHeight - 36;
      const availableWidth=window.innerWidth;
      const ratio=canvas.width/canvas.height;
      let w=availableWidth;
      let h=w/ratio;
      if(h>availableHeight){h=availableHeight; w=h*ratio;}
      canvas.style.width=w+'px';
      canvas.style.height=h+'px';
    }
    window.addEventListener('resize',resize);

    function resetGame(){
      snake=[{x:Math.floor(cols/2), y:Math.floor(rows/2)}];
      dir={x:1,y:0};
      nextDir={x:1,y:0};
      apple=spawnApple();
      score=0;
      scoreEl.textContent='Счёт: '+score;
      clearInterval(gameInterval);
      gameInterval=null;
    }
    function spawnApple(){
      let pos;
      do{
        pos={x:Math.floor(Math.random()*cols),y:Math.floor(Math.random()*rows)};
      }while(snake.some(s=>s.x===pos.x && s.y===pos.y));
      return pos;
    }
    function update(){
      dir=nextDir;
      const head={x:(snake[0].x+dir.x+cols)%cols, y:(snake[0].y+dir.y+rows)%rows};
      if(snake.some(s=>s.x===head.x && s.y===head.y)){
        clearInterval(gameInterval);
        gameInterval=null;
        toast('Счёт: '+score);
        resetGame();
        draw();
        return;
      }
      snake.unshift(head);
      if(head.x===apple.x && head.y===apple.y){
        score++;
        scoreEl.textContent='Счёт: '+score;
        apple=spawnApple();
      }else{
        snake.pop();
      }
      draw();
    }
    function draw(){
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg2');
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--pastel-peach');
      ctx.fillRect(apple.x*cellSize, apple.y*cellSize, cellSize, cellSize);
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--pastel-mint');
      for(const s of snake){
        ctx.fillRect(s.x*cellSize, s.y*cellSize, cellSize, cellSize);
      }
    }
    function startGame(){
      if(gameInterval) return;
      gameInterval=setInterval(update,150);
    }
    document.addEventListener('keydown',e=>{
      const key=e.key.toLowerCase();
      if((key==='arrowup' || key==='w') && dir.y===0) nextDir={x:0,y:-1};
      else if((key==='arrowdown' || key==='s') && dir.y===0) nextDir={x:0,y:1};
      else if((key==='arrowleft' || key==='a') && dir.x===0) nextDir={x:-1,y:0};
      else if((key==='arrowright' || key==='d') && dir.x===0) nextDir={x:1,y:0};
    });
    pad.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('touchstart',e=>{
        e.preventDefault();
        const d=btn.dataset.dir;
        if(d==='up' && dir.y===0) nextDir={x:0,y:-1};
        else if(d==='down' && dir.y===0) nextDir={x:0,y:1};
        else if(d==='left' && dir.x===0) nextDir={x:-1,y:0};
        else if(d==='right' && dir.x===0) nextDir={x:1,y:0};
      },{passive:false});
    });
    let touchStartX=0, touchStartY=0;
    canvas.addEventListener('touchstart',e=>{
      const t=e.touches[0];
      touchStartX=t.clientX; touchStartY=t.clientY;
    },{passive:true});
    canvas.addEventListener('touchend',e=>{
      const t=e.changedTouches[0];
      const dx=t.clientX-touchStartX;
      const dy=t.clientY-touchStartY;
      if(Math.abs(dx)>Math.abs(dy)){
        if(dx>20 && dir.x===0) nextDir={x:1,y:0};
        else if(dx<-20 && dir.x===0) nextDir={x:-1,y:0};
      }else{
        if(dy>20 && dir.y===0) nextDir={x:0,y:1};
        else if(dy<-20 && dir.y===0) nextDir={x:0,y:-1};
      }
    },{passive:true});
    startBtn.addEventListener('click',startGame);
    resetBtn.addEventListener('click',()=>{
      resetGame();
      draw();
    });
    resize();
    resetGame();
    draw();
  })();
  </script>
</body>
</html>
