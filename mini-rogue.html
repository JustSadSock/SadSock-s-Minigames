<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title data-i18n="miniRogue"></title>
<link rel="stylesheet" href="styles/shell.css">
</head>
<body>
<div class="cabinet">
  <div class="frame">
    <div class="inner">
      <div class="hud">
      <div class="counter" id="score">0</div>
      <button class="pill" id="scoresBtn" data-i18n-aria-label="records">üèÜ</button>
      <div class="counter" id="status">‚Äî</div>
      </div>
      <canvas id="cv" tabindex="0" data-i18n-aria-label="gameField"></canvas>
      <div class="scanlines"></div>
    </div>
    <div class="pad" id="pad">
      <div class="dpad">
        <div class="k" data-btn="up" style="grid-area:up"></div>
        <div class="k" data-btn="left" style="grid-area:left"></div>
        <div class="k" style="grid-area:mid; opacity:.35"></div>
        <div class="k" data-btn="right" style="grid-area:right"></div>
        <div class="k" data-btn="down" style="grid-area:down"></div>
      </div>
    </div>
    <div class="label" data-i18n="miniRogue"></div>
    <div class="hint" data-i18n="miniRogueHint"></div>
  </div>
  <div class="footer" data-i18n="miniRogueFooter"></div>
</div>

<script src="src/ui.js"></script>
<script src="src/audio.js"></script>
<script src="src/scores.js"></script>
<script type="module">
import('./src/i18n.js').catch(e=>{
  console.error('i18n failed',e);
  if(window.UI&&UI.alert) UI.alert('Localization failed');
  return {t:(s)=>s};
}).then(({t})=>{
(() => {
  const SETTINGS = { W:360, H:640, sfx:0.6 };
  const d = (s)=>document.querySelector(s);
  const scoreEl=d('#score'), statusEl=d('#status'), cv=d('#cv'), pad=d('#pad');
  const scores=Scores('rogue');
  d('#scoresBtn').onclick=scores.show;
  const scoreBoard=UI.score(scoreEl,t('score'),t('best'));
  const ctx=cv.getContext('2d');
  function resize(){ const pr=Math.max(1,Math.floor(devicePixelRatio||1));
    const r=cv.getBoundingClientRect(); cv.width=Math.floor(r.width*pr); cv.height=Math.floor(r.height*pr);
  }
  function clear(){ ctx.fillStyle='#f4e3c1'; ctx.fillRect(0,0,cv.width,cv.height);
    ctx.save(); ctx.globalAlpha=.07; const s=8; ctx.fillStyle='#b09060';
    for(let y=0;y<cv.height;y+=s*2) ctx.fillRect(0,y,cv.width,s);
    ctx.restore();
  }
  window.addEventListener('resize',resize);

  // Input
  const Input = (()=>{
    const st={left:false,right:false,up:false,down:false,a:false,b:false};
    const map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down',' ':'a',Enter:'b',a:'a',A:'a',z:'b',Z:'b',w:'up',W:'up',s:'down',S:'down',d:'right',D:'right'};
    const set=(btn,val)=>{ st[btn]=val; const el=pad.querySelector(`[data-btn="${btn}"]`); if(el) el.classList.toggle('down',val); };
    addEventListener('keydown',e=>{const b=map[e.key]; if(b){set(b,true); e.preventDefault();}});
    addEventListener('keyup',e=>{const b=map[e.key]; if(b){set(b,false); e.preventDefault();}});
    pad.querySelectorAll('[data-btn]').forEach(el=>{
      const btn=el.dataset.btn;
      const on=(e)=>{set(btn,true); e.preventDefault();};
      const off=(e)=>{set(btn,false); e.preventDefault();};
      el.addEventListener('touchstart',on,{passive:false});
      el.addEventListener('touchend',off,{passive:false});
      el.addEventListener('touchcancel',off,{passive:false});
      el.addEventListener('mousedown',on);
      addEventListener('mouseup',off);
      el.addEventListener('mouseleave',off);
    });
    UI.autoHidePad(pad);
    return {st};
  })();

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const irnd=(a,b)=>Math.floor(rnd(a,b+1));

  const COLORS={'1':'#3a2a18','2':'#a8d7ff'};
  const HERO=[
    " 1 ",
    "111",
    "111",
    "1 1",
    "1 1"
  ];
  const ENEMY=[
    "222",
    "2 2",
    "222",
    "2 2",
    "222"
  ];
  function drawSprite(pat,x,y,tile){
    const s=tile/pat[0].length;
    pat.forEach((row,j)=>row.split('').forEach((ch,i)=>{
      if(ch!==' '){ctx.fillStyle=COLORS[ch];ctx.fillRect(x+i*s,y+j*s,s,s);} }));
  }

  // ===== Game specific code =====
  
  const game = {
    score:0, started:true, over:false,
    init(){
      this._onKey = e=>this.onKey(e);
      addEventListener('keydown', this._onKey);
      this.reset();
    },
    destroy(){ removeEventListener('keydown', this._onKey); },
    reset(){ this.score=0; this.over=false; Sound.fx('start'); recorded=false;
      this.N=16; this.map=this.gen(); this.p=this.find('.'); this.hp=3; this.lvl=1;
      this.en=[]; for(let i=0;i<3;i++) this.en.push(this.randWalk());
      this.ch=[]; for(let i=0;i<3;i++) this.ch.push(this.randUnique());
      this.exit=this.randUnique();
    },
    onKey(e){
      if(this.over){ if(e.key==='Enter'||e.key===' ') this.reset(); return; }
      if(e.key==='ArrowLeft'||e.key==='a') this.move(-1,0);
      if(e.key==='ArrowRight'||e.key==='d') this.move(1,0);
      if(e.key==='ArrowUp'||e.key==='w') this.move(0,-1);
      if(e.key==='ArrowDown'||e.key==='s') this.move(0,1);
      if(e.key===' '||e.key==='f') this.attack();
    },
    cell(x,y){ return this.map[y]?.[x]; },
    gen(){ const N=this.N; let m; let reachable=0; const target=Math.floor(N*N*.42);
      function carveMap(){ m=Array.from({length:N},()=>Array(N).fill('#')); let x=irnd(1,N-2), y=irnd(1,N-2), open=0, tries=0; const carve=(x,y)=>{ if(m[y][x]==='#'){ m[y][x]='.'; open++; } }; carve(x,y); while(open<target && tries<5000){ const d=[[1,0],[-1,0],[0,1],[0,-1]][irnd(0,3)]; x=clamp(x+d[0],1,N-2); y=clamp(y+d[1],1,N-2); carve(x,y); tries++; } for(let i=0;i<N;i++){ m[0][i]='#'; m[N-1][i]='#'; m[i][0]='#'; m[i][N-1]='#'; }}
      function countReachable(){ const q=[[1,1]]; const vis=Array.from({length:N},()=>Array(N).fill(false)); vis[1][1]=true; let c=0; while(q.length){ const [x,y]=q.shift(); if(m[y][x]==='.'){ c++; [[1,0],[-1,0],[0,1],[0,-1]].forEach(d=>{const nx=x+d[0],ny=y+d[1]; if(nx>0&&ny>0&&nx<N-1&&ny<N-1&&!vis[ny][nx]&&m[ny][nx]==='.'){vis[ny][nx]=true; q.push([nx,ny]);}}); } } return c; }
      let attempts=0; do{ carveMap(); reachable=countReachable(); attempts++; }while(reachable<target*0.8 && attempts<20);
      return m;
    },
    find(sym){ for(let y=0;y<this.N;y++) for(let x=0;x<this.N;x++) if(this.map[y][x]===sym) return {x,y}; return {x:1,y:1}; },
    randWalk(){ let p; do{ p={x:irnd(1,this.N-2),y:irnd(1,this.N-2)} }while(this.cell(p.x,p.y)!=='.'); return p; },
    randUnique(){ let p; do{ p=this.randWalk(); }while((this.p && p.x===this.p.x&&p.y===this.p.y)||this.ch?.some(c=>c.x===p.x&&c.y===p.y)||this.en?.some(e=>e.x===p.x&&e.y===p.y)||(this.exit && p.x===this.exit.x&&p.y===this.exit.y)); return p; },
    move(dx,dy){ const nx=this.p.x+dx, ny=this.p.y+dy; if(this.cell(nx,ny)!=='.') return; this.p.x=nx; this.p.y=ny;
      const i=this.ch.findIndex(c=>c.x===nx&&c.y===ny); if(i>=0){ this.ch.splice(i,1); this.score+=50; Sound.fx('coin'); }
      if(this.exit.x===nx&&this.exit.y===ny){ this.lvl++; this.map=this.gen(); this.p=this.find('.'); this.en=[]; for(let i=0;i<3+Math.min(3,this.lvl);i++) this.en.push(this.randWalk()); this.ch=[]; for(let i=0;i<3;i++) this.ch.push(this.randUnique()); this.exit=this.randUnique(); this.score+=100; Sound.fx('coin'); }
      for(const e of this.en){ let ex=e.x, ey=e.y; if(Math.random()<.6){ const ddx=Math.sign(this.p.x-ex), ddy=Math.sign(this.p.y-ey);
          if(Math.random()<.5 && this.cell(ex+ddx,ey)==='.') ex+=ddx; else if(this.cell(ex,ey+ddy)==='.') ey+=ddy;
        } else { const d=[[1,0],[-1,0],[0,1],[0,-1]][irnd(0,3)]; if(this.cell(ex+d[0],ey+d[1])==='.'){{ ex+=d[0]; ey+=d[1]; }}}
        e.x=ex; e.y=ey; if(e.x===this.p.x && e.y===this.p.y){ this.hp--; Sound.fx('error'); if(this.hp<=0) this.over=true; }
      }
    },
    attack(){
      const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      for(const d of dirs){
        const tx=this.p.x+d[0], ty=this.p.y+d[1];
        const i=this.en.findIndex(e=>e.x===tx&&e.y===ty);
        if(i>=0){ this.en.splice(i,1); this.score+=30; Sound.fx('coin'); break; }
      }
    },
    step(dt){},
    draw(){
      ctx.save(); const sx=cv.width/SETTINGS.W, sy=cv.height/SETTINGS.H; ctx.scale(sx,sy);
      const N=this.N, tile=Math.floor(Math.min(SETTINGS.W,SETTINGS.H)*.8/N);
      const ox=Math.floor((SETTINGS.W-tile*N)/2), oy=Math.floor((SETTINGS.H-tile*N)/2);
      for(let y=0;y<N;y++) for(let x=0;x<N;x++){ ctx.fillStyle=(this.map[y][x]==='#')?'#edd7b0':'#faedd3'; ctx.fillRect(ox+x*tile, oy+y*tile, tile-1, tile-1); }
      ctx.fillStyle='#e6a64c'; for(const c of this.ch) ctx.fillRect(ox+c.x*tile+3, oy+c.y*tile+3, tile-6, tile-6);
      ctx.fillStyle='#3fbf75'; ctx.fillRect(ox+this.exit.x*tile+5, oy+this.exit.y*tile+5, tile-10, tile-10);
      for(const e of this.en) drawSprite(ENEMY, ox+e.x*tile, oy+e.y*tile, tile);
      drawSprite(HERO, ox+this.p.x*tile, oy+this.p.y*tile, tile);
      ctx.font='14px "Press Start 2P"';
      ctx.textAlign='left'; ctx.fillStyle='#bf3030';
      ctx.fillText('‚ù§'.repeat(this.hp), 10, oy-12);
      ctx.textAlign='right'; ctx.fillStyle='#bf8a3d';
      ctx.fillText(`Lvl:${this.lvl}`, SETTINGS.W-10, oy-12);
      ctx.textAlign='center';
      if(this.over) ctx.fillText(t('rogueGameOver'), SETTINGS.W/2, SETTINGS.H*0.5);
      ctx.restore();
    }
  };
  let last=performance.now(), recorded=false;
  function loop(){ requestAnimationFrame(loop); resize(); clear(); const t=performance.now(), dt=Math.min(.033,(t-last)/1000); last=t;
    game.step(dt); if(game.over && !recorded){ scores.add(game.score); recorded=true; }
    game.draw(); scoreBoard.set(game.score|0); }
  game.init();
  addEventListener('beforeunload',()=>game.destroy());
  loop();

})();
});
</script>
</body>
</html>
