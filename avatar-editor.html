<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title data-i18n="avatarEditor"></title>
<link rel="stylesheet" href="styles/shell.css">
<style>
  :root{
    --panel:var(--tile-bg);
    --paper:var(--tile-bg);
    --shadow:var(--bezel-lo);
    --btn-bg:var(--tile-bg);
    --btn-ink:var(--ink);
    --btn-shadow:var(--shadow);
    --tab-bg:var(--tile-bg);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:transparent;color:var(--ink);font-family:'Press Start 2P',ui-monospace,monospace}
  input,select,textarea{font:inherit}
  .editor{
    width:min(440px,100%);padding:8px;background:linear-gradient(var(--bg2),var(--bg1));
    border:4px solid var(--bezel);border-radius:16px;
    box-shadow:inset 0 0 0 6px var(--bezel),0 6px 14px rgba(0,0,0,.12);
    display:flex;flex-direction:column;height:100%;
  }
  .stage{
    position:relative;display:grid;place-items:center;background:var(--tile-bg);border-radius:12px;
    box-shadow:inset 0 0 0 3px var(--bezel-hi);width:100%;max-width:160px;aspect-ratio:1/1;margin:0 auto 8px
  }
  /* растягиваем 16×16 без мыла */
  .stage canvas{width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
  .gesture{position:absolute;inset:0}
  .panels{background:var(--panel);border-radius:12px;box-shadow:inset 0 0 0 3px var(--bezel-hi),0 4px 12px rgba(0,0,0,.08);flex:1;overflow:auto;min-height:0}

  /* ТРИ СТРОКИ вкладок. Никакого скролла. */
  .tabs{
    display:grid;
    grid-template-rows: repeat(3, auto);
    grid-auto-flow: column;      /* раскладываем по столбцам, автоматически вниз по 3 строки */
    gap:6px;
    padding:6px;
    border-bottom:3px solid var(--bezel);
    overflow: hidden;
  }
  .tab{
    font-size:12px; line-height:1; white-space:nowrap;
    min-width:96px;               /* чтобы текст вкладок не обрезался */
  }
  .panel{display:none;padding:10px}
  .panel.active{display:block}

  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:var(--paper);border-radius:10px;padding:8px;box-shadow:inset 0 0 0 2px var(--bezel-hi),0 2px 0 var(--shadow)}
  .badge{font-size:11px;background:var(--paper);border-radius:8px;padding:2px 6px}
  .cols{display:grid;grid-auto-flow:column;grid-auto-columns:26px;gap:8px;overflow:auto}
  .sw{width:26px;height:26px;border-radius:7px;border:2px solid var(--bezel);box-shadow:inset 0 1px 0 rgba(255,255,255,.4);cursor:pointer}
  .sw.sel{outline:2px solid var(--accent)}
  @media (max-width:360px){
    .editor{padding:6px;border-width:3px}
    .tab{min-width:78px;font-size:11.5px}
  }
  @media (max-height:600px){
    .stage{max-width:120px}
  }
  .toast{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:var(--pastel-pink);
    border:2px solid var(--accent);
    border-radius:8px;
    padding:8px 12px;
    font-size:14px;
    color:var(--ink);
  }
</style>
<script type="module" src="src/pixel-widgets.js"></script>
<script src="src/ui.js"></script>
</head>
<body>
<div class="cabinet">
  <div class="frame">
    <div class="inner" style="display:flex;align-items:center;justify-content:center;">
      <div class="editor">
  <div class="stage">
    <canvas id="cv" tabindex="0" aria-label="Редактор аватара"></canvas>
    <div class="gesture" id="gesture"></div>
  </div>

  <div class="panels">
    <nav class="tabs" id="tabs"></nav>
    <div id="panels"></div>
  </div>
  <div class="row" style="margin-top:8px; gap:8px;">
    <button id="previewBtn" class="btn" data-i18n="preview" title="Preview">▶ Preview</button>
    <button id="randomBtn" class="btn" data-i18n="random" title="Random">Random</button>
    <pixel-input style="flex:1;"><input id="nick" type="text" placeholder="Ник"></pixel-input>
    <button id="saveBtn" class="btn" data-i18n="ok">OK</button>
    <button id="dlBtn" class="btn" title="Скачать PNG">⬇️</button>
    <button id="exportJson" class="btn" data-i18n="exportJson" title="Export JSON">Export JSON</button>
    <button id="importJson" class="btn" data-i18n="importJson" title="Import JSON">Import JSON</button>
  </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* ===== base ===== */
const S=16, cv=document.getElementById('cv'), ctx=cv.getContext('2d',{alpha:true});
cv.width=cv.height=S;
ctx.imageSmoothingEnabled=false;
const dom={tabs:document.getElementById('tabs'), panels:document.getElementById('panels'), gesture:document.getElementById('gesture')};
const toast=UI.makeToast(document.getElementById('toast'));

/* offscreen: вся отрисовка здесь */
const off=document.createElement('canvas'); off.width=off.height=S;
const octx=off.getContext('2d',{alpha:true}); octx.imageSmoothingEnabled=false;
let DC=octx;

/* ===== palettes ===== */
const PAL={
  skin:['#f3d9bf','#e1b68f','#c59c7b','#a67f5f','#8b694e','#6b5142'],
  hair:['#2d2015','#4a2e18','#5e3b1d','#7a4b2a','#9b5f36','#c47a48'],
  eye :['#1b1b1b','#2f4f8d','#2e6b5a','#6b3b2e'],
  lip :['#5a2d2a','#9b4a4a','#e07878'],
  glass:['#111','#444','#777','#bbb'],
  hat :['#333','#6a3d18','#a76a2e','#ddb65a'],
  acc :['#151515','#a0a0a0','#ddb65a','#d34b4b'],
  bg  :['#0000','#f0e5c8','#efe6dd','#e9d3a5']
};

/* ===== tabs ===== */
const CATS=[
  {k:'bg',n:'Фон',count:4,color:'bg'},
  {k:'head',n:'Голова',count:3,color:'skin'},
  {k:'eyes',n:'Глаза',count:6,color:'eye'},
  {k:'brows',n:'Брови',count:4,color:'hair'},
  {k:'nose',n:'Нос',count:5,color:null},
  {k:'mouth',n:'Рот',count:5,color:'lip'},
  {k:'hair',n:'Волосы',count:6,color:'hair'},
  {k:'facial',n:'Усы',count:4,color:'hair'},
  {k:'glasses',n:'Очки',count:4,color:'glass'},
  {k:'hat',n:'Шапка',count:5,color:'hat'},
  {k:'acc',n:'Аксессуар',count:5,color:'acc'},
];
const COLOR_PROP={head:'skin',eyes:'eye',brows:'hair',mouth:'lip',hair:'hair',facial:'hair',glasses:'glass',hat:'hat',acc:'acc',bg:'bgColor'};
const COLOR_LABEL_KEY={skin:'skinColor',hair:'hairColor',eye:'eyeColor',lip:'lipColor',glass:'glassColor',hat:'hatColor',acc:'accColor',bg:'bgColorLabel'};
const COLOR_LABEL_FALLBACK={skin:'Цвет кожи',hair:'Цвет волос',eye:'Цвет глаз',lip:'Цвет губ',glass:'Цвет оправы',hat:'Цвет шапки',acc:'Цвет аксессуара',bg:'Цвет фона'};

/* ===== state ===== */
const INIT={
  bg:1, bgColor:'#f0e5c8',
  head:0, eyes:1, brows:1, nose:2, mouth:2, hair:2, facial:0, glasses:0, hat:0, acc:0,
  skin:'#e1b68f', eye:'#2f4f8d', hair:'#5e3b1d', lip:'#9b4a4a', glass:'#444', hat:'#a76a2e', acc:'#a0a0a0'
};
let state = JSON.parse(localStorage.getItem('ss16_avatar_simple')||'null') || {...INIT};
let active = 'head';

/* ===== draw utils (всегда в DC=off) ===== */
function px(x,y,c){DC.fillStyle=c;DC.fillRect(x,y,1,1)}
function r(x,y,w,h,c){DC.fillStyle=c;DC.fillRect(x,y,w,h)}
function sh(hex,amt){const c=parseInt(hex.slice(1),16),R=(c>>16)&255,G=(c>>8)&255,B=c&255,cl=v=>Math.max(0,Math.min(255,v));
  return `rgb(${cl(R+amt)},${cl(G+amt)},${cl(B+amt)})`}

/* ===== parts ===== */
const BGs=[
  (c)=>{}, // transparent
  (c)=>{ r(0,0,16,16,c); },
  (c)=>{ r(0,0,16,16,c); for(let y=0;y<16;y+=4) r(0,y,16,1,sh(c,-20)); },
  (c)=>{ r(0,0,16,16,c); for(let x=0;x<16;x+=4) r(x,0,1,16,sh(c,-18)); },
];
const Heads=[ (c)=>{ r(4,3,8,8,c); px(3,6,c); px(12,6,c); r(5,11,6,2,c); },
              (c)=>{ r(4,2,8,9,c); px(3,5,c); px(12,5,c); r(5,11,6,2,c); },
              (c)=>{ r(4,3,8,7,c); r(5,10,6,3,c); px(3,6,c); px(12,6,c); } ];
const Eyes=[ (c)=>{ px(6,7,c); px(9,7,c); },
            (c)=>{ r(5,7,2,1,c); r(9,7,2,1,c); },
            (c)=>{ r(5,7,2,2,'#fff'); r(9,7,2,2,'#fff'); px(6,8,c); px(10,8,c); },
            (c)=>{ r(5,7,3,1,c); r(8,7,3,1,c); },
            (c)=>{ r(5,6,2,1,c); r(9,6,2,1,c); px(6,8,c); px(10,8,c); },
            (c)=>{ r(5,6,2,2,'#fff'); r(9,6,2,2,'#fff'); r(6,7,1,1,c); r(10,7,1,1,c); } ];
const Brows=[ (c)=>{ r(5,5,2,1,c); r(9,5,2,1,c); },
             (c)=>{ r(5,5,3,1,c); r(8,5,3,1,c); },
             (c)=>{ r(5,5,2,1,c); r(9,6,2,1,c); },
             (c)=>{ r(5,6,2,1,c); r(9,5,2,1,c); } ];
const Noses=[ ()=>{ px(7,8,'#6b5947'); },
             ()=>{ r(7,8,2,1,'#6b5947'); },
             ()=>{ px(7,8,'#6b5947'); px(7,9,'#6b5947'); },
             ()=>{ r(7,8,1,2,'#6b5947'); px(8,9,'#6b5947'); },
             ()=>{ r(7,8,2,1,'#6b5947'); px(8,9,'#6b5947'); } ];
const Mouths=[ (c)=>{ r(6,11,4,1,c); },
              (c)=>{ r(5,11,6,1,c); },
              (c)=>{ r(6,11,4,1,c); px(7,12,sh(c,30)); px(8,12,sh(c,30)); },
              (c)=>{ r(6,11,4,2,c); },
              (c)=>{ r(6,12,4,1,c); } ];

/* Волосы: under/over (восстановлены варианты) */
const Hair=[
  {under:(c)=>{}, over:(c)=>{ r(4,2,8,2,c); r(3,4,10,2,c); }},                              // челка
  {under:(c)=>{ r(3,4,10,4,c); r(3,8,1,4,c); r(12,8,1,4,c); }, over:(c)=>{ r(4,2,8,2,c); }},// боб
  {under:(c)=>{ r(3,3,10,6,c); }, over:(c)=>{ r(4,2,8,2,c); }},                             // шапка волос
  {under:(c)=>{ r(2,6,2,6,c); r(12,6,2,6,c); }, over:(c)=>{ r(4,3,8,1,c); }},               // хвостики
  {under:(c)=>{}, over:(c)=>{}},                                                             // лысый
  {under:(c)=>{ for(let y=3;y<9;y+=2)for(let x=3;x<13;x+=2) px(x,y,c); }, over:(c)=>{ r(4,2,8,1,c); }}, // кудри
];

/* Усы/борода: поправил координаты (усы выше рта, борода — ниже) */
const Facial=[
  ()=>{},                                                     // нет
  (c)=>{ r(6,10,4,1,c); },                                    // тонкие усы над ртом
  (c)=>{ r(5,10,6,2,c); px(8,13,c); },                        // густые усы + маленький «якорь»
  (c)=>{ r(5,12,6,3,c); },                                    // борода (не накрывает рот)
];

/* Очки */
const Glass=[
  ()=>{},
  (c)=>{ r(4,6,3,3,c); r(9,6,3,3,c); r(7,7,2,1,c); },         // прямоугольные
  (c)=>{ r(4,6,2,2,c); r(10,6,2,2,c); r(7,7,2,1,c); },        // маленькие
  (c)=>{ r(4,6,4,3,c); r(8,6,4,3,c); },                       // маска
];

/* Шапки (hats) — возвращены и видны */
const Hats=[
  ()=>{},
  (c)=>{ r(3,1,10,2,c); },                                    // бини
  (c)=>{ r(2,2,12,2,c); r(1,4,14,1,c); },                     // кепка
  (c)=>{ r(2,1,12,2,c); r(1,3,14,1,c); },                     // шляпа
  (c)=>{ r(4,0,8,2,c); r(3,2,10,1,sh(c,-20)); },              // корона
];

/* Аксессуары — уши/шрам/наклейки */
const Acc=[
  ()=>{},
  (c)=>{ px(3,9,c); },                                        // серьга слева
  (c)=>{ px(12,9,c); },                                       // серьга справа
  (c)=>{ r(5,9,6,1,c); },                                     // шрам
  (c)=>{ px(6,10,c); px(9,10,c); },                           // точки/родинки
];

/* ===== animation + render ===== */
let bob=0, blinkTimer=0, blinkDur=0;
function render(){
  DC=octx;
  octx.clearRect(0,0,S,S);

  /* фон */
  BGs[state.bg]?.(state.bgColor);

  /* базовая форма */
  Heads[state.head]?.(state.skin);
  r(3,7,1,3,state.skin); r(12,7,1,3,state.skin); // уши

  /* глаза (с миганием) */
  const blink = blinkDur>0;
  if(blink){ r(5,7,2,1,state.eye); r(9,7,2,1,state.eye); }
  else{ Eyes[state.eyes]?.(state.eye); }

  /* брови/нос/рот */
  Brows[state.brows]?.(state.hair);
  Noses[state.nose]?.();
  Mouths[state.mouth]?.(state.lip);

  /* волосы под / усы / волосы над */
  Hair[state.hair]?.under?.(state.hair);
  Facial[state.facial]?.(state.hair);
  Hair[state.hair]?.over?.(state.hair);

  /* очки / шапка / аксессуар */
  Glass[state.glasses]?.(state.glass);
  Hats[state.hat]?.(state.hat);
  Acc[state.acc]?.(state.acc);

  /* idle bob + blink */
  bob=(bob+1)%120; const dy=(bob<60)?0:1;
  if(blinkTimer<=0){ blinkTimer=120+Math.floor(Math.random()*180); blinkDur=0; }
  else{ blinkTimer--; blinkDur = blinkTimer<6 ? blinkTimer : 0; }

  ctx.clearRect(0,0,S,S);
  ctx.drawImage(off,0,dy);
}

/* ===== UI ===== */
function buildUI(){
  dom.tabs.innerHTML=''; dom.panels.innerHTML='';
  CATS.forEach(cat=>{
    const b=document.createElement('button');
    b.className='tab'; b.textContent=cat.n; b.dataset.k=cat.k; b.title=cat.n;
    if(cat.k===active) b.setAttribute('aria-selected','true');
    b.onclick=()=>{ active=cat.k; document.querySelectorAll('.tab').forEach(x=>x.removeAttribute('aria-selected')); b.setAttribute('aria-selected','true'); openPanel(cat.k); };
    dom.tabs.appendChild(b);

    const p=document.createElement('div'); p.id='p-'+cat.k; p.className='panel';
    dom.panels.appendChild(p);
  });
  openPanel(active);
}

function openPanel(k){
  document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
  const cat=CATS.find(x=>x.k===k);
  const el=document.getElementById('p-'+k); el.classList.add('active'); el.innerHTML='';

  /* навигация вариантов */
  const nav=document.createElement('div'); nav.className='row card';
  const prev=btn('←',()=>change(k,-1)); const next=btn('→',()=>change(k,1));
  const cnt=document.createElement('span'); cnt.className='badge'; cnt.textContent=indexStr(k,cat.count);
  nav.append(prev,cnt,next);

  /* палитра (если есть) */
  const colors=document.createElement('div'); colors.className='row card';
  if(cat.color){
    const cols=document.createElement('div'); cols.className='cols';
    const prop = COLOR_PROP[k];
    PAL[cat.color].forEach(c=>{
      const sw=document.createElement('div'); sw.className='sw'; sw.style.background=c;
      const cur = (prop==='bgColor' ? state.bgColor : state[prop]);
      if(cur===c) sw.classList.add('sel');
      sw.onclick=()=>{ if(prop==='bgColor') state.bgColor=c; else state[prop]=c; save(); render(); openPanel(k); };
      cols.appendChild(sw);
    });
    const lbl=document.createElement('span'); lbl.className='badge';
    lbl.textContent=COLOR_LABEL_FALLBACK[cat.color];
    const key=COLOR_LABEL_KEY[cat.color];
    if(key){ lbl.dataset.i18n=key; if(window.i18n) i18n.applyTranslations(lbl); }
    colors.append(lbl,cols);
  }else{
    colors.textContent='Цвет не меняется';
  }
  el.append(nav, colors);
}

function btn(t,fn){const b=document.createElement('button'); b.className='btn'; b.textContent=t; b.onclick=fn; return b;}
function indexStr(k,total){return ((state[k]??0)+1)+' / '+total}

/* ===== actions ===== */
function change(k,step){
  const cat=CATS.find(x=>x.k===k);
  let v=state[k]??0; v=((v+step)%cat.count+cat.count)%cat.count; state[k]=v; save(); render(); openPanel(k);
}
function save(){ localStorage.setItem('ss16_avatar_simple', JSON.stringify(state)); }

/* ===== gestures (swipe) ===== */
(()=>{ let sx=0, moved=false;
  dom.gesture.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;moved=false;},{passive:true});
  dom.gesture.addEventListener('touchmove',e=>{ if(Math.abs(e.touches[0].clientX-sx)>20) moved=true; },{passive:true});
  dom.gesture.addEventListener('touchend',e=>{
    if(!moved){ change(active,1); return; }
    const dx=e.changedTouches[0].clientX-sx; if(dx>24) change(active,-1); else if(dx<-24) change(active,1);
  },{passive:true});
})();

/* ===== init & loop ===== */
buildUI(); render();
const nickInput = document.getElementById('nick');
nickInput.value = localStorage.getItem('profileNick') || 'Player';
document.getElementById('saveBtn').onclick = ()=>{
  const nick = nickInput.value || 'Player';
  render();
  localStorage.setItem('profileNick', nick);
  localStorage.setItem('profileAvatar', off.toDataURL());
  save();
  parent.postMessage({type:'avatarSaved'}, '*');
};
document.getElementById('dlBtn').onclick = ()=>{
  render();
  const a=document.createElement('a');
  a.href=off.toDataURL();
  a.download=(nickInput.value||'avatar')+'.png';
  a.click();
};
document.getElementById('exportJson').onclick = ()=>{
  const data = JSON.stringify(state);
  const a=document.createElement('a');
  a.href='data:application/json,'+encodeURIComponent(data);
  a.download=(nickInput.value||'avatar')+'.json';
  a.click();
};
document.getElementById('importJson').onclick = ()=>{
  const inp=document.createElement('input');
  inp.type='file';
  inp.accept='application/json';
  inp.onchange=e=>{
    const f=e.target.files[0];
    if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{ try{ state=JSON.parse(ev.target.result); render(); }catch(err){ toast('Ошибка импорта'); } };
    r.readAsText(f);
  };
  inp.click();
};
const previewBtn=document.getElementById('previewBtn');
let anim=null;
previewBtn.onclick=()=>{
  if(anim){
    clearInterval(anim); anim=null;
    if(window.i18n) i18n.applyTranslations(previewBtn); else previewBtn.textContent='\u25B6 Preview';
  }else{
    anim=setInterval(render,1000); previewBtn.textContent='\u23F8';
  }
};
document.getElementById('randomBtn').onclick=()=>{
  CATS.forEach(cat=>{
    state[cat.k]=Math.floor(Math.random()*cat.count);
    if(cat.color){
      const prop=COLOR_PROP[cat.k];
      const pal=PAL[cat.color];
      const color=pal[Math.floor(Math.random()*pal.length)];
      if(prop==='bgColor') state.bgColor=color; else state[prop]=color;
    }
  });
  save(); render(); openPanel(active);
};
</script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>
