<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title data-i18n="dodgeRain"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      gap:12px;
      color:var(--ink);
    }
    h1{margin:0;font-size:18px;}
    .play{
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #gameCanvas{
      background:var(--bg2);
      border:4px solid var(--pastel-peach);
      image-rendering:pixelated;
      box-shadow:0 10px 20px rgba(0,0,0,0.2);
      width:min(70svh,96vw);
      height:auto;
      aspect-ratio:3/4;
    }
    #score{margin:0;font-size:14px;}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }
  </style>
</head>
  <body class="theme-blue">
    <canvas class="icon" data-icon="rain" aria-hidden="true"></canvas>
    <h1 data-i18n="dodgeRain"></h1>
  <div class="play">
    <div class="hud">
      <div id="score" class="counter">0</div>
      <button id="scoresBtn" class="pill" data-i18n-aria-label="records">üèÜ</button>
      <div id="status" class="counter" style="visibility:hidden"></div>
    </div>
    <canvas id="gameCanvas" tabindex="0" data-i18n-aria-label="gameField"></canvas>
    <div id="toast" class="toast"></div>
    <div id="pad" class="pad pad-center">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-dir="up" style="grid-area:up">‚ñ≤</div>
        <div class="k" data-dir="left" style="grid-area:left">‚óÑ</div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right">‚ñ∫</div>
        <div class="k" data-dir="down" style="grid-area:down">‚ñº</div>
      </div>
      <button class="btn" id="startBtn" data-i18n="start" data-i18n-aria-label="start"></button>
    </div>
  </div>
    <script src="src/ui.js"></script>
    <script src="src/audio.js"></script>
    <script src="src/scores.js"></script>
    <script src="src/icons.js"></script>
  <script>
  (function(){
    'use strict';
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d',{alpha:false});
    ctx.imageSmoothingEnabled=false;
    canvas.width=120; canvas.height=160;
    let running=false;
    let player, objects, spawnTimer, score, difficulty;
    const scoreEl=document.getElementById('score');
    const startBtn=document.getElementById('startBtn');
    const header=document.querySelector('h1');
    const toastEl=document.getElementById('toast');
    const pad=document.getElementById('pad');
    const scores=Scores('rain');
    document.getElementById('scoresBtn').onclick=scores.show;
    let best=parseInt(localStorage.getItem('rainBest')||'0',10);
    const scoreBoard=UI.score(scoreEl,globalThis.i18n?.t('score')||'Score');
    scoreBoard.set(0,best);
    let left=false,right=false;

    const playerSprite=[
      '00100',
      '01210',
      '11111',
      '01010',
      '10101'
    ];
    const dropSprites=[
      [
        '00100',
        '01110',
        '11111',
        '01110',
        '00100'
      ],[
        '00000',
        '00100',
        '01110',
        '00100',
        '00000'
      ]
    ];

    function drawSprite(sprite,x,y,scale,palette){
      for(let j=0;j<sprite.length;j++){
        for(let i=0;i<sprite[j].length;i++){
          const v=sprite[j][i];
          if(v!=='0'){
            ctx.fillStyle=palette[parseInt(v)];
            ctx.fillRect(x+i*scale,y+j*scale,scale,scale);
          }
        }
      }
    }

    const toast = UI.makeToast(toastEl);
    function resetGame(){
      running=false;
      player={x:canvas.width/2-5,y:canvas.height-12,w:10,h:10};
      objects=[];
      spawnTimer=0;
      score=0;
      difficulty=1;
      scoreBoard.set(score,best);
      draw();
    }
    function spawnObject(){
      const size=5;
      objects.push({x:Math.random()*(canvas.width-size),y:-size,w:size,h:size,vy:1+Math.random()*1,color:pickColor(),anim:0});
      if(objects.length>50) objects.shift();
    }
    function pickColor(){
      const vars=['--pastel-peach','--pastel-mint','--pastel-blue','--pastel-pink'];
      return getComputedStyle(document.documentElement).getPropertyValue(vars[Math.floor(Math.random()*vars.length)]).trim();
    }
    function update(){
      if(!running) return;
      if(left) player.x=Math.max(0,player.x-2);
      if(right) player.x=Math.min(canvas.width-player.w,player.x+2);
      spawnTimer++;
      difficulty+=0.001;
      if(spawnTimer>Math.max(5,20-difficulty*2)){
        spawnObject();
        spawnTimer=0;
      }
      for(const o of objects){
        o.y+=o.vy*difficulty;
        o.anim+=0.2;
      }
      objects = objects.filter(o=>{
        if(o.y>canvas.height){ score++; Sound.fx('coin'); scoreBoard.set(score,best); return false; }
        return true;
      });
      for(const o of objects){
        if(o.x<player.x+player.w && o.x+o.w>player.x && o.y<player.y+player.h && o.y+o.h>player.y){
          running=false;
          Sound.fx('error');
          toast('Score: '+score);
          if(score>best){ best=score; localStorage.setItem('rainBest',best); }
          scores.add(score);
          resetGame();
          break;
        }
      }
      draw();
      requestAnimationFrame(update);
    }
    function draw(){
      const s=getComputedStyle(document.documentElement);
      ctx.fillStyle=s.getPropertyValue('--bg2');
      ctx.fillRect(0,0,canvas.width,canvas.height);
      const playerPalette=[null,s.getPropertyValue('--pastel-peach'),s.getPropertyValue('--pastel-blue')];
      drawSprite(playerSprite,player.x,player.y,2,playerPalette);
      for(const o of objects){
        const frame=dropSprites[Math.floor(o.anim)%dropSprites.length];
        drawSprite(frame,o.x,o.y,1,[null,o.color]);
      }
    }
    function movePlayerTo(x){
      const half=player.w/2;
      player.x=Math.min(Math.max(x-half,0),canvas.width-player.w);
    }
    canvas.addEventListener('mousemove',e=>{
      const rect=canvas.getBoundingClientRect();
      movePlayerTo(e.clientX-rect.left);
    });
    canvas.addEventListener('touchmove',e=>{
      const rect=canvas.getBoundingClientRect();
      const t=e.touches[0];
      movePlayerTo(t.clientX-rect.left);
      e.preventDefault();
    },{passive:false});
    const setBtn=UI.attachDPad(pad,dir=>{
      if(dir==='left'){ left=true; right=false; }
      else if(dir==='right'){ right=true; left=false; }
    });
    pad.querySelectorAll('[data-dir]').forEach(btn=>{
      const dir=btn.dataset.dir;
      const off=e=>{ e.preventDefault(); setBtn(dir,false); if(dir==='left') left=false; else if(dir==='right') right=false; };
      btn.addEventListener('touchend',off,{passive:false});
      btn.addEventListener('touchcancel',off,{passive:false});
      btn.addEventListener('mouseup',off);
      btn.addEventListener('mouseleave',off);
    });
    document.addEventListener('keydown',e=>{
      const k=e.key.toLowerCase();
      if(k==='arrowleft' || k==='a'){ left=true; setBtn('left',true); e.preventDefault(); }
      else if(k==='arrowright' || k==='d'){ right=true; setBtn('right',true); e.preventDefault(); }
    });
    document.addEventListener('keyup',e=>{
      const k=e.key.toLowerCase();
      if(k==='arrowleft' || k==='a'){ left=false; setBtn('left',false); e.preventDefault(); }
      else if(k==='arrowright' || k==='d'){ right=false; setBtn('right',false); e.preventDefault(); }
    });
    startBtn.addEventListener('click',()=>{
      Sound.fx('start');
      resetGame();
      running=true;
      requestAnimationFrame(update);
    });
    resetGame();
  })();
  </script>
<script type="module" src="src/serve-warning.js"></script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>

