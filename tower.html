<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#14110e">
<title data-i18n="tower"></title>
<link rel="stylesheet" href="styles/shell.css">
  <link rel="stylesheet" href="styles/game.css">
<style>
  #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);color:#fff;font-family:'Press Start 2P',ui-monospace,monospace;text-align:center;padding:8px;}
  #overlay.play{background:none;color:#000;justify-content:flex-start;align-items:flex-start;font-size:12px;pointer-events:none;}
</style>
</head>
<body>
<div class="cabinet">
    <div class="frame">
      <div class="inner">
        <canvas class="icon" data-icon="tower" aria-hidden="true"></canvas>
        <div class="hud">
        <div class="counter" id="score">0</div>
        <button class="pill" id="scoresBtn" data-i18n-aria-label="records">üèÜ</button>
        <div class="counter" id="status">‚Äî</div>
      </div>
      <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öôÔ∏è</button>
      <canvas id="cv" class="bg-stripes" tabindex="0" data-i18n-aria-label="gameField"></canvas>
      <div id="overlay" data-i18n="dropBlock"></div>
      <div class="scanlines"></div>
    </div>
    <div id="pad" class="pad pad-center">
      <button class="k" data-btn="a" data-i18n-aria-label="dropBlock" style="width:40vw;max-width:160px;">A</button>
    </div>
    <div class="options" style="margin-top:8px;width:70%;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;">
      <label class="pill" style="flex:1;display:flex;gap:6px;align-items:center;justify-content:center;">
        <span data-i18n="width">Width</span>
        <pixel-range style="flex:1"><input type="range" id="widthRange" min="30" max="80" value="60" aria-label="Width"></pixel-range>
      </label>
      <div class="pill" id="mode">‚àû</div>
      <button class="pill" id="diffBtn" data-i18n="easy" data-i18n-title="difficulty" title="Difficulty"></button>
    </div>
    <div class="label" data-i18n="tower"></div>
  </div>
  <div class="footer">Button A ‚Ä¢ Keyboard: Space</div>
</div>

<script type="module">
import './src/pixel-widgets.js';
import './src/ui.js';
import './src/audio.js';
import './src/scores.js';
import './src/icons.js';
import './src/i18n.js';
import { initSettings } from './src/settings.js';
initSettings();

(() => {
  const SETTINGS = { W:360, H:640, sfx:0.6 };
  const d = (s)=>document.querySelector(s);
  const scoreEl=d('#score'), statusEl=d('#status'), cv=d('#cv'), pad=d('#pad');
  const overlay=d('#overlay'), diffBtn=d('#diffBtn');
  const scores=Scores('tower');
  d('#scoresBtn').onclick=scores.show;
  const widthRange=d('#widthRange');
  const ctx=cv.getContext('2d');
  const diffKeys=['easy','medium','hard'];
  let difficulty=parseInt(localStorage.getItem('towerDiff')||'0',10);
  function t(k){ return window.i18n?window.i18n.t(k):k; }
  function updateDiff(){ const key=diffKeys[difficulty]; diffBtn.dataset.i18n=key; diffBtn.textContent=t(key); }
  diffBtn.addEventListener('click',()=>{ difficulty=(difficulty+1)%diffKeys.length; localStorage.setItem('towerDiff',difficulty); updateDiff(); });
  updateDiff();
  let best=parseInt(localStorage.getItem('towerBest')||'0',10);
  widthRange.value=localStorage.getItem('towerWidth')||'60';
  widthRange.addEventListener('change',e=>localStorage.setItem('towerWidth',e.target.value));
  function resize(){ const pr=Math.max(1,Math.floor(devicePixelRatio||1));
    const r=cv.getBoundingClientRect(); cv.width=Math.floor(r.width*pr); cv.height=Math.floor(r.height*pr);
  }
  function clear(){ ctx.clearRect(0,0,cv.width,cv.height); }
  window.addEventListener('resize',resize);

  // Input
  const Input = (()=>{
    const st={left:false,right:false,up:false,down:false,a:false,b:false};
    const map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down',' ':'a',Enter:'b',a:'a',A:'a',z:'b',Z:'b',w:'up',W:'up',s:'down',S:'down',d:'right',D:'right'};
    const set=(btn,val)=>{ st[btn]=val; const el=pad.querySelector(`[data-btn="${btn}"]`); if(el) el.classList.toggle('down',val); };
    addEventListener('keydown',e=>{const b=map[e.key]; if(b){set(b,true); e.preventDefault();}});
    addEventListener('keyup',e=>{const b=map[e.key]; if(b){set(b,false); e.preventDefault();}});
    pad.querySelectorAll('[data-btn]').forEach(el=>{
      const btn=el.dataset.btn;
      const on=(e)=>{set(btn,true); e.preventDefault();};
      const off=(e)=>{set(btn,false); e.preventDefault();};
      el.addEventListener('touchstart',on,{passive:false});
      el.addEventListener('touchend',off,{passive:false});
      el.addEventListener('touchcancel',off,{passive:false});
      el.addEventListener('mousedown',on);
      addEventListener('mouseup',off);
      el.addEventListener('mouseleave',off);
    });
    UI.autoHidePad(pad);
    return {st};
  })();

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const irnd=(a,b)=>Math.floor(rnd(a,b+1));

  // ===== Game specific code =====
  
  const game = {
    score:0, started:false, over:false, slice:null,
    init(){ this.reset(); loop(); },
    reset(){
      this.score=0; this.started=false; this.over=false;
      scoreEl.textContent=t('score')+': 0 ('+t('best')+': '+best+')';
      this.baseY=SETTINGS.H-60; this.speed=120+difficulty*30; this.g=900+difficulty*150;
      const startW=parseInt(widthRange.value)/100*SETTINGS.W;
      const startX=(SETTINGS.W-startW)/2;
      this.active={x:startX,w:startW,y:this.baseY-20,dir:+1,vy:0,falling:false};
      this.prev={x:startX,w:startW,y:this.baseY,fixed:true};
      this.layers=[]; this.slice=null;
      overlay.textContent=t('dropBlock'); overlay.classList.remove('play');
    },
    step(dt){
      const I=Input.st;
      if(this.over){ if(I.a){ this.reset(); } return; }
      if(!this.started){ if(I.a||I.b){ this.started=true; overlay.classList.add('play'); Sound.fx('start'); } else return; }
      const a=this.active;
      if(!a.falling){
        a.x+=a.dir*this.speed*dt;
        if(a.x<8){a.x=8;a.dir=+1}
        if(a.x+a.w>SETTINGS.W-8){a.x=SETTINGS.W-8-a.w;a.dir=-1}
        if(I.a){ a.falling=true; a.vy=0; }
      } else {
        a.vy+=this.g*dt; a.y+=a.vy*dt;
        if(a.y>=this.prev.y-20){
          const L=Math.max(a.x,this.prev.x), R=Math.min(a.x+a.w,this.prev.x+this.prev.w), ov=R-L;
          if(ov<=2){ Sound.fx('error'); this.over=true; if(this.score>best){ best=this.score; localStorage.setItem('towerBest',best); statusEl.textContent='New record!'; } scores.add(this.score); return; }
          const left=a.x<L?{x:a.x,w:L-a.x,y:a.y,vy:a.vy}:null;
          const right=a.x+a.w>R?{x:R,w:a.x+a.w-R,y:a.y,vy:a.vy}:null;
          this.layers.push({...this.prev});
          this.prev={x:L,w:ov,y:a.y+20,fixed:true};
          this.active={x:this.prev.x-60,w:this.prev.w,y:this.prev.y-20,dir:+1,vy:0,falling:false};
          this.slice=left||right;
          this.baseY-=10; this.speed+=3+Math.random()*3; this.score=this.layers.length; Sound.fx('coin');
        }
      }
      if(this.slice){ this.slice.vy+=this.g*dt; this.slice.y+=this.slice.vy*dt; if(this.slice.y>SETTINGS.H) this.slice=null; }
    },
    draw(){
      ctx.save(); const sx=cv.width/SETTINGS.W, sy=cv.height/SETTINGS.H; ctx.scale(sx,sy);
      ctx.fillStyle='#e9d3b0'; ctx.fillRect(0,this.baseY+24,SETTINGS.W,4);
      const drawB=(b,col)=>{ ctx.fillStyle=col; ctx.fillRect(b.x,b.y,b.w,20); ctx.strokeStyle='#deb780'; ctx.lineWidth=2; ctx.strokeRect(b.x+1,b.y+1,b.w-2,18); };
      this.layers.forEach(L=>drawB(L,'#cbe7aa'));
      drawB(this.prev,'#ffd88a'); drawB(this.active,'#9be0c0');
      if(this.slice) drawB(this.slice,'#ffb590');
      if(this.over){ ctx.fillStyle='#bf5a3d'; ctx.font='16px "Press Start 2P"'; ctx.textAlign='center'; ctx.fillText('Miss. A to retry', SETTINGS.W/2, SETTINGS.H*0.5); }
      ctx.restore();
    }
  };
  let last=performance.now();
  function loop(){ requestAnimationFrame(loop); resize(); clear(); const t=performance.now(), dt=Math.min(.033,(t-last)/1000); last=t;
    game.step(dt); game.draw(); if(game.started) overlay.textContent=t('height')+': '+game.score; scoreEl.textContent=t('score')+': '+(game.score|0)+' ('+t('best')+': '+best+')'; }
  game.init();


})();
</script>
</body>
</html>
