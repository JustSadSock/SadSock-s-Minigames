<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title data-i18n="rhythm"></title>
<link rel="stylesheet" href="styles/shell.css">
<style>
  #startScreen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);gap:12px;color:#fff;font-family:'Press Start 2P',ui-monospace,monospace;font-size:12px;text-align:center;}
  #startScreen.hidden{display:none;}
  .lanes-demo{display:flex;gap:8px;}
  .lanes-demo div{width:40px;height:40px;border:2px solid var(--bezel);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:18px;}
</style>
</head>
<body>
<div class="cabinet">
    <div class="frame">
    <div class="inner">
      <canvas class="icon" data-icon="rhythm" aria-hidden="true"></canvas>
      <div class="hud">
        <div class="counter" id="score">0</div>
        <button class="pill" id="scoresBtn" data-i18n-aria-label="records">üèÜ</button>
        <div style="display:flex;gap:4px;">
          <div class="counter" id="combo">0</div>
          <div class="counter" id="status">‚Äî</div>
        </div>
      </div>
      <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öôÔ∏è</button>
      <canvas id="cv" class="bg-stripes" tabindex="0" data-i18n-aria-label="gameField"></canvas>
      <div class="scanlines"></div>
      <div id="startScreen">
        <div class="lanes-demo">
          <div style="background:var(--pastel-pink)">A</div>
          <div style="background:var(--pastel-blue)">S</div>
          <div style="background:var(--pastel-mint)">K</div>
          <div style="background:var(--pastel-peach)">L</div>
        </div>
        <button id="playBtn" class="pill" data-i18n="start" data-i18n-aria-label="start"></button>
      </div>
    </div>
    <div id="pad" class="pad pad-center" aria-hidden="true">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-btn="up" style="grid-area:up"></div>
        <div class="k" data-btn="left" style="grid-area:left"></div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-btn="right" style="grid-area:right"></div>
        <div class="k" data-btn="down" style="grid-area:down"></div>
      </div>
      <div class="ab">
        <div class="k" data-btn="a">A</div>
        <div class="k" data-btn="b">B</div>
      </div>
    </div>
    <div class="label">Rhythm</div>
  </div>
  <div class="footer">Mobile A/S/K/L ‚Ä¢ Keyboard: A/S/K/L</div>
</div>

<script src="src/ui.js"></script>
<script src="src/audio.js"></script>
<script src="src/scores.js"></script>
<script src="src/icons.js"></script>
<script type="module">
import { initSettings } from './src/settings.js';
initSettings();
</script>
<script>
(() => {
  const SETTINGS = { W:360, H:640, sfx:0.6 };
  const d = (s)=>document.querySelector(s);
  const scoreEl=d('#score'), comboEl=d('#combo'), statusEl=d('#status'), cv=d('#cv'), pad=d('#pad');
  const startScreen=d('#startScreen'), playBtn=d('#playBtn');
  const scores=Scores('rhythm');
  d('#scoresBtn').onclick=scores.show;
  const ctx=cv.getContext('2d');
  playBtn.onclick=()=>{ game.started=true; startScreen.classList.add('hidden'); Sound.fx('start'); cv.focus(); };
  const cs=getComputedStyle(document.documentElement);
  const laneCols=['--pastel-pink','--pastel-blue','--pastel-mint','--pastel-peach']
    .map(v=>cs.getPropertyValue(v).trim()+"33");
  const noteCols=['#ff5f9c','#46a0ff','#00d9b8','#ffca3a'];
  let best=parseInt(localStorage.getItem('rhythmBest')||'0',10);
  const scoreBoard=UI.score(scoreEl,globalThis.i18n?.t('score')||'Score');
  scoreBoard.set(0,best);
  const comboLabel=globalThis.i18n?.t('combo')||'Combo';
  function resize(){ const pr=Math.max(1,Math.floor(devicePixelRatio||1));
    const r=cv.getBoundingClientRect(); cv.width=Math.floor(r.width*pr); cv.height=Math.floor(r.height*pr);
  }
  function clear(){ ctx.clearRect(0,0,cv.width,cv.height); }
  window.addEventListener('resize',resize);

  // Input
  const Input = (()=>{
    const st={left:false,right:false,a:false,b:false};
    const map={a:'a',A:'a',s:'b',S:'b',k:'left',K:'left',l:'right',L:'right',ArrowLeft:'left',ArrowRight:'right'};
    const set=(btn,val)=>{ st[btn]=val; const el=pad.querySelector(`[data-btn="${btn}"]`); if(el) el.classList.toggle('down',val); };
    addEventListener('keydown',e=>{const b=map[e.key]; if(b){set(b,true); e.preventDefault();}});
    addEventListener('keyup',e=>{const b=map[e.key]; if(b){set(b,false); e.preventDefault();}});
    pad.querySelectorAll('[data-btn]').forEach(el=>{
      const btn=el.dataset.btn;
      const on=(e)=>{set(btn,true); e.preventDefault();};
      const off=(e)=>{set(btn,false); e.preventDefault();};
      el.addEventListener('touchstart',on,{passive:false});
      el.addEventListener('touchend',off,{passive:false});
      el.addEventListener('touchcancel',off,{passive:false});
      el.addEventListener('mousedown',on);
      addEventListener('mouseup',off);
      el.addEventListener('mouseleave',off);
    });
    UI.autoHidePad(pad);
    return {st};
  })();

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const irnd=(a,b)=>Math.floor(rnd(a,b+1));

  // ===== Game specific code =====
  
  const game = {
    score:0, started:false, over:false,
    init(){ this.reset(); loop(); },
    reset(){ this.score=0; this.started=false; this.over=false;
      best=parseInt(localStorage.getItem('rhythmBest')||'0',10);
      scoreBoard.set(0,best);
      comboEl.textContent=comboLabel+': 0';
      statusEl.textContent='‚Äî';
      this.lanes=4; this.speed=180; this.barY=SETTINGS.H-120;
      const pattern=[0,1,2,3, 0,1,2,3, 0,2,1,3, 0,1,2,3];
      this.notes=pattern.map((lane,i)=>({lane,y:-i*90,hit:false}));
      this.total=this.notes.length;
      this.combo=0; this.winGood=110; this.winPerf=60;
    },
    tryHit(l){ const tgt=this.barY; let best=null, bd=1e9;
      for(const n of this.notes){ if(n.hit||n.lane!==l) continue; const d=Math.abs(n.y-tgt); if(d<bd){bd=d; best=n;} }
      if(!best) return;
      if(bd<=this.winPerf/2){ this.score+=300; this.combo++; statusEl.textContent='PERFECT'; best.hit=true; Sound.fx('coin'); }
      else if(bd<=this.winGood/2){ this.score+=100; this.combo++; statusEl.textContent='GOOD'; best.hit=true; Sound.fx('coin'); }
      else { this.combo=0; statusEl.textContent='MISS'; Sound.fx('error'); }
      comboEl.textContent=comboLabel+': '+this.combo;
    },
    step(dt){
      const I=Input.st;
      if(this.over){ if(I.a||I.b||I.left||I.right){ this.reset(); } return; }
      if(!this.started){ if(I.a||I.b||I.left||I.right){ this.started=true; startScreen.classList.add('hidden'); Sound.fx('start'); } else return; }
          for(const n of this.notes){ n.y+=this.speed*dt; if(!n.hit && n.y>this.barY+60){ n.hit=true; this.combo=0; statusEl.textContent='MISS'; comboEl.textContent=comboLabel+': 0'; Sound.fx('error'); } }
      if(I.a) this.tryHit(0); if(I.b) this.tryHit(1); if(I.left) this.tryHit(2); if(I.right) this.tryHit(3);
      if(this.notes.every(n=>n.hit)){ this.over=true; if(this.score>best){ best=this.score; localStorage.setItem('rhythmBest',best); } scores.add(this.score); }
    },
    draw(){
      ctx.save(); const sx=cv.width/SETTINGS.W, sy=cv.height/SETTINGS.H; ctx.scale(sx,sy);
      const laneW=SETTINGS.W/this.lanes;
      for(let i=0;i<this.lanes;i++){ ctx.fillStyle=laneCols[i]; ctx.fillRect(i*laneW,0,laneW-2,SETTINGS.H); }
      ctx.fillStyle='#e6a64c'; ctx.fillRect(0,this.barY,SETTINGS.W,4);
      for(const n of this.notes){ if(n.hit) continue; ctx.fillStyle=noteCols[n.lane]; ctx.fillRect(n.lane*laneW+6, n.y-14, laneW-12, 28); }
      const prog=this.notes.filter(n=>n.hit).length/this.total;
      ctx.fillStyle='#d18f3f'; ctx.fillRect(0,8,SETTINGS.W*prog,8);
      ctx.strokeStyle='#bf8a3d'; ctx.strokeRect(0,8,SETTINGS.W,8);
      if(this.over){ ctx.fillStyle='#bf8a3d'; ctx.font='16px "Press Start 2P"'; ctx.textAlign='center'; ctx.fillText('Track over. A to retry', SETTINGS.W/2, SETTINGS.H*0.5); }
      ctx.restore();
    }
  };
  let last=performance.now();
  function loop(){ requestAnimationFrame(loop); resize(); clear(); const t=performance.now(), dt=Math.min(.033,(t-last)/1000); last=t;
    game.step(dt); game.draw(); scoreBoard.set(game.score|0,best); }
  game.init();


})();
</script>
<script type="module" src="src/serve-warning.js"></script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>
