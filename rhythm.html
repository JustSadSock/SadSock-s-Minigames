<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Ритм — SadSock’s playground</title>
<style>

  :root{
    --bg:#f4e7c8; --bg2:#f2deb8; --panel:#f5e9cf; --ink:#3a2a18;
    --accent:#e6a64c; --accent2:#d18f3f; --hi:#3fbf75; --warn:#d4635b;
    --shadow:rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(circle at 50% -10%, #ffeecf, #f3dfbd 60%, #f0d6aa);
    color:var(--ink);font-family:ui-rounded, ui-sans-serif, system-ui, -apple-system, "SF Pro Rounded", "Segoe UI", Roboto, "Helvetica Neue", Arial}
  .cabinet{
    min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:12px; padding:14px;
  }
  .frame{
    width:min(520px,94vw); height:min(84vh, 86svh);
    background:linear-gradient(180deg, #f7ebd1, #f3debb 60%, #f1d8ad);
    border-radius:22px; position:relative; padding:12px; box-shadow:
      inset 0 2px 0 #fff7e7,
      inset 0 -4px 0 #e0caa1,
      0 10px 30px var(--shadow);
    border:2px solid #e3cda3;
  }
  .inner{
    position:absolute; inset:16px 16px 110px 16px; border-radius:16px;
    background:
      linear-gradient(180deg, #f9efd7, #f4e3c1);
    box-shadow: inset 0 2px 0 #fff6e2, inset 0 -4px 0 #e9d3ac;
    overflow:hidden;
  }
  .scanlines{ position:absolute; inset:0; pointer-events:none;
    background:repeating-linear-gradient(0deg, #0000 0 3px, rgba(0,0,0,.05) 3px 4px); mix-blend-mode:multiply; opacity:.35 }
  canvas{width:100%; height:100%; display:block; image-rendering:pixelated}
  .hud{ position:absolute; left:0; right:0; top:0; display:flex; justify-content:space-between; gap:8px; padding:8px; font-weight:700; }
  .pill{ background:#ffe9c9; border:2px solid #e8cda0; border-radius:999px; padding:6px 10px; box-shadow:0 2px 0 #e2c395 }
  .pad{
    position:absolute; left:16px; right:16px; bottom:18px; display:flex; justify-content:space-between; gap:18px;
  }
  .dpad{
    width:40vw; max-width:260px; aspect-ratio:1; display:grid; grid-template-areas:
      ". up ."
      "left mid right"
      ". down .";
    gap:8px; padding:10px; border-radius:16px;
    background:#f4e5c2; border:2px solid #e8cda0; box-shadow:inset 0 2px 0 #fff3da, inset 0 -3px 0 #e1c79c;
  }
  .ab{ width:40vw; max-width:260px; display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .k{
    background:#ffefcf; border:2px solid #e7c999; border-radius:12px; box-shadow:0 3px 0 #dcb985; height:24vw; max-height:120px;
  }
  .dpad .k{height:100%}
  .k:active{ transform:translateY(1px) }
  .label{ position:absolute; left:20px; top:8px; font-family:monospace; font-weight:800; letter-spacing:.6px }
  .hint{ position:absolute; right:20px; top:8px; opacity:.7; font-size:12px }
  .footer{ color:#7a5a36; font-weight:700; text-shadow:0 1px #fff4de; }

</style>
</head>
<body>
<div class="cabinet">
  <div class="frame">
    <div class="inner">
      <div class="hud">
        <div class="pill" id="score">Score: 0</div>
        <div class="pill" id="status">—</div>
      </div>
      <canvas id="cv"></canvas>
      <div class="scanlines"></div>
    </div>
    <div class="pad" id="pad">
      <div class="dpad">
        <div class="k" data-btn="up" style="grid-area:up"></div>
        <div class="k" data-btn="left" style="grid-area:left"></div>
        <div class="k" style="grid-area:mid; opacity:.35"></div>
        <div class="k" data-btn="right" style="grid-area:right"></div>
        <div class="k" data-btn="down" style="grid-area:down"></div>
      </div>
      <div class="ab">
        <div class="k" data-btn="a"></div>
        <div class="k" data-btn="b"></div>
      </div>
    </div>
    <div class="label">Ритм</div>
    <div class="hint">A/S/K/L или тач по дорожкам.</div>
  </div>
  <div class="footer">D‑pad + A/B • Клавиатура: стрелки/WSAD, A=Space, B=Enter</div>
</div>

<script>
(() => {
  const SETTINGS = { W:360, H:640, sfx:0.6 };
  const d = (s)=>document.querySelector(s);
  const scoreEl=d('#score'), statusEl=d('#status'), cv=d('#cv'), pad=d('#pad');
  const ctx=cv.getContext('2d');
  function resize(){ const pr=Math.max(1,Math.floor(devicePixelRatio||1));
    const r=cv.getBoundingClientRect(); cv.width=Math.floor(r.width*pr); cv.height=Math.floor(r.height*pr);
  }
  function clear(){ ctx.fillStyle='#f4e3c1'; ctx.fillRect(0,0,cv.width,cv.height);
    ctx.save(); ctx.globalAlpha=.07; const s=8; ctx.fillStyle='#b09060';
    for(let y=0;y<cv.height;y+=s*2) ctx.fillRect(0,y,cv.width,s);
    ctx.restore();
  }
  window.addEventListener('resize',resize);

  // Input
  const Input = (()=>{
    const st={left:false,right:false,up:false,down:false,a:false,b:false};
    const map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down',' ':'a',Enter:'b',a:'a',A:'a',z:'b',Z:'b',w:'up',W:'up',s:'down',S:'down',d:'right',D:'right'};
    addEventListener('keydown',e=>{const b=map[e.key]; if(b){st[b]=true; e.preventDefault();}});
    addEventListener('keyup',e=>{const b=map[e.key]; if(b){st[b]=false; e.preventDefault();}});
    pad.querySelectorAll('[data-btn]').forEach(el=>{
      const btn=el.dataset.btn;
      const on=(e)=>{st[btn]=true; el.style.filter='brightness(1.08)'; e.preventDefault();};
      const off=(e)=>{st[btn]=false; el.style.filter=''; e.preventDefault();};
      el.addEventListener('touchstart',on,{passive:false});
      el.addEventListener('touchend',off,{passive:false});
      el.addEventListener('touchcancel',off,{passive:false});
      el.addEventListener('mousedown',on); addEventListener('mouseup',off);
      el.addEventListener('mouseleave',off);
    });
    return {st};
  })();

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const irnd=(a,b)=>Math.floor(rnd(a,b+1));

  // ===== Game specific code =====
  
  const game = {
    score:0, started:false, over:false,
    init(){ this.reset(); loop(); },
    reset(){ this.score=0; this.started=false; this.over=false;
      this.lanes=4; this.speed=180; this.barY=SETTINGS.H-120;
      this.notes=[]; for(let i=0;i<60;i++){ const lane=irnd(0,3); this.notes.push({lane,y:-i*90,hit:false}); if(Math.random()<.25)this.notes.push({lane:clamp(lane+(Math.random()<.5?1:-1),0,3),y:-(i*90+45),hit:false});}
      this.combo=0; this.winGood=110; this.winPerf=60;
    },
    tryHit(l){ const tgt=this.barY; let best=null, bd=1e9;
      for(const n of this.notes){ if(n.hit||n.lane!==l) continue; const d=Math.abs(n.y-tgt); if(d<bd){bd=d; best=n;} }
      if(!best) return;
      if(bd<=this.winPerf/2){ this.score+=300; this.combo++; statusEl.textContent='PERFECT ×'+this.combo; best.hit=true; }
      else if(bd<=this.winGood/2){ this.score+=100; this.combo++; statusEl.textContent='GOOD ×'+this.combo; best.hit=true; }
      else { this.combo=0; statusEl.textContent='MISS'; }
    },
    step(dt){
      const I=Input.st; if(!this.started){ if(I.a||I.b||I.left||I.right||I.up||I.down) this.started=true; else return; }
      for(const n of this.notes){ n.y+=this.speed*dt; if(!n.hit && n.y>this.barY+60){ n.hit=true; this.combo=0; statusEl.textContent='MISS'; } }
      if(I.a) this.tryHit(0); if(I.b) this.tryHit(1); if(I.left) this.tryHit(2); if(I.right) this.tryHit(3);
      if(this.notes.every(n=>n.hit)) this.over=true;
    },
    draw(){
      ctx.save(); const sx=cv.width/SETTINGS.W, sy=cv.height/SETTINGS.H; ctx.scale(sx,sy);
      const laneW=SETTINGS.W/this.lanes;
      for(let i=0;i<this.lanes;i++){ ctx.fillStyle='#f2e3c0'; ctx.fillRect(i*laneW,0,laneW-2,SETTINGS.H); }
      ctx.fillStyle='#e6a64c'; ctx.fillRect(0,this.barY,SETTINGS.W,4);
      ctx.fillStyle='#3fbf75';
      for(const n of this.notes){ if(n.hit) continue; ctx.fillRect(n.lane*laneW+6, n.y-14, laneW-12, 28); }
      if(!this.started){ ctx.fillStyle='#bf8a3d'; ctx.font='16px monospace'; ctx.textAlign='center'; ctx.fillText('A/S/K/L или тач по дорожкам', SETTINGS.W/2, SETTINGS.H*0.5); }
      if(this.over){ ctx.fillStyle='#bf8a3d'; ctx.font='16px monospace'; ctx.textAlign='center'; ctx.fillText('Трек окончен. Обнови для рестарта', SETTINGS.W/2, SETTINGS.H*0.5); }
      ctx.restore();
    }
  };
  let last=performance.now();
  function loop(){ requestAnimationFrame(loop); resize(); clear(); const t=performance.now(), dt=Math.min(.033,(t-last)/1000); last=t;
    game.step(dt); game.draw(); scoreEl.textContent='Score: '+(game.score|0); }
  game.init();


})();
</script>
</body>
</html>
