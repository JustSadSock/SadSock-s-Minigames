<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title data-i18n="memoryFlip"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <style>
    :root{
      --bg0:var(--bg);
      --bg1:var(--bg2);
      --bg2:var(--panel);
      --ink:var(--ink);
      --pastel-pink:var(--accent);
      --pastel-blue:var(--accent2);
      --pastel-mint:var(--hi);
      --pastel-peach:var(--panel);
      --accent:var(--accent2);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      height:100svh;
      overflow:hidden;
      padding-top:12px;
      color:var(--ink);
      gap:12px;
    }
    h1{margin:0;font-size:18px;}
    .play{
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    #grid{
      width:100%;
      max-width:300px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:6px;
      margin:0 auto;
    }
    .card{
      perspective:600px;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      aspect-ratio:1/1;
    }
    .card-inner{
      position:relative;
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition:transform .4s;
    }
    .card.open .card-inner{transform:rotateY(180deg);}
    .face{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid var(--pastel-peach);
      border-radius:8px;
      font-size:30px;
      backface-visibility:hidden;
      box-shadow:0 4px 0 rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.5);
    }
    .front{background:linear-gradient(180deg,var(--pastel-blue),#3a94ef);}
    .back{background:linear-gradient(180deg,var(--pastel-peach),#e3a228);transform:rotateY(180deg);}
    .card.matched .back{background:linear-gradient(180deg,var(--pastel-mint),#00bfa1);}
    #score,#timer,#moves{margin:0;font-size:clamp(16px,4vw,20px);text-align:center;}

    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }
    .pad{position:static;margin-top:8px;}
  </style>
</head>
<body>
  <h1>Memory¬†Flip</h1>
  <div id="score" class="pill">–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ä:¬†0/8</div>
  <div id="timer" class="pill">–í—Ä–µ–º—è:¬†0.0—Å</div>
  <div id="moves" class="pill">–•–æ–¥—ã:¬†0</div>
  <button id="scoresBtn" class="pill" aria-label="–†–µ–∫–æ—Ä–¥—ã">üèÜ</button>
  <div class="play">
    <div id="grid" role="grid"></div>
    <div id="toast" class="toast" aria-live="polite"></div>
    <div id="pad" class="pad"><button class="btn" id="startBtn" aria-label="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É">START</button></div>
  </div>
<script src="src/audio.js"></script>
<script src="src/ui.js"></script>
<script src="src/scores.js"></script>
<script>
(function(){
  'use strict';
  const icons=['üçé','üöó','üçÄ','üëª','üóùÔ∏è','üí£','‚≠ê','üõ°Ô∏è'];
  let cards=[], firstCard=null, secondCard=null, matchedCount=0;
  let gameActive=false;
  const grid=document.getElementById('grid');
  const scoreEl=document.getElementById('score');
  const startBtn=document.getElementById('startBtn');
  const header=document.querySelector('h1');
  const play=document.querySelector('.play');
  const toastEl=document.getElementById('toast');
  const timerEl=document.getElementById('timer');
  const movesEl=document.getElementById('moves');
  const showToast=UI.makeToast(toastEl);
  const timeBoard=UI.score(timerEl,'–í—Ä–µ–º—è');
  const movesBoard=UI.score(movesEl,'–•–æ–¥—ã');
  const scores=Scores('memory',{cmp:'asc',format:s=>s.toFixed(1)+'—Å'});
  document.getElementById('scoresBtn').onclick=scores.show;
  let startTime=0, penalty=0, timerId=null;
  let moves=0;
  let bestTime=parseFloat(localStorage.getItem('mfBestTime'))||null;
  let bestMoves=parseInt(localStorage.getItem('mfBestMoves'))||null;

  function startTimer(){
    startTime=performance.now();
    penalty=0;
    clearInterval(timerId);
    timerId=setInterval(()=>{
      const t=((performance.now()-startTime)/1000)+penalty;
      timeBoard.set(t.toFixed(1)+'—Å', bestTime!=null?bestTime.toFixed(1)+'—Å':null);
    },100);
  }
  function stopTimer(){clearInterval(timerId);}
  function shuffle(array){
    for(let i=array.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [array[i],array[j]]=[array[j],array[i]];
    }
    return array;
  }
  function resetGame(){
    startBtn.disabled=false;
    grid.innerHTML='';
    const values=shuffle(icons.concat(icons));
    cards=[];
    matchedCount=0;
    scoreEl.textContent='–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ä: 0/8';
    moves=0;
    timeBoard.set('0—Å', bestTime!=null?bestTime.toFixed(1)+'—Å':null);
    movesBoard.set(0, bestMoves);
    values.forEach(val=>{
      const card=document.createElement('div');
      card.className='card';
      card.dataset.value=val;
      card.innerHTML='<div class="card-inner"><div class="face front"></div><div class="face back">'+val+'</div></div>';
      card.addEventListener('click',()=>handleCard(card));
      card.tabIndex=0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label','–ö–∞—Ä—Ç–∞');
      card.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleCard(card); }
      });
      grid.appendChild(card);
      cards.push(card);
    });
    firstCard=secondCard=null;
    stopTimer();
    timerEl.textContent='–í—Ä–µ–º—è: 0.0—Å';
    gameActive=false;
  }

  function startGame(){
    resetGame();
    startBtn.disabled=true;
    gameActive=true;
    startTimer();
    movesBoard.set(0,bestMoves);
    Sound.fx('start');
  }
  function handleCard(card){
    if(!gameActive || card.classList.contains('open') || card.classList.contains('matched') || secondCard) return;
    reveal(card);
    if(!firstCard){
      firstCard=card;
    }else{
      secondCard=card;
      moves++;
      movesBoard.set(moves,bestMoves);
      if(firstCard.dataset.value===secondCard.dataset.value){
        firstCard.classList.add('matched');
        secondCard.classList.add('matched');
        matchedCount++;
        Sound.fx('coin');
        scoreEl.textContent='–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ä: '+matchedCount+'/8';
        firstCard=secondCard=null;
        if(matchedCount===icons.length){
          stopTimer();
          const total=((performance.now()-startTime)/1000)+penalty;
          if(bestTime==null || total<bestTime){
            bestTime=total;
            localStorage.setItem('mfBestTime',bestTime);
            showToast('–ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥ –≤—Ä–µ–º–µ–Ω–∏: '+total.toFixed(1)+'—Å');
          }else{
            showToast('–í—Ä–µ–º—è: '+total.toFixed(1)+'—Å');
          }
          scores.add(total);
          if(bestMoves==null || moves<bestMoves){
            bestMoves=moves;
            localStorage.setItem('mfBestMoves',bestMoves);
          }
          Sound.fx('start');
          resetGame();
        }
      }else{
        penalty+=0.5;
        Sound.fx('error');
        setTimeout(()=>{
          hide(firstCard);
          hide(secondCard);
          firstCard=secondCard=null;
        },700);
      }
    }
  }
  function reveal(card){
    card.classList.add('open');
  }
  function hide(card){
    card.classList.remove('open');
  }
  startBtn.addEventListener('click',startGame);
  function adjustGrid(){
    const GAP=6, cols=4;
    const availableHeight=window.innerHeight - header.offsetHeight - scoreEl.offsetHeight - timerEl.offsetHeight - 48;
    const availableWidth=play.clientWidth;
    const base=Math.min(availableWidth, availableHeight);
    const card=Math.floor((base - GAP*(cols-1))/cols);
    const size=card*cols + GAP*(cols-1);
    grid.style.width=size+'px';
    grid.style.height=size+'px';
  }
  window.addEventListener('resize',adjustGrid);
  adjustGrid();
  resetGame();
})();
</script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>
