<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#14110e">
  <title data-i18n="memoryFlip"></title>
  <link rel="stylesheet" href="styles/shell.css">
  <link rel="stylesheet" href="styles/game.css">
  <style>
  body{padding-top:12px;}
    #grid{
      width:100%;
      max-width:300px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:6px;
      margin:0 auto;
    }
    .card{
      perspective:600px;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
      aspect-ratio:1/1;
    }
    .card-inner{
      position:relative;
      width:100%;
      height:100%;
      transform-style:preserve-3d;
      transition:transform .4s;
    }
    .card.open .card-inner{transform:rotateY(180deg);}
    .card.matched .card-inner{animation:match .4s;}
    .card.wrong .card-inner{animation:shake .4s;}
    .face{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid var(--pastel-peach);
      border-radius:8px;
      backface-visibility:hidden;
      box-shadow:0 4px 0 rgba(0,0,0,0.15), inset 0 2px 0 rgba(255,255,255,0.5);
    }
    .front{background:linear-gradient(180deg,var(--pastel-blue),#3a94ef);}
    .back{background:linear-gradient(180deg,var(--pastel-peach),#e3a228);transform:rotateY(180deg);}
    .back img{width:100%;height:100%;image-rendering:pixelated;}
    .card.matched .back{background:linear-gradient(180deg,var(--pastel-mint),#00bfa1);}
    #score,#timer,#moves{margin:0;font-size:clamp(16px,4vw,20px);text-align:center;}
    .card.sel{outline:2px solid var(--accent);}
    .toast{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:var(--pastel-pink);
      border:1px solid var(--accent);
      border-radius:8px;
      padding:12px 16px;
      font-size:14px;
      color:var(--ink);
    }
    @keyframes match{
      0%,100%{transform:rotateY(180deg) scale(1);}
      50%{transform:rotateY(180deg) scale(1.1);}
    }
    @keyframes shake{
      0%,100%{transform:rotateY(180deg) translateX(0);}
      25%{transform:rotateY(180deg) translateX(-5%);}
      75%{transform:rotateY(180deg) translateX(5%);}
    }
  </style>
</head>
<body class="theme-blue">
  <canvas class="icon" data-icon="cards" aria-hidden="true"></canvas>
  <h1>Memory¬†Flip</h1>
  <div class="play">
    <div class="hud">
      <div id="score" class="counter">0/8</div>
      <button id="scoresBtn" class="pill" data-i18n-aria-label="records">üèÜ</button>
      <div style="display:flex;gap:4px;">
        <div id="timer" class="counter">0s</div>
        <div id="moves" class="counter">0</div>
      </div>
    </div>
    <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öôÔ∏è</button>
    <div id="grid" role="grid"></div>
    <div id="toast" class="toast" aria-live="polite"></div>
    <div id="pad" class="pad pad-center">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-dir="up" style="grid-area:up"><canvas data-icon="arrow-up"></canvas></div>
        <div class="k" data-dir="left" style="grid-area:left"><canvas data-icon="arrow-left"></canvas></div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-dir="right" style="grid-area:right"><canvas data-icon="arrow-right"></canvas></div>
        <div class="k" data-dir="down" style="grid-area:down"><canvas data-icon="arrow-down"></canvas></div>
      </div>
      <div class="ab">
        <div class="k" data-btn="a">A</div>
        <button class="btn" id="startBtn" data-i18n="start" data-i18n-aria-label="start"></button>
      </div>
    </div>
  </div>
<script type="module">
import './src/audio.js';
import './src/icons.js';
import './src/ui.js';
import './src/scores.js';
import './src/i18n.js';
import { initSettings } from './src/settings.js';
initSettings();

(function(){
  'use strict';
  const iconSvgs=[
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="3" y="0" width="1" height="1" fill="#3a5"/><rect x="2" y="1" width="3" height="3" fill="#d22"/><rect x="1" y="2" width="1" height="2" fill="#d22"/><rect x="5" y="2" width="1" height="2" fill="#d22"/><rect x="2" y="4" width="3" height="2" fill="#d22"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="1" y="3" width="6" height="2" fill="#28f"/><rect x="0" y="4" width="1" height="1" fill="#28f"/><rect x="7" y="4" width="1" height="1" fill="#28f"/><rect x="2" y="5" width="1" height="1" fill="#000"/><rect x="5" y="5" width="1" height="1" fill="#000"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="3" y="0" width="1" height="1" fill="#0c0"/><rect x="2" y="1" width="3" height="1" fill="#0c0"/><rect x="1" y="2" width="5" height="1" fill="#0c0"/><rect x="2" y="3" width="3" height="2" fill="#0c0"/><rect x="3" y="5" width="1" height="2" fill="#0c0"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="2" y="1" width="4" height="5" fill="#fff"/><rect x="1" y="2" width="1" height="3" fill="#fff"/><rect x="6" y="2" width="1" height="3" fill="#fff"/><rect x="2" y="2" width="1" height="1" fill="#000"/><rect x="4" y="2" width="1" height="1" fill="#000"/><rect x="1" y="5" width="1" height="1" fill="#000"/><rect x="3" y="5" width="1" height="1" fill="#000"/><rect x="5" y="5" width="1" height="1" fill="#000"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="0" y="3" width="6" height="1" fill="#fd0"/><rect x="5" y="1" width="2" height="5" fill="#fd0"/><rect x="6" y="0" width="1" height="1" fill="#fd0"/><rect x="6" y="4" width="1" height="1" fill="#fd0"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="3" y="0" width="1" height="1" fill="#f00"/><rect x="2" y="1" width="3" height="1" fill="#555"/><rect x="2" y="2" width="4" height="4" fill="#000"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="3" y="0" width="1" height="2" fill="#fd0"/><rect x="2" y="1" width="3" height="1" fill="#fd0"/><rect x="1" y="3" width="6" height="1" fill="#fd0"/><rect x="2" y="5" width="3" height="1" fill="#fd0"/><rect x="3" y="6" width="1" height="2" fill="#fd0"/></svg>',
    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" shape-rendering="crispEdges"><rect x="2" y="0" width="4" height="1" fill="#bbb"/><rect x="1" y="1" width="6" height="5" fill="#bbb"/><rect x="2" y="2" width="4" height="3" fill="#ddd"/><rect x="3" y="2" width="1" height="3" fill="#999"/><rect x="4" y="2" width="1" height="3" fill="#999"/></svg>'
  ];
  const icons=iconSvgs.map(s=>'data:image/svg+xml,'+encodeURIComponent(s));
  let cards=[], firstCard=null, secondCard=null, matchedCount=0;
  let gameActive=false;
  const grid=document.getElementById('grid');
  const scoreEl=document.getElementById('score');
  const startBtn=document.getElementById('startBtn');
  const pad=document.getElementById('pad');
  const header=document.querySelector('h1');
  const play=document.querySelector('.play');
  const toastEl=document.getElementById('toast');
  const timerEl=document.getElementById('timer');
  const movesEl=document.getElementById('moves');
  const showToast=UI.makeToast(toastEl);
  const timeBoard=UI.score(timerEl,globalThis.i18n?.t('time')||'Time');
  const movesBoard=UI.score(movesEl,globalThis.i18n?.t('moves')||'Moves');
  const scores=Scores('memory',{cmp:'asc',format:s=>s.toFixed(1)+'s'});
  document.getElementById('scoresBtn').onclick=scores.show;
  let startTime=0, penalty=0, timerId=null;
  let moves=0;
  let bestTime=parseFloat(localStorage.getItem('mfBestTime'))||null;
  let bestMoves=parseInt(localStorage.getItem('mfBestMoves'))||null;
  const foundPairsLabel=globalThis.i18n?.t('foundPairs')||'Found pairs';
  let sel=0;

  function startTimer(){
    startTime=performance.now();
    penalty=0;
    clearInterval(timerId);
    timerId=setInterval(()=>{
      const t=((performance.now()-startTime)/1000)+penalty;
      timeBoard.set(t.toFixed(1)+'—Å', bestTime!=null?bestTime.toFixed(1)+'—Å':null);
    },100);
  }
  function stopTimer(){clearInterval(timerId);}
  function shuffle(array){
    for(let i=array.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [array[i],array[j]]=[array[j],array[i]];
    }
    return array;
  }
  function select(idx){ if(cards[sel]) cards[sel].classList.remove('sel'); sel=idx; if(cards[sel]){ cards[sel].classList.add('sel'); cards[sel].focus(); } }
  function moveSel(dir){
    const cols=4;
    let r=Math.floor(sel/cols), c=sel%cols;
    if(dir==='left') c=(c+cols-1)%cols;
    else if(dir==='right') c=(c+1)%cols;
    else if(dir==='up') r=(r+cols-1)%cols;
    else if(dir==='down') r=(r+1)%cols;
    select(r*cols+c);
  }
  function resetGame(){
    startBtn.disabled=false;
    grid.innerHTML='';
    const values=shuffle(icons.concat(icons));
    cards=[];
    matchedCount=0;
    scoreEl.textContent=foundPairsLabel+': 0/8';
    moves=0;
    timeBoard.set('0s', bestTime!=null?bestTime.toFixed(1)+'s':null);
    movesBoard.set(0, bestMoves);
    values.forEach(val=>{
      const card=document.createElement('div');
      card.className='card';
      card.dataset.value=val;
      card.innerHTML='<div class="card-inner"><div class="face front"></div><div class="face back"><img src="'+val+'" alt=""></div></div>';
      card.addEventListener('click',()=>handleCard(card));
      card.tabIndex=0;
      card.setAttribute('role','button');
      card.setAttribute('aria-label',globalThis.i18n?.t('card')||'Card');
      card.addEventListener('keydown',e=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); handleCard(card); }
      });
      grid.appendChild(card);
      cards.push(card);
    });
    firstCard=secondCard=null;
    stopTimer();
    timerEl.textContent='0s';
    gameActive=false;
    select(0);
  }

  function startGame(skipReset){
    if(!skipReset) resetGame();
    document.querySelector('.popup')?.remove();
    startBtn.disabled=true;
    gameActive=true;
    startTimer();
    movesBoard.set(0,bestMoves);
    Sound.fx('start');
  }
  function handleCard(card){
    if(!gameActive){
      startGame(true);
    }
    if(card.classList.contains('open') || card.classList.contains('matched') || secondCard) return;
    reveal(card);
    if(!firstCard){
      firstCard=card;
    }else{
      secondCard=card;
      moves++;
      movesBoard.set(moves,bestMoves);
      if(firstCard.dataset.value===secondCard.dataset.value){
        firstCard.classList.add('matched');
        secondCard.classList.add('matched');
        matchedCount++;
        Sound.fx('coin');
        scoreEl.textContent=foundPairsLabel+': '+matchedCount+'/8';
        firstCard=secondCard=null;
        if(matchedCount===icons.length){
          stopTimer();
          const total=((performance.now()-startTime)/1000)+penalty;
          if(bestTime==null || total<bestTime){
            bestTime=total;
            localStorage.setItem('mfBestTime',bestTime);
            showToast('New record time: '+total.toFixed(1)+'s');
          }else{
          showToast((globalThis.i18n?.t('time')||'Time')+': '+total.toFixed(1)+'s');
          }
          scores.add(total);
          if(bestMoves==null || moves<bestMoves){
            bestMoves=moves;
            localStorage.setItem('mfBestMoves',bestMoves);
          }
          Sound.fx('start');
          resetGame();
        }
      }else{
        penalty+=0.5;
        Sound.fx('error');
        firstCard.classList.add('wrong');
        secondCard.classList.add('wrong');
        setTimeout(()=>{
          hide(firstCard);
          hide(secondCard);
          firstCard.classList.remove('wrong');
          secondCard.classList.remove('wrong');
          firstCard=secondCard=null;
        },700);
      }
    }
  }
  function reveal(card){
    card.classList.add('open');
  }
  function hide(card){
    card.classList.remove('open');
  }
  startBtn.addEventListener('click',startGame);
  const setBtn=UI.attachDPad(pad,moveSel);
  pad.querySelector('[data-btn="a"]').addEventListener('click',()=>{ if(cards[sel]) handleCard(cards[sel]); });
  document.addEventListener('keydown',e=>{
    const k=e.key;
    if(k==='ArrowLeft'){ moveSel('left'); setBtn('left',true); e.preventDefault(); }
    else if(k==='ArrowRight'){ moveSel('right'); setBtn('right',true); e.preventDefault(); }
    else if(k==='ArrowUp'){ moveSel('up'); setBtn('up',true); e.preventDefault(); }
    else if(k==='ArrowDown'){ moveSel('down'); setBtn('down',true); e.preventDefault(); }
    else if(k==='Enter' || k===' '){ if(cards[sel]) handleCard(cards[sel]); e.preventDefault(); }
  });
  document.addEventListener('keyup',e=>{
    const k=e.key;
    if(k==='ArrowLeft') setBtn('left',false);
    else if(k==='ArrowRight') setBtn('right',false);
    else if(k==='ArrowUp') setBtn('up',false);
    else if(k==='ArrowDown') setBtn('down',false);
  });
  function adjustGrid(){
    const GAP=6, cols=4;
    const availableHeight=window.innerHeight - header.offsetHeight - scoreEl.offsetHeight - timerEl.offsetHeight - 48;
    const availableWidth=play.clientWidth;
    const base=Math.min(availableWidth, availableHeight);
    const card=Math.floor((base - GAP*(cols-1))/cols);
    const size=card*cols + GAP*(cols-1);
    grid.style.width=size+'px';
    grid.style.height=size+'px';
  }
  window.addEventListener('resize',adjustGrid);
  adjustGrid();
  resetGame();
})();
</script>
</body>
</html>
