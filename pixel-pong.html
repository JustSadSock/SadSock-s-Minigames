<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#14110e">
<title data-i18n="pixelPong"></title>
<link rel="stylesheet" href="styles/shell.css">
  <link rel="stylesheet" href="styles/game.css">
<style>
  #startScreen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.6);gap:8px;}
  #startScreen.hidden{display:none;}
  .color-pick{display:flex;gap:4px;}
  .color-pick button{width:32px;height:32px;border:2px solid var(--bezel);border-radius:8px;box-shadow:inset 0 0 0 2px var(--bezel-hi);cursor:pointer;}
  .color-pick button.sel{outline:2px solid var(--accent);}
</style>
</head>
<body>
<div class="cabinet">
    <div class="frame">
    <div class="inner">
      <canvas class="icon" data-icon="pong" aria-hidden="true"></canvas>
      <div class="hud hud-3">
        <div class="counter" id="score">0 : 0</div>
        <button class="pill" id="scoresBtn" data-i18n-aria-label="records">üèÜ</button>
        <div class="counter" id="status">‚Äî</div>
      </div>
      <button id="settingsBtn" class="pill settings-btn" data-i18n-aria-label="settings">‚öôÔ∏è</button>
      <canvas id="cv" class="bg-stripes" tabindex="0" data-i18n-aria-label="gameField"></canvas>
      <div class="scanlines"></div>
      <div id="startScreen">
        <div id="colorPick" class="color-pick" title="Paddle color">
          <button data-col="--pastel-mint" style="background:var(--pastel-mint)"></button>
          <button data-col="--pastel-blue" style="background:var(--pastel-blue)"></button>
          <button data-col="--pastel-pink" style="background:var(--pastel-pink)"></button>
          <button data-col="--pastel-peach" style="background:var(--pastel-peach)"></button>
        </div>
        <label style="color:#fff;font-family:'Press Start 2P',ui-monospace,monospace;font-size:12px">AI:
          <select id="aiSelect">
            <option value="0">Easy</option>
            <option value="1" selected>Normal</option>
            <option value="2">Hard</option>
          </select>
        </label>
        <button id="playBtn" class="pill" data-i18n="start" data-i18n-aria-label="start"></button>
      </div>
    </div>
    <div id="pad" class="pad pad-center" aria-hidden="true">
      <div class="dpad" aria-hidden="true">
        <div class="k" data-btn="up" style="grid-area:up"><canvas data-icon="arrow-up"></canvas></div>
        <div class="k" data-btn="left" style="grid-area:left"><canvas data-icon="arrow-left"></canvas></div>
        <div class="k" style="grid-area:mid;opacity:.35"></div>
        <div class="k" data-btn="right" style="grid-area:right"><canvas data-icon="arrow-right"></canvas></div>
        <div class="k" data-btn="down" style="grid-area:down"><canvas data-icon="arrow-down"></canvas></div>
      </div>
      <div class="ab">
        <div class="k" data-btn="a">A</div>
        <div class="k" data-btn="b">B</div>
      </div>
    </div>
    <div class="label">Pixel Pong</div>
    <div class="hint">Pong: ‚Üë/‚Üì. Space to dash.</div>
  </div>
  <div class="footer">Mobile arrows ‚Ä¢ Keyboard: ‚Üë/‚Üì, Space to dash</div>
</div>

<script type="module">
import './src/ui.js';
import './src/audio.js';
import './src/scores.js';
import './src/icons.js';
import './src/i18n.js';
import { initSettings } from './src/settings.js';
initSettings();

(() => {
  const SETTINGS = { W:360, H:640, sfx:0.6 };
  const d = (s)=>document.querySelector(s);
  const scoreEl=d('#score'), statusEl=d('#status'), cv=d('#cv'), pad=d('#pad');
  const startScreen=d('#startScreen'), playBtn=d('#playBtn'), hint=d('.hint');
  const colorPick=d('#colorPick'), aiSelect=d('#aiSelect');
  const scores=Scores('pong');
  d('#scoresBtn').onclick=scores.show;
  let best=parseInt(localStorage.getItem('pongBest')||'0',10);
  const scoreBoard=UI.score(scoreEl,globalThis.i18n?.t('score')||'Score');
  scoreBoard.set('0 : 0',best);
  const ctx=cv.getContext('2d');
  const styles=getComputedStyle(document.documentElement);
  const storedCol=localStorage.getItem('pongColor')||'--pastel-mint';
  let paddleColor='';
  function setColor(v){ paddleColor=styles.getPropertyValue(v).trim(); localStorage.setItem('pongColor',v); colorPick.querySelectorAll('button').forEach(b=>b.classList.toggle('sel',b.dataset.col===v)); }
  colorPick.querySelectorAll('button').forEach(b=>b.addEventListener('click',()=>setColor(b.dataset.col)));
  setColor(storedCol);
  let difficulty=parseInt(localStorage.getItem('pongAI')||'1',10);
  aiSelect.value=difficulty;
  aiSelect.addEventListener('change',()=>{difficulty=parseInt(aiSelect.value,10); localStorage.setItem('pongAI',aiSelect.value);});
  const startLabel=globalThis.i18n?.t('start')||'Start';
  const restartLabel=globalThis.i18n?.t('restart')||'Restart';
  function showStart(text=startLabel){ startScreen.classList.remove('hidden'); playBtn.textContent=text; }
  function startGame(){ startScreen.classList.add('hidden'); if(hint) hint.style.display='none'; game.started=true; Sound.fx('start'); }
  playBtn.addEventListener('click',()=>{ if(game.over) game.reset(); startGame(); });
  function resize(){ const pr=Math.max(1,Math.floor(devicePixelRatio||1));
    const r=cv.getBoundingClientRect(); cv.width=Math.floor(r.width*pr); cv.height=Math.floor(r.height*pr);
  }
  function clear(){ ctx.clearRect(0,0,cv.width,cv.height); }
  window.addEventListener('resize',resize);

  // Input
  const Input = (()=>{
    const st={left:false,right:false,up:false,down:false,a:false,b:false};
    const map={ArrowLeft:'left',ArrowRight:'right',ArrowUp:'up',ArrowDown:'down',' ':'a',Enter:'b',a:'a',A:'a',z:'b',Z:'b',w:'up',W:'up',s:'down',S:'down',d:'right',D:'right'};
    const set=(btn,val)=>{ st[btn]=val; const el=pad.querySelector(`[data-btn="${btn}"]`); if(el) el.classList.toggle('down',val); };
    addEventListener('keydown',e=>{const b=map[e.key]; if(b){set(b,true); e.preventDefault();}});
    addEventListener('keyup',e=>{const b=map[e.key]; if(b){set(b,false); e.preventDefault();}});
    pad.querySelectorAll('[data-btn]').forEach(el=>{
      const btn=el.dataset.btn;
      const on=(e)=>{set(btn,true); e.preventDefault();};
      const off=(e)=>{set(btn,false); e.preventDefault();};
      el.addEventListener('touchstart',on,{passive:false});
      el.addEventListener('touchend',off,{passive:false});
      el.addEventListener('touchcancel',off,{passive:false});
      el.addEventListener('mousedown',on);
      addEventListener('mouseup',off);
      el.addEventListener('mouseleave',off);
    });
    UI.autoHidePad(pad);
    return {st};
  })();

  // Helpers
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const irnd=(a,b)=>Math.floor(rnd(a,b+1));

  // ===== Game specific code =====
  
  const game = {
    name:'Pong', score:0, over:false, started:false, level:0,
    init(){ this.pw=10; this.ph=80; this.reset(); loop(); },
    reset(){ this.score=0; this.over=false; this.started=false; this.level=0;
      scoreBoard.set('0 : 0',best);
      this.pColor=paddleColor; this.difficulty=difficulty;
      this.p1={x:18,y:SETTINGS.H/2-this.ph/2,s:260};
      this.p2={x:SETTINGS.W-18-this.pw,y:SETTINGS.H/2-this.ph/2,s:220+this.difficulty*40};
      this.s1=0; this.s2=0;
      this.resetBall(Math.random()<.5?1:-1);
    },
    step(dt){
      const I=Input.st;
      if(!this.started){ if(I.a||I.b||I.up||I.down||I.left||I.right){ if(this.over) this.reset(); startGame(); } else return; }
      if(I.up) this.p1.y-=this.p1.s*dt;
      if(I.down) this.p1.y+=this.p1.s*dt;
      this.p1.y=clamp(this.p1.y,10,SETTINGS.H-10-this.ph);
      const target=this.b.y - this.ph/2;
      this.p2.y += clamp(target - this.p2.y, -this.p2.s*dt, this.p2.s*dt);
      this.p2.y=clamp(this.p2.y,10,SETTINGS.H-10-this.ph);
      const b=this.b; b.x+=b.vx*dt; b.y+=b.vy*dt;
      if(b.y-b.r<6){ b.y=6+b.r; b.vy*=-1; }
      if(b.y+b.r>SETTINGS.H-6){ b.y=SETTINGS.H-6-b.r; b.vy*=-1; }
      const hit=(px,py,pw,ph,sgn)=>{
        if(b.x-b.r<px+pw && b.x+b.r>px && b.y+b.r>py && b.y-b.r<py+ph){
          b.x = sgn>0? px+pw+b.r : px-b.r;
          b.vx = Math.sign(sgn)*Math.max(160, Math.abs(b.vx)+20);
          const off=(b.y-(py+ph/2))/(ph/2); b.vy=clamp(b.vy+off*180,-260,260);
        }
      };
      hit(this.p1.x,this.p1.y,this.pw,this.ph,+1);
      hit(this.p2.x,this.p2.y,this.pw,this.ph,-1);
      if(b.x<-20){ this.s2++; Sound.fx('coin'); this.resetBall(-1); }
      if(b.x>SETTINGS.W+20){ this.s1++; Sound.fx('coin'); this.resetBall(+1); }
      this.score=Math.max(this.s1,this.s2);
  if(this.s1>=7||this.s2>=7){ Sound.fx('error'); this.over=true; this.started=false; if(this.score>best){best=this.score; localStorage.setItem('pongBest',best);} scores.add(this.score); showStart(restartLabel); }
    },
    resetBall(dir){
      const speed=180 + this.level*20 + this.difficulty*20;
      this.b={x:SETTINGS.W/2,y:SETTINGS.H/2,vx:dir*speed,vy:rnd(-140,140),r:6};
      this.p1.s=260 + this.level*10;
      this.p2.s=220 + this.difficulty*40 + this.level*10;
      this.level++;
    },
    draw(){
      ctx.save(); const sx=cv.width/SETTINGS.W, sy=cv.height/SETTINGS.H; ctx.scale(sx,sy);
      ctx.fillStyle='#e6c28a'; for(let y=10;y<SETTINGS.H;y+=18) ctx.fillRect(SETTINGS.W/2-2,y,4,10);
      ctx.fillStyle=this.pColor; ctx.fillRect(this.p1.x,this.p1.y,this.pw,this.ph); ctx.fillRect(this.p2.x,this.p2.y,this.pw,this.ph);
      ctx.fillStyle='#d18f3f'; ctx.beginPath(); ctx.arc(this.b.x,this.b.y,this.b.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
  };
  let last=performance.now();
  function loop(){ requestAnimationFrame(loop); resize(); clear(); const t=performance.now(), dt=Math.min(.033,(t-last)/1000); last=t;
    game.step(dt); game.draw(); scoreBoard.set(`${game.s1} : ${game.s2}`,best); }
  game.init();


})();
</script>
</body>
</html>
