<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title data-i18n="pixelAnimator"></title>
<link rel="stylesheet" href="styles/shell.css">
<style>
  :root{
    --panel:var(--tile-bg);
    --panel-deep:var(--bezel);
    --amber:var(--accent3);
    --muted:var(--dim);
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{
    margin:0;color:var(--ink);
    display:flex;align-items:center;justify-content:center;
    padding:16px;box-sizing:border-box;height:100svh;overflow:hidden;
    background:var(--bg0);
  }
  .frame{width:min(1100px,100%);height:100%;}
  .content{position:relative;z-index:1;flex:1;display:flex;flex-direction:column;gap:10px;}
  .tabs{display:flex;gap:10px;align-self:center}
  .tab.active{outline:2px solid var(--amber);}
  .workspace{flex:1;min-height:0;display:grid;grid-template-columns:1fr;grid-template-rows:1fr auto;gap:10px}
  @media (min-width:940px){.workspace{grid-template-columns:minmax(320px,1fr) 420px;grid-template-rows:1fr}}
  .panel{position:relative;background:var(--panel);border-radius:14px;padding:10px;box-shadow:0 6px 0 var(--panel-deep),inset 0 0 0 2px var(--bezel-hi);min-height:0}
  .panel::after{content:"";position:absolute;right:8px;bottom:8px;width:18px;height:18px;border:4px solid var(--bezel);border-top:0;border-left:0;border-radius:0 0 14px 0;opacity:.8}
  .screen{position:relative;display:grid;place-items:center;height:100%;}
  .canvasWrap{position:relative;width:100%;height:100%;display:grid;place-items:center;}
  .square{position:relative}
  #paint{display:block;image-rendering:pixelated;background:#000;border-radius:8px;box-shadow:0 6px 16px #0002;width:100%;height:100%}
  .tools{display:flex;flex-direction:column;gap:10px;min-height:0}
  .tools .panel{overflow:auto}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chip{width:26px;height:26px;border:2px solid #543;border-radius:6px;box-shadow:inset 0 0 0 2px #fff6;cursor:pointer}
  .chip[selected]{box-shadow:0 0 0 3px var(--accent),inset 0 0 0 2px #fff6}
  .tool{padding:6px 8px;}
  .tool[data-danger]{--btn-border:#e09a9a;--btn-shadow:#c27979;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  label{font-size:12px;color:var(--muted);font-weight:700}
  input,button,select,textarea{font-family:'Press Start 2P',ui-monospace,monospace}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--amber)}
  input[type="checkbox"]{appearance:none;width:20px;height:20px;margin:0;cursor:pointer;padding:0;border:2px solid var(--bezel);border-radius:4px;background:var(--tile-bg);box-shadow:0 2px 0 var(--bezel-lo),inset 0 0 0 2px var(--bezel-hi);}
  input[type="checkbox"]:checked{background:var(--accent)}
  .timeline{display:flex;gap:8px;overflow:auto;padding:6px}
  details.accordion>summary{cursor:pointer;list-style:none}
  details.accordion>summary::-webkit-details-marker{display:none}
  .thumb{position:relative;min-width:56px;min-height:56px;background:var(--tile-bg);border:2px solid var(--bezel);border-radius:10px;display:grid;place-items:center;cursor:pointer}
  .thumb canvas{image-rendering:pixelated;border-radius:6px}
  .thumb.active{outline:3px solid var(--amber)}
  .thumb .num{position:absolute;left:6px;top:4px;background:#0004;color:#fff;font-size:10px;padding:2px 4px;border-radius:6px}
  textarea{width:100%;min-height:220px;resize:vertical;background:#121212;color:#c1f2b0;border:2px solid #28342a;border-radius:12px;padding:10px}
  textarea.code{font-family:ui-monospace,monospace}
  .codeBox{background:#0c0f12;color:#cbe4ff;border:2px solid #2a405b;border-radius:12px;padding:10px;overflow:auto;max-height:220px;font-family:ui-monospace,monospace}

  .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--amber);border:2px solid var(--bezel);border-radius:8px;padding:8px 12px;font-size:14px;color:var(--ink);}

  @media (max-width:600px){
    .workspace{grid-template-columns:1fr;grid-template-rows:1fr auto}
    .tools{max-height:50svh;overflow:auto}
    .tools .panel> .row{flex-direction:column;align-items:flex-start}
  }

  @media (min-width:601px){
    details.accordion>summary{display:none}
  }
</style>
</head>
<body class="theme-blue">
  <div class="cabinet">
    <div class="frame">
      <div class="inner">
        <div class="content">
          <canvas class="icon" data-icon="anim" aria-hidden="true"></canvas>
          <div class="tabs">
            <button class="tab active" data-tab="edit">üé® –†–µ–¥–∞–∫—Ç–æ—Ä</button>
            <button class="tab" data-tab="io">üì§ –ò–º–ø–æ—Ä—Ç ¬∑ –≠–∫—Å–ø–æ—Ä—Ç</button>
          </div>
          <section id="tab-edit" class="workspace">
            <div class="panel screen">
              <div class="canvasWrap">
                <div id="square" class="square">
                  <canvas id="paint" tabindex="0" aria-label="–ü–æ–ª–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è"></canvas>
                </div>
              </div>
            </div>
            <div class="tools">
          <div class="panel">
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <button class="pill tool" id="tool-pen" title="–ö–∏—Å—Ç—å"><img style="image-rendering:pixelated" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><rect x='0' y='5' width='8' height='3' fill='%23b97a56'/><rect x='6' y='3' width='2' height='2' fill='%23ccc'/><rect x='6' y='1' width='2' height='2' fill='%23000'/></svg>" width="16" height="16" alt="–ö–∏—Å—Ç—å"></button>
                <button class="pill tool" id="tool-erase" title="–õ–∞—Å—Ç–∏–∫"><img style="image-rendering:pixelated" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><rect x='1' y='2' width='6' height='4' fill='%23f99'/><rect x='1' y='2' width='3' height='4' fill='%23fcc'/></svg>" width="16" height="16" alt="–õ–∞—Å—Ç–∏–∫"></button>
                <button class="pill tool" id="tool-pick" title="–ü–∏–ø–µ—Ç–∫–∞"><img style="image-rendering:pixelated" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><rect x='0' y='6' width='2' height='2' fill='%23000'/><rect x='1' y='5' width='2' height='2' fill='%23999'/><rect x='2' y='3' width='2' height='2' fill='%23999'/><rect x='3' y='2' width='2' height='2' fill='%23999'/><rect x='4' y='0' width='4' height='2' fill='%23f0f'/><rect x='5' y='2' width='3' height='2' fill='%23f0f'/><rect x='6' y='4' width='2' height='2' fill='%23f0f'/></svg>" width="16" height="16" alt="–ü–∏–ø–µ—Ç–∫–∞"></button>
              </div>
              <div class="row">
                <label title="–ö–∞–¥—Ä—ã –≤ —Å–µ–∫—É–Ω–¥—É">FPS</label>
                <pixel-range title="–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏"><input id="fps" type="range" min="1" max="24" value="6" /></pixel-range>
                <button class="pill tool" id="play" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏">‚ñ∂Ô∏è</button>
                <button class="pill tool" id="stop" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">‚èπ</button>
                <label class="row" style="gap:6px" title="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä"><input id="onion" type="checkbox"/><img style="image-rendering:pixelated" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><rect x='3' y='0' width='2' height='1' fill='%236c0'/><rect x='2' y='1' width='4' height='2' fill='%23d6a'/><rect x='1' y='2' width='6' height='3' fill='%23f9c'/><rect x='2' y='4' width='4' height='3' fill='%23d6a'/></svg>" width="16" height="16" alt="Onion"></label>
                <label class="row" style="gap:6px" title="–ó–µ—Ä–∫–∞–ª—å–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ"><input id="mirror" type="checkbox"/><img style="image-rendering:pixelated" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8' shape-rendering='crispEdges'><rect x='3' y='0' width='2' height='8' fill='%23bbb'/><rect x='0' y='2' width='3' height='4' fill='%236cf'/><rect x='5' y='2' width='3' height='4' fill='%236cf'/></svg>" width="16" height="16" alt="Mirror"></label>
              </div>
            </div>
            <div class="toolbar" id="palette" style="margin-top:8px"></div>
            <div class="row" style="justify-content:space-between; margin-top:6px">
              <div class="row">
                <button class="btn tool" id="add-frame">‚ûï –ö–∞–¥—Ä</button>
                <button class="btn tool" id="dup-frame">‚ßâ –î—É–±–ª–∏–∫–∞—Ç</button>
                <button class="btn tool" id="del-frame" data-danger>üóë –£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn tool" id="undo">‚Ü∂ Undo</button>
              </div>
              <div class="muted">–¢–µ–∫—É—â–∏–π: <span id="curIndex">1</span>/<span id="totalFrames">1</span></div>
            </div>
          </div>
          <details class="panel accordion" open>
            <summary style="display:block;margin-bottom:6px">–ö–∞–¥—Ä—ã</summary>
            <div id="timeline" class="timeline"></div>
          </details>
        </div>
      </section>
      <section id="tab-io" class="panel" style="display:none">
        <div class="row" style="justify-content:space-between; flex-wrap:wrap">
          <div class="row" style="gap:8px">
            <button class="btn tool" id="btn-export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button class="btn tool" id="btn-import">–ò–º–ø–æ—Ä—Ç JSON</button>
            <button class="btn tool" id="btn-copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn tool" id="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn tool" id="btn-download">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
            <button class="btn tool" id="btn-upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
            <button class="btn tool" id="btn-png" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PNG">PNG</button>
            <button class="btn tool" id="btn-gif" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ GIF">GIF</button>
          </div>
          <div class="row">
            <button class="btn tool" id="btn-gencode">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∫–æ–¥</button>
            <button class="btn tool" id="btn-record" title="–≠–∫—Å–ø–æ—Ä—Ç WebM (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)">üé¨ WebM</button>
          </div>
        </div>
        <textarea id="io" class="code"></textarea>
        <p class="muted">–§–æ—Ä–º–∞—Ç: { grid:16, palette:["#RRGGBB",...], frames:[ [–∏–Ω–¥–µ–∫—Å—ã –ø–∞–ª–∏—Ç—Ä—ã –¥–ª–∏–Ω–æ–π 256], ... ], fps:n }</p>
        <div id="embed" class="codeBox" style="display:none"></div>
      </section>
    </div>
        <div class="scanlines"></div>
      </div>
      <div id="pad" class="pad">
        <div class="dpad" aria-hidden="true">
          <div class="k" data-dir="up" style="grid-area:up">‚ñ≤</div>
          <div class="k" data-dir="left" style="grid-area:left">‚óÑ</div>
          <div class="k" style="grid-area:mid; opacity:.35"></div>
          <div class="k" data-dir="right" style="grid-area:right">‚ñ∫</div>
          <div class="k" data-dir="down" style="grid-area:down">‚ñº</div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
<script src="src/ui.js"></script>
<script src="src/icons.js"></script>
<script>
(function(){
  const GRID = 16;
  const LEN = GRID*GRID;
  const toast=UI.makeToast(document.getElementById('toast'));
  document.querySelectorAll('details.accordion').forEach(d=>{
    if(window.matchMedia('(max-width:600px)').matches) d.removeAttribute('open');
  });
  let fps = 6;
  let palette = [null, "#000000", "#ffffff", "#4aa9ff", "#ff4757", "#ffd166", "#06d6a0", "#8338ec", "#ff99c8", "#8d99ae", "#2b2d42"];
  let currentColorIndex = 3;
  let frames = [new Uint16Array(LEN)];
  let cur = 0;
  const history = []; let hpos = -1;
  function pushHistory(){
    const copy = new Uint16Array(frames[cur]);
    history.splice(hpos+1); history.push({i:cur, data:copy}); hpos = history.length-1;
  }
  function undo(){ if(hpos>=0){ frames[cur].set(history[hpos].data); hpos--; render(); refreshThumb(cur); }}
  const square = document.getElementById('square');
  const canvas = document.getElementById('paint');
  const ctx = canvas.getContext('2d', {alpha:true});
  canvas.width = canvas.height = GRID;
  ctx.imageSmoothingEnabled = false;
  function fitSquare(){
    const parent = square.parentElement;
    const w = parent.clientWidth; const h = parent.clientHeight;
    const s = Math.min(w,h);
    square.style.width = s + 'px';
    square.style.height = s + 'px';
  }
  const ro = new ResizeObserver(fitSquare);
  ro.observe(document.querySelector('.canvasWrap'));
  window.addEventListener('orientationchange', ()=> setTimeout(fitSquare, 100));
  fitSquare();
  let tool = 'pen';
  document.getElementById('tool-pen').onclick = ()=> tool='pen';
  document.getElementById('tool-erase').onclick = ()=> tool='erase';
  document.getElementById('tool-pick').onclick = ()=> tool='pick';
  document.getElementById('undo').onclick = undo;
  let drawing=false;
  canvas.addEventListener('pointerdown', e=>{ drawing=true; canvas.setPointerCapture(e.pointerId); drawAtEvent(e); pushHistory(); });
  canvas.addEventListener('pointermove', e=>{ if(drawing) drawAtEvent(e); });
  window.addEventListener('pointerup', ()=> drawing=false);
  function posFromEvent(e){
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / (rect.width / GRID));
    const y = Math.floor((e.clientY - rect.top)  / (rect.height/ GRID));
    return {x:Math.max(0,Math.min(GRID-1,x)), y:Math.max(0,Math.min(GRID-1,y))};
  }
  function drawAtEvent(e){
    const {x,y} = posFromEvent(e);
    const idx = y*GRID + x;
    if(tool==='pick'){
      const ci = frames[cur][idx];
      if(ci!==undefined){ selectColor(ci); }
      return;
    }
    const val = (tool==='erase')? 0 : currentColorIndex;
    if(frames[cur][idx] !== val){
      frames[cur][idx] = val;
      renderCell(x,y,val);
      if(document.getElementById('mirror').checked){
        const mx = GRID-1-x;
        if(mx!==x){
          const midx = y*GRID+mx;
          frames[cur][midx]=val;
          renderCell(mx,y,val);
        }
      }
      refreshThumb(cur);
    }
  }
  function drawChecker(ctx){
    const s1 = '#111', s2 = '#1a1a1a';
    for(let y=0;y<GRID;y++){
      for(let x=0;x<GRID;x++){
        const on = ((x>>1) + (y>>1)) & 1;
        ctx.fillStyle = on ? s2 : s1;
        ctx.fillRect(x, y, 1, 1);
      }
    }
  }
  function render(){
    ctx.clearRect(0,0,GRID,GRID);
    drawChecker(ctx);
    if(document.getElementById('onion').checked && cur>0){
      const prev = frames[cur-1];
      for(let i=0;i<LEN;i++){
        const cindex = prev[i]; if(!cindex) continue;
        const hex = palette[cindex]; if(!hex) continue;
        const x=i%GRID, y=(i/GRID)|0; ctx.fillStyle=hex+"66"; ctx.fillRect(x,y,1,1);
      }
    }
    const f = frames[cur];
    for(let i=0;i<LEN;i++){
      const cindex = f[i]; if(!cindex) continue; const hex = palette[cindex]; if(!hex) continue;
      const x=i%GRID, y=(i/GRID)|0; ctx.fillStyle=hex; ctx.fillRect(x,y,1,1);
    }
  }
  function renderCell(x,y,ci){
    const on = ((x>>1) + (y>>1)) & 1; ctx.fillStyle = on? '#1a1a1a':'#111'; ctx.fillRect(x,y,1,1);
    if(document.getElementById('onion').checked && cur>0){
      const prev = frames[cur-1][y*GRID+x]; if(prev){ ctx.fillStyle = (palette[prev]||'#000')+"66"; ctx.fillRect(x,y,1,1); }
    }
    if(ci){ ctx.fillStyle = palette[ci] || '#000'; ctx.fillRect(x,y,1,1); }
  }
  render();
  const pal = document.getElementById('palette');
  function rebuildPalette(){ pal.innerHTML='';
    palette.forEach((hex,i)=>{
      if(i===0) return;
      const d = document.createElement('div'); d.className='chip'; d.style.background=hex; d.title=hex;
      if(i===currentColorIndex) d.setAttribute('selected','');
      d.addEventListener('click', ()=> selectColor(i)); pal.appendChild(d);
    });
    const tr = document.createElement('div'); tr.className='chip'; tr.style.background = 'repeating-conic-gradient(#0000 0 25%, #fff6 0 50%) 0/10px 10px, #999';
    tr.title='–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π (–ª–∞—Å—Ç–∏–∫)'; tr.addEventListener('click', ()=>{tool='erase'}); pal.appendChild(tr);
  }
  function selectColor(i){ currentColorIndex=i; tool='pen'; rebuildPalette(); }
  rebuildPalette();
  const curIndexEl = document.getElementById('curIndex');
  const totalEl    = document.getElementById('totalFrames');
  const timeline   = document.getElementById('timeline');
  function updateCounters(){ curIndexEl.textContent = (cur+1); totalEl.textContent = frames.length; }
  function makeThumb(i){
    const el = document.createElement('div'); el.className='thumb'; el.dataset.i=i;
    const num = document.createElement('div'); num.className='num'; num.textContent = i+1; el.appendChild(num);
    const c = document.createElement('canvas'); c.width=GRID; c.height=GRID; c.style.width='44px'; c.style.height='44px'; c.style.imageRendering='pixelated'; el.appendChild(c);
    el.addEventListener('click', ()=>{ cur = i; updateCounters(); highlightThumb(); render(); });
    return el;
  }
  function refreshThumb(i){
    const el = timeline.querySelector(`.thumb[data-i="${i}"] canvas`);
    if(!el) return; const tctx = el.getContext('2d');
    tctx.clearRect(0,0,GRID,GRID); const f = frames[i];
    for(let p=0;p<LEN;p++){ const ci=f[p]; if(!ci) continue; tctx.fillStyle = palette[ci]; tctx.fillRect(p%GRID,(p/GRID)|0,1,1); }
  }
  function rebuildTimeline(){ timeline.innerHTML='';
    frames.forEach((_,i)=>{ const t = makeThumb(i); timeline.appendChild(t); refreshThumb(i); });
    highlightThumb(); updateCounters();
  }
  function highlightThumb(){ timeline.querySelectorAll('.thumb').forEach((t,idx)=>{ t.classList.toggle('active', idx===cur); }); }
  function stepFrame(d){ cur=Math.max(0,Math.min(frames.length-1,cur+d)); highlightThumb(); updateCounters(); render(); }
  rebuildTimeline();
  const pad=document.getElementById('pad');
  UI.attachDPad(pad,dir=>{ if(dir==='left') stepFrame(-1); else if(dir==='right') stepFrame(1); });
  document.getElementById('add-frame').onclick = ()=>{ frames.push(new Uint16Array(LEN)); cur = frames.length-1; pushHistory(); rebuildTimeline(); render(); };
  document.getElementById('dup-frame').onclick = ()=>{ const dup = new Uint16Array(frames[cur]); frames.splice(cur+1,0,dup); cur++; rebuildTimeline(); render(); };
  document.getElementById('del-frame').onclick = ()=>{ if(frames.length>1){ frames.splice(cur,1); cur=Math.max(0,cur-1); rebuildTimeline(); render(); } };
  let timer=null; const fpsInput = document.getElementById('fps');
  fpsInput.addEventListener('input', ()=>{ fps = parseInt(fpsInput.value,10); if(timer){ clearInterval(timer); timer=null; play(); } }); fps = parseInt(fpsInput.value,10);
  document.getElementById('play').onclick = play;
  document.getElementById('stop').onclick = ()=>{ clearInterval(timer); timer=null; };
  function play(){ if(timer) return; let i=cur; timer = setInterval(()=>{ cur = i++ % frames.length; highlightThumb(); updateCounters(); render(); }, 1000/Math.max(1,fps) ); }
  const io = document.getElementById('io');
  function pack(){ return { grid:GRID, fps, palette, frames: frames.map(f=> Array.from(f)) }; }
  function unpack(obj){
    if(!obj || obj.grid!==GRID || !Array.isArray(obj.frames)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
    palette = obj.palette || palette; fps = obj.fps || fps; document.getElementById('fps').value=fps;
    frames = obj.frames.map(arr=> Uint16Array.from(arr)); cur=0; rebuildPalette(); rebuildTimeline(); render();
  }
  function saveLS(){ localStorage.setItem('ss_pixel_animator', JSON.stringify(pack())); }
  function loadLS(){ const data=localStorage.getItem('ss_pixel_animator'); if(data){ try{unpack(JSON.parse(data));}catch(e){} } }
  document.getElementById('btn-export').onclick = ()=>{ io.value = JSON.stringify(pack()); io.scrollTop=0; };
  document.getElementById('btn-import').onclick = ()=>{ try{ const data = JSON.parse(io.value); unpack(data); }catch(e){ toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message); } };
  document.getElementById('btn-copy').onclick   = async()=>{ try{ await navigator.clipboard.writeText(io.value); }catch{} };
  document.getElementById('btn-gencode').onclick = ()=>{
    const data = JSON.stringify(pack());
    const code = `<!-- –í–°–¢–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –í –°–ê–ô–¢ -->\n<canvas id=anim width=16 height=16 style="image-rendering:pixelated;width:100%;max-width:256px;aspect-ratio:1/1;background:#000;border-radius:8px"></canvas>\n<script>\nconst DATA = ${data};\n(function(){\n  const c=document.getElementById('anim'); const x=c.getContext('2d'); const G=DATA.grid; const L=G*G; let i=0; x.imageSmoothingEnabled=false;\n  function draw(frame){ x.clearRect(0,0,G,G); for(let p=0;p<L;p++){ const ci=frame[p]; if(!ci) continue; x.fillStyle=DATA.palette[ci]; x.fillRect(p%G,(p/G)|0,1,1); } }\n  setInterval(()=>{ const fr = Uint16Array.from(DATA.frames[i++%DATA.frames.length]); draw(fr); }, 1000/(DATA.fps||6));\n})();\n<\/script>`;
    const box = document.getElementById('embed'); box.style.display='block'; box.textContent = code;
  };
  document.getElementById('btn-save').onclick = saveLS;
  document.getElementById('btn-download').onclick = ()=>{
    const blob=new Blob([JSON.stringify(pack(),null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='anim.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
  };
  document.getElementById('btn-upload').onclick = ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=e=>{const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{unpack(JSON.parse(ev.target.result));}catch(err){toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');} }; r.readAsText(f);};
    inp.click();
  };
  document.getElementById('btn-png').onclick = ()=>{
    const cols=frames.length; const cv=document.createElement('canvas'); cv.width=GRID*cols; cv.height=GRID; const ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=false;
    for(let i=0;i<cols;i++){ const fr=frames[i]; for(let p=0;p<LEN;p++){ const ci=fr[p]; if(!ci) continue; ctx.fillStyle=palette[ci]; ctx.fillRect(i*GRID+(p%GRID), ((p/GRID)|0), 1,1); }}
    const a=document.createElement('a'); a.href=cv.toDataURL(); a.download='anim.png'; a.click();
  };
  document.getElementById('btn-gif').onclick = async()=>{
    if(!window.GIF){
      await new Promise((res,rej)=>{
        const sc=document.createElement('script');
        sc.src='https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.js';
        sc.onload=res; sc.onerror=rej; document.head.appendChild(sc);
      });
    }
    const gif = new GIF({workers:2, quality:1, workerScript:'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js'});
    frames.forEach(fr=>{
      const cv=document.createElement('canvas'); cv.width=GRID; cv.height=GRID; const ctx=cv.getContext('2d'); ctx.imageSmoothingEnabled=false;
      for(let p=0;p<LEN;p++){ const ci=fr[p]; if(!ci) continue; ctx.fillStyle=palette[ci]; ctx.fillRect(p%GRID,(p/GRID)|0,1,1); }
      gif.addFrame(cv,{delay:1000/Math.max(1,fps)});
    });
    gif.on('finished', blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='anim.gif'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
    });
    gif.render();
  };
  loadLS();
  document.getElementById('btn-record').onclick = async()=>{
    if(!('MediaRecorder' in window)) { toast('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
    const seconds = Math.max(1, Math.ceil(frames.length / Math.max(1,fps)));
    const stream = canvas.captureStream(Math.max(1,fps)); const rec = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
    const chunks=[]; rec.ondataavailable=e=>e.data && chunks.push(e.data); const p=new Promise(r=>rec.onstop=r);
    let i=0; const int = setInterval(()=>{ cur = i++ % frames.length; render(); }, 1000/Math.max(1,fps) );
    rec.start(); setTimeout(()=>{ rec.stop(); clearInterval(int); }, seconds*1000);
    await p; const blob = new Blob(chunks, {type:'video/webm'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='pixel.webm'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  };
  const btns = document.querySelectorAll('.tab');
  const tabEdit = document.getElementById('tab-edit');
  const tabIO   = document.getElementById('tab-io');
  btns.forEach(b=> b.addEventListener('click', ()=>{
    btns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const name=b.dataset.tab; const showEdit = name==='edit';
    tabEdit.style.display = showEdit?'grid':'none';
    tabIO.style.display   = showEdit?'none':'block';
    fitSquare();
  }));
})();
</script>
<script type="module" src="src/serve-warning.js"></script>
<script type="module" src="src/pixel-widgets.js"></script>
<script type="module" src="src/i18n.js"></script>
</body>
</html>
