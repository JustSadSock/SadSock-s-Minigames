<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>SadSock Pixel Animator ‚Äî 16√ó16</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6e9d6;
    --bg-dots:#f2d9c0;
    --panel:#f3e4c9;
    --panel-deep:#e7cda2;
    --amber:#eaa651;
    --ink:#3a2f27;
    --muted:#937c66;
    --accent:#4aa9ff;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{margin:0;color:var(--ink);background:
      radial-gradient(circle at 15% 10%, #fff8e9 0%, #fff8e900 40%),
      radial-gradient(circle at 80% 0%, #fff8e9 0%, #fff8e900 35%),
      repeating-linear-gradient(0deg, var(--bg) 0 2px, var(--bg-dots) 2px 4px);
    font-family:'Press Start 2P',ui-monospace,monospace;display:flex;align-items:stretch;justify-content:center;padding:16px;box-sizing:border-box;height:100svh;overflow:hidden;}
  .cabinet{position:relative;width:min(1100px,100%);height:100%;border-radius:28px;padding:18px;box-sizing:border-box;background:linear-gradient(180deg,#ffd7a8,#f3b86d 6%,#ffd7a8 12%) padding-box;border:8px solid var(--amber);box-shadow:inset 0 0 0 2px #f9d8a1,0 10px 30px rgba(0,0,0,.12);display:flex;flex-direction:column;gap:10px;}
  .cabinet::after{content:"";position:absolute;inset:10px;border-radius:20px;background:linear-gradient(180deg,#ffe9c9,#f7d9ac 18%,#ffe9c9 100%);box-shadow:inset 0 0 0 2px #eecb98,inset 0 6px 18px rgba(0,0,0,.08);z-index:0;}
  .scan{position:absolute;inset:20px;border-radius:16px;overflow:hidden;z-index:1;}
  .scan::after{content:"";position:absolute;inset:0;pointer-events:none;background:linear-gradient(#0000 96%,rgba(0,0,0,.08) 100%);background-size:100% 3px;mix-blend-mode:multiply;opacity:.35;}
  .content{position:relative;z-index:2;flex:1;display:flex;flex-direction:column;gap:10px;}
  .tabs{display:flex;gap:10px;align-self:center}
  .tabBtn{background:linear-gradient(180deg,#fff4df,#f6e2bd);border:2px solid #e9c38e;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 3px 0 #d4b07f;transform:translateY(0);transition:transform .05s;}
  .tabBtn:active{transform:translateY(2px);box-shadow:0 1px 0 #d4b07f}
  .tabBtn.active{outline:2px solid var(--amber);}
  .workspace{flex:1;min-height:0;display:grid;grid-template-columns:1fr;grid-template-rows:1fr auto;gap:10px;overflow:hidden}
  @media (min-width:940px){.workspace{grid-template-columns:minmax(320px,1fr) 420px;grid-template-rows:1fr}}
  @media (max-width:600px){.workspace{grid-template-rows:1fr 220px;}}
  .panel{position:relative;background:var(--panel);border-radius:14px;padding:10px;box-shadow:0 6px 0 var(--panel-deep),inset 0 0 0 2px #edd0a5;min-height:0}
  .panel::after{content:"";position:absolute;right:8px;bottom:8px;width:18px;height:18px;border:4px solid #e3c595;border-top:0;border-left:0;border-radius:0 0 14px 0;opacity:.8}
  .screen{position:relative;display:grid;place-items:center;height:100%;overflow:hidden;}
  .canvasWrap{position:relative;width:100%;height:100%;display:grid;place-items:center;overflow:hidden;}
  .square{position:relative;max-width:100%;max-height:100%;}
  #paint{display:block;image-rendering:pixelated;background:#000;border-radius:8px;box-shadow:0 6px 16px #0002;width:100%;height:100%}
  .tools{display:flex;flex-direction:column;gap:10px;min-height:0;overflow:auto}
  .tools .panel{overflow:auto}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .chip{width:26px;height:26px;border:2px solid #543;border-radius:6px;box-shadow:inset 0 0 0 2px #fff6;cursor:pointer}
  .chip[selected]{outline:3px solid var(--accent)}
  .tool{background:linear-gradient(180deg,#fff4df,#f6e2bd);border:2px solid #e9c38e;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer;box-shadow:0 3px 0 #d4b07f}
  .tool:active{transform:translateY(2px);box-shadow:0 1px 0 #d4b07f}
  .tool[data-danger]{border-color:#e09a9a;box-shadow:0 3px 0 #c27979}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}
  label{font-size:12px;color:var(--muted);font-weight:700}
  input[type="range"]{width:160px}
  .timeline{display:flex;gap:8px;overflow:auto;padding:6px}
  .thumb{position:relative;min-width:56px;min-height:56px;background:#f7e5c6;border:2px solid #e9c38e;border-radius:10px;display:grid;place-items:center;cursor:pointer}
  .thumb canvas{image-rendering:pixelated;border-radius:6px}
  .thumb.active{outline:3px solid var(--amber)}
  .thumb .num{position:absolute;left:6px;top:4px;background:#0004;color:#fff;font-size:10px;padding:2px 4px;border-radius:6px}
  textarea{width:100%;min-height:220px;resize:vertical;background:#121212;color:#c1f2b0;border:2px solid #28342a;border-radius:12px;padding:10px;font-family:ui-monospace,monospace}
  .codeBox{background:#0c0f12;color:#cbe4ff;border:2px solid #2a405b;border-radius:12px;padding:10px;overflow:auto;max-height:220px}
</style>
</head>
<body>
  <div class="cabinet">
    <div class="scan"></div>
    <div class="content">
      <div class="tabs">
        <button class="tabBtn active" data-tab="edit">üé® –†–µ–¥–∞–∫—Ç–æ—Ä</button>
        <button class="tabBtn" data-tab="io">üì§ –ò–º–ø–æ—Ä—Ç ¬∑ –≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>
      <section id="tab-edit" class="workspace">
        <div class="panel screen">
          <div class="canvasWrap">
            <div id="square" class="square">
              <canvas id="paint" width="16" height="16"></canvas>
            </div>
          </div>
        </div>
        <div class="tools">
          <div class="panel">
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <button class="tool" id="tool-pen">–ö–∏—Å—Ç—å</button>
                <button class="tool" id="tool-erase">–õ–∞—Å—Ç–∏–∫</button>
                <button class="tool" id="tool-pick">–ü–∏–ø–µ—Ç–∫–∞</button>
              </div>
              <div class="row">
                <label>FPS</label>
                <input id="fps" type="range" min="1" max="24" value="6" />
                <button class="tool" id="play">‚ñ∂Ô∏è</button>
                <button class="tool" id="stop">‚èπ</button>
                <label class="row" style="gap:6px"><input id="onion" type="checkbox"/> Onion</label>
              </div>
            </div>
            <div class="toolbar" id="palette" style="margin-top:8px"></div>
            <div class="row" style="justify-content:space-between; margin-top:6px">
              <div class="row">
                <button class="tool" id="add-frame">‚ûï –ö–∞–¥—Ä</button>
                <button class="tool" id="dup-frame">‚ßâ –î—É–±–ª–∏–∫–∞—Ç</button>
                <button class="tool" id="del-frame" data-danger>üóë –£–¥–∞–ª–∏—Ç—å</button>
                <button class="tool" id="undo">‚Ü∂ Undo</button>
              </div>
              <div class="muted">–¢–µ–∫—É—â–∏–π: <span id="curIndex">1</span>/<span id="totalFrames">1</span></div>
            </div>
          </div>
          <div class="panel">
            <strong style="display:block;margin-bottom:6px">–ö–∞–¥—Ä—ã</strong>
            <div id="timeline" class="timeline"></div>
          </div>
        </div>
      </section>
      <section id="tab-io" class="panel" style="display:none">
        <div class="row" style="justify-content:space-between; flex-wrap:wrap">
          <div class="row" style="gap:8px">
            <button class="tool" id="btn-export">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button class="tool" id="btn-import">–ò–º–ø–æ—Ä—Ç JSON</button>
            <button class="tool" id="btn-copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="row">
            <button class="tool" id="btn-gencode">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –∫–æ–¥</button>
            <button class="tool" id="btn-record" title="–≠–∫—Å–ø–æ—Ä—Ç WebM (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)">üé¨ WebM</button>
          </div>
        </div>
        <textarea id="io"></textarea>
        <p class="muted">–§–æ—Ä–º–∞—Ç: { grid:16, palette:["#RRGGBB",...], frames:[ [–∏–Ω–¥–µ–∫—Å—ã –ø–∞–ª–∏—Ç—Ä—ã –¥–ª–∏–Ω–æ–π 256], ... ], fps:n }</p>
        <div id="embed" class="codeBox" style="display:none"></div>
      </section>
    </div>
  </div>
<script>
(function(){
  const GRID = 16;
  const LEN = GRID*GRID;
  let fps = 6;
  let palette = [null, "#000000", "#ffffff", "#4aa9ff", "#ff4757", "#ffd166", "#06d6a0", "#8338ec", "#ff99c8", "#8d99ae", "#2b2d42"];
  let currentColorIndex = 3;
  let frames = [new Uint16Array(LEN)];
  let cur = 0;
  const history = []; let hpos = -1;
  function pushHistory(){
    const copy = new Uint16Array(frames[cur]);
    history.splice(hpos+1); history.push({i:cur, data:copy}); hpos = history.length-1;
  }
  function undo(){ if(hpos>=0){ frames[cur].set(history[hpos].data); hpos--; render(); refreshThumb(cur); }}
  const square = document.getElementById('square');
  const canvas = document.getElementById('paint');
  const ctx = canvas.getContext('2d', {alpha:true});
  ctx.imageSmoothingEnabled = false;
  function fitSquare(){
    const parent = square.parentElement;
    const w = parent.clientWidth; const h = parent.clientHeight;
    const s = Math.min(w,h);
    square.style.width = s + 'px';
    square.style.height = s + 'px';
  }
  const ro = new ResizeObserver(fitSquare);
  ro.observe(document.querySelector('.canvasWrap'));
  window.addEventListener('orientationchange', ()=> setTimeout(fitSquare, 100));
  fitSquare();
  let tool = 'pen';
  document.getElementById('tool-pen').onclick = ()=> tool='pen';
  document.getElementById('tool-erase').onclick = ()=> tool='erase';
  document.getElementById('tool-pick').onclick = ()=> tool='pick';
  document.getElementById('undo').onclick = undo;
  let drawing=false;
  canvas.addEventListener('pointerdown', e=>{ drawing=true; canvas.setPointerCapture(e.pointerId); drawAtEvent(e); pushHistory(); });
  canvas.addEventListener('pointermove', e=>{ if(drawing) drawAtEvent(e); });
  window.addEventListener('pointerup', ()=> drawing=false);
  function posFromEvent(e){
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / (rect.width / GRID));
    const y = Math.floor((e.clientY - rect.top)  / (rect.height/ GRID));
    return {x:Math.max(0,Math.min(GRID-1,x)), y:Math.max(0,Math.min(GRID-1,y))};
  }
  function drawAtEvent(e){
    const {x,y} = posFromEvent(e);
    const idx = y*GRID + x;
    if(tool==='pick'){
      const ci = frames[cur][idx];
      if(ci!==undefined){ selectColor(ci); }
      return;
    }
    const val = (tool==='erase')? 0 : currentColorIndex;
    if(frames[cur][idx] !== val){
      frames[cur][idx] = val; renderCell(x,y,val); refreshThumb(cur);
    }
  }
  function drawChecker(ctx){
    const s1 = '#111', s2 = '#1a1a1a';
    for(let y=0;y<GRID;y++){
      for(let x=0;x<GRID;x++){
        const on = ((x>>1) + (y>>1)) & 1;
        ctx.fillStyle = on ? s2 : s1;
        ctx.fillRect(x, y, 1, 1);
      }
    }
  }
  function render(){
    ctx.clearRect(0,0,GRID,GRID);
    drawChecker(ctx);
    if(document.getElementById('onion').checked && cur>0){
      const prev = frames[cur-1];
      for(let i=0;i<LEN;i++){
        const cindex = prev[i]; if(!cindex) continue;
        const hex = palette[cindex]; if(!hex) continue;
        const x=i%GRID, y=(i/GRID)|0; ctx.fillStyle=hex+"66"; ctx.fillRect(x,y,1,1);
      }
    }
    const f = frames[cur];
    for(let i=0;i<LEN;i++){
      const cindex = f[i]; if(!cindex) continue; const hex = palette[cindex]; if(!hex) continue;
      const x=i%GRID, y=(i/GRID)|0; ctx.fillStyle=hex; ctx.fillRect(x,y,1,1);
    }
  }
  function renderCell(x,y,ci){
    const on = ((x>>1) + (y>>1)) & 1; ctx.fillStyle = on? '#1a1a1a':'#111'; ctx.fillRect(x,y,1,1);
    if(document.getElementById('onion').checked && cur>0){
      const prev = frames[cur-1][y*GRID+x]; if(prev){ ctx.fillStyle = (palette[prev]||'#000')+"66"; ctx.fillRect(x,y,1,1); }
    }
    if(ci){ ctx.fillStyle = palette[ci] || '#000'; ctx.fillRect(x,y,1,1); }
  }
  render();
  const pal = document.getElementById('palette');
  function rebuildPalette(){ pal.innerHTML='';
    palette.forEach((hex,i)=>{
      if(i===0) return;
      const d = document.createElement('div'); d.className='chip'; d.style.background=hex; d.title=hex;
      if(i===currentColorIndex) d.setAttribute('selected','');
      d.addEventListener('click', ()=> selectColor(i)); pal.appendChild(d);
    });
    const tr = document.createElement('div'); tr.className='chip'; tr.style.background = 'repeating-conic-gradient(#0000 0 25%, #fff6 0 50%) 0/10px 10px, #999';
    tr.title='–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π (–ª–∞—Å—Ç–∏–∫)'; tr.addEventListener('click', ()=>{tool='erase'}); pal.appendChild(tr);
  }
  function selectColor(i){ currentColorIndex=i; tool='pen'; rebuildPalette(); }
  rebuildPalette();
  const curIndexEl = document.getElementById('curIndex');
  const totalEl    = document.getElementById('totalFrames');
  const timeline   = document.getElementById('timeline');
  function updateCounters(){ curIndexEl.textContent = (cur+1); totalEl.textContent = frames.length; }
  function makeThumb(i){
    const el = document.createElement('div'); el.className='thumb'; el.dataset.i=i;
    const num = document.createElement('div'); num.className='num'; num.textContent = i+1; el.appendChild(num);
    const c = document.createElement('canvas'); c.width=GRID; c.height=GRID; c.style.width='44px'; c.style.height='44px'; c.style.imageRendering='pixelated'; el.appendChild(c);
    el.addEventListener('click', ()=>{ cur = i; updateCounters(); highlightThumb(); render(); });
    return el;
  }
  function refreshThumb(i){
    const el = timeline.querySelector(`.thumb[data-i="${i}"] canvas`);
    if(!el) return; const tctx = el.getContext('2d');
    tctx.clearRect(0,0,GRID,GRID); const f = frames[i];
    for(let p=0;p<LEN;p++){ const ci=f[p]; if(!ci) continue; tctx.fillStyle = palette[ci]; tctx.fillRect(p%GRID,(p/GRID)|0,1,1); }
  }
  function rebuildTimeline(){ timeline.innerHTML='';
    frames.forEach((_,i)=>{ const t = makeThumb(i); timeline.appendChild(t); refreshThumb(i); });
    highlightThumb(); updateCounters();
  }
  function highlightThumb(){ timeline.querySelectorAll('.thumb').forEach((t,idx)=>{ t.classList.toggle('active', idx===cur); }); }
  rebuildTimeline();
  document.getElementById('add-frame').onclick = ()=>{ frames.push(new Uint16Array(LEN)); cur = frames.length-1; pushHistory(); rebuildTimeline(); render(); };
  document.getElementById('dup-frame').onclick = ()=>{ const dup = new Uint16Array(frames[cur]); frames.splice(cur+1,0,dup); cur++; rebuildTimeline(); render(); };
  document.getElementById('del-frame').onclick = ()=>{ if(frames.length>1){ frames.splice(cur,1); cur=Math.max(0,cur-1); rebuildTimeline(); render(); } };
  let timer=null; const fpsInput = document.getElementById('fps');
  fpsInput.addEventListener('input', ()=>{ fps = parseInt(fpsInput.value,10); if(timer){ clearInterval(timer); timer=null; play(); } }); fps = parseInt(fpsInput.value,10);
  document.getElementById('play').onclick = play;
  document.getElementById('stop').onclick = ()=>{ clearInterval(timer); timer=null; };
  function play(){ if(timer) return; let i=cur; timer = setInterval(()=>{ cur = i++ % frames.length; highlightThumb(); updateCounters(); render(); }, 1000/Math.max(1,fps) ); }
  const io = document.getElementById('io');
  function pack(){ return { grid:GRID, fps, palette, frames: frames.map(f=> Array.from(f)) }; }
  function unpack(obj){
    if(!obj || obj.grid!==GRID || !Array.isArray(obj.frames)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
    palette = obj.palette || palette; fps = obj.fps || fps; document.getElementById('fps').value=fps;
    frames = obj.frames.map(arr=> Uint16Array.from(arr)); cur=0; rebuildPalette(); rebuildTimeline(); render();
  }
  document.getElementById('btn-export').onclick = ()=>{ io.value = JSON.stringify(pack()); io.scrollTop=0; };
  document.getElementById('btn-import').onclick = ()=>{ try{ const data = JSON.parse(io.value); unpack(data); }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message); } };
  document.getElementById('btn-copy').onclick   = async()=>{ try{ await navigator.clipboard.writeText(io.value); }catch{} };
  document.getElementById('btn-gencode').onclick = ()=>{
    const data = JSON.stringify(pack());
    const code = `<!-- –í–°–¢–ê–í–¨ –≠–¢–û–¢ –ë–õ–û–ö –í –°–ê–ô–¢ -->\n<canvas id=anim width=16 height=16 style="image-rendering:pixelated;width:100%;max-width:256px;aspect-ratio:1/1;background:#000;border-radius:8px"></canvas>\n<script>\nconst DATA = ${data};\n(function(){\n  const c=document.getElementById('anim'); const x=c.getContext('2d'); const G=DATA.grid; const L=G*G; let i=0; x.imageSmoothingEnabled=false;\n  function draw(frame){ x.clearRect(0,0,G,G); for(let p=0;p<L;p++){ const ci=frame[p]; if(!ci) continue; x.fillStyle=DATA.palette[ci]; x.fillRect(p%G,(p/G)|0,1,1); } }\n  setInterval(()=>{ const fr = Uint16Array.from(DATA.frames[i++%DATA.frames.length]); draw(fr); }, 1000/(DATA.fps||6));\n})();\n<\/script>`;
    const box = document.getElementById('embed'); box.style.display='block'; box.textContent = code;
  };
  document.getElementById('btn-record').onclick = async()=>{
    if(!('MediaRecorder' in window)) { alert('MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
    const seconds = Math.max(1, Math.ceil(frames.length / Math.max(1,fps)));
    const stream = canvas.captureStream(Math.max(1,fps)); const rec = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
    const chunks=[]; rec.ondataavailable=e=>e.data && chunks.push(e.data); const p=new Promise(r=>rec.onstop=r);
    let i=0; const int = setInterval(()=>{ cur = i++ % frames.length; render(); }, 1000/Math.max(1,fps) );
    rec.start(); setTimeout(()=>{ rec.stop(); clearInterval(int); }, seconds*1000);
    await p; const blob = new Blob(chunks, {type:'video/webm'}); const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='pixel.webm'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
  };
  const btns = document.querySelectorAll('.tabBtn');
  const tabEdit = document.getElementById('tab-edit');
  const tabIO   = document.getElementById('tab-io');
  btns.forEach(b=> b.addEventListener('click', ()=>{
    btns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const name=b.dataset.tab; const showEdit = name==='edit';
    tabEdit.style.display = showEdit?'grid':'none';
    tabIO.style.display   = showEdit?'none':'block';
    fitSquare();
  }));
})();
</script>
</body>
</html>
